<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a1a">
    <title>KDRSYSTEMS - Business Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap');
        
        * {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        h1, h2, h3, h4, h5, h6, .logo-text {
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: -0.02em;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1810 50%, #1a1a1a 100%);
            min-height: 100vh;
        }
        
        .gradient-orange {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 50%, #ff8c42 100%);
        }
        
        .gradient-orange-soft {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(247, 147, 30, 0.15) 50%, rgba(255, 140, 66, 0.1) 100%);
        }
        
        .gradient-dark {
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 107, 53, 0.2);
        }
        
        .card {
            background: linear-gradient(135deg, rgba(42, 42, 42, 0.9) 0%, rgba(31, 31, 31, 0.9) 100%);
            border-radius: 16px;
            border: 1px solid rgba(255, 107, 53, 0.3);
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .nav-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #999;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            position: relative;
        }
        
        .nav-btn:hover {
            color: #ff8c42;
        }
        
        .nav-btn.active {
            color: #ff8c42;
            border-bottom-color: #ff8c42;
        }
        
        .nav-btn-side {
            padding: 14px 16px;
            background: transparent;
            border: none;
            color: #999;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            border-radius: 8px;
            display: flex;
            align-items: center;
        }
        
        .nav-btn-side:hover {
            color: #ff8c42;
            background: rgba(255, 107, 53, 0.1);
        }
        
        .nav-btn-side.active {
            color: #ff8c42;
            border-left-color: #ff8c42;
            background: rgba(255, 107, 53, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ff8c42;
            padding: 12px 24px;
            border-radius: 12px;
            border: 1px solid rgba(255, 107, 53, 0.3);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 107, 53, 0.2);
            border-color: #ff8c42;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
        }
        
        input, select, textarea {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 10px;
            padding: 12px;
            width: 100%;
            color: #fff;
            transition: all 0.3s;
        }
        
        input::placeholder, textarea::placeholder {
            color: #666;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #ff8c42;
            background: rgba(255, 107, 53, 0.1);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
            border-radius: 20px;
            border: 1px solid rgba(255, 107, 53, 0.3);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .modal-content-small {
            max-width: 500px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.2) 0%, rgba(247, 147, 30, 0.25) 100%);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 107, 53, 0.3);
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pending { background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid #fbbf24; }
        .status-sent { background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid #3b82f6; }
        .status-approved { background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid #22c55e; }
        .status-paid { background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid #22c55e; }
        .status-unpaid { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; }
        .status-scheduled { background: rgba(168, 85, 247, 0.2); color: #a855f7; border: 1px solid #a855f7; }
        .status-completed { background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid #22c55e; }
        
        .calc-section {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.05) 0%, rgba(247, 147, 30, 0.08) 100%);
            border: 1px solid rgba(255, 107, 53, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .calc-section h3 {
            color: #ff8c42;
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .signature-canvas {
            border: 2px dashed rgba(255, 107, 53, 0.3);
            border-radius: 12px;
            cursor: crosshair;
            background: rgba(255, 255, 255, 0.05);
        }
        
        table {
            color: #ddd;
        }
        
        table thead {
            background: rgba(255, 107, 53, 0.1);
            border-bottom: 2px solid rgba(255, 107, 53, 0.3);
        }
        
        table tbody tr {
            border-bottom: 1px solid rgba(255, 107, 53, 0.1);
            transition: all 0.2s;
        }
        
        table tbody tr:hover {
            background: rgba(255, 107, 53, 0.05);
        }
        
        .summary-box {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.15) 0%, rgba(247, 147, 30, 0.2) 100%);
            border: 2px solid rgba(255, 107, 53, 0.4);
            border-radius: 16px;
            padding: 24px;
        }
        
        .summary-box h4 {
            color: #ff8c42;
            font-weight: 700;
            font-size: 20px;
            margin-bottom: 16px;
        }
        
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #ff6b35 0%, #f7931e 100%);
            border-radius: 5px;
        }
        
        label {
            color: #bbb;
            font-size: 14px;
            font-weight: 500;
        }
        
        h1, h2, h3, h4 {
            color: #fff;
        }
        
        .text-orange {
            color: #ff8c42;
        }
        
        .logo-text {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            font-size: 28px;
            letter-spacing: 1px;
        }
        
        #logoDropZone {
            transition: all 0.3s;
        }
        
        #logoDropZone:hover {
            background: rgba(255, 107, 53, 0.05);
            border-color: #ff8c42;
        }
        
        #logoDropZone.drag-over {
            background: rgba(255, 107, 53, 0.1);
            border-color: #ff8c42;
            border-width: 3px;
        }
        
        .calendar-day {
            min-height: 100px;
            border: 1px solid rgba(255, 107, 53, 0.2);
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background: rgba(255, 107, 53, 0.05);
            border-color: #ff8c42;
        }
        
        .calendar-day.today {
            background: rgba(255, 107, 53, 0.1);
            border-color: #ff8c42;
            border-width: 2px;
        }
        
        .calendar-event {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            margin-top: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .calendar-event:hover {
            transform: scale(1.05);
        }
        
        .notification-badge {
            background: #ef4444;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 8px;
        }
        
        .notification-item {
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .notification-item:hover {
            background: rgba(255, 107, 53, 0.15);
            transform: translateX(4px);
        }
        
        .notification-item.unread {
            border-left: 4px solid #ff8c42;
        }

        /* Hamburger Button */
        .hamburger-btn {
            display: none;
            background: none;
            border: none;
            color: #ff8c42;
            font-size: 28px;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
        }

        /* Sidebar overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 39;
        }
        .sidebar-overlay.show { display: block; }

        /* Table wrapper for horizontal scroll on mobile */
        .table-wrap {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* ---- TABLET (<= 1024px) ---- */
        @media (max-width: 1024px) {
            .hamburger-btn { display: block; }

            nav#sidebarNav {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 45;
            }
            nav#sidebarNav.open {
                transform: translateX(0);
            }

            main.main-content {
                margin-left: 0 !important;
                padding: 20px !important;
            }

            .modal-content {
                max-width: 95vw;
                max-height: 95vh;
                margin: 10px;
            }

            #notificationsPanel {
                right: 10px;
                left: 10px;
                width: auto;
            }

            .stat-card { padding: 16px; }
            .stat-card .text-4xl { font-size: 1.75rem; }
        }

        /* ---- PHONE (<= 640px) ---- */
        @media (max-width: 640px) {
            header .max-w-7xl { padding-left: 12px; padding-right: 12px; }

            .logo-text { font-size: 20px !important; }

            #headerBusinessSubtitle { display: none; }

            .btn-secondary { padding: 8px 12px; font-size: 13px; }

            main.main-content {
                padding: 14px !important;
            }

            h2.text-3xl { font-size: 1.4rem; }

            .card { padding: 16px; border-radius: 12px; }

            .grid.lg\\:grid-cols-4 { grid-template-columns: repeat(2, 1fr); }

            .modal { padding: 8px; }
            .modal-content {
                border-radius: 14px;
                max-height: 92vh;
            }

            input, select, textarea {
                padding: 14px 12px;
                font-size: 16px; /* prevents iOS zoom on focus */
            }

            .nav-btn-side {
                padding: 16px;
                font-size: 15px;
            }

            .calendar-day { min-height: 60px; padding: 4px; }
            .calendar-event { font-size: 9px; padding: 2px 4px; }

            .stat-card .text-4xl { font-size: 1.35rem; }
            .stat-card p.text-sm { font-size: 11px; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center px-4" style="background: linear-gradient(135deg, #1a1a1a 0%, #2d1810 50%, #1a1a1a 100%);">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="logo-text text-4xl mb-2">KDRSYSTEMS</h1>
                <p class="text-gray-400">Business Management System</p>
            </div>
            <div class="card">
                <!-- Login Tab / Signup Tab -->
                <div class="flex mb-6 border-b border-orange-500 border-opacity-20">
                    <button id="loginTabBtn" class="flex-1 py-3 text-center font-semibold text-orange-400 border-b-2 border-orange-500 transition-all" onclick="showLoginTab('login')" style="color: #ff8c42; border-bottom-color: #ff8c42;">Log In</button>
                    <button id="signupTabBtn" class="flex-1 py-3 text-center font-semibold text-gray-500 border-b-2 border-transparent transition-all" onclick="showLoginTab('signup')">Sign Up</button>
                </div>

                <!-- Login Form -->
                <div id="loginForm" class="space-y-4">
                    <div>
                        <label class="block mb-2 text-sm">Email</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" autocomplete="username">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" autocomplete="current-password" onkeydown="if(event.key==='Enter') doLogin()">
                    </div>
                    <p id="loginError" class="text-red-400 text-sm hidden"></p>
                    <button class="btn-primary w-full text-lg" onclick="doLogin()">Log In</button>
                </div>

                <!-- Signup Form -->
                <div id="signupForm" class="space-y-4 hidden">
                    <div>
                        <label class="block mb-2 text-sm">Business Name</label>
                        <input type="text" id="signupBusiness" placeholder="Your business name">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm">Email</label>
                        <input type="email" id="signupEmail" placeholder="Enter your email" autocomplete="username">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm">Password</label>
                        <input type="password" id="signupPassword" placeholder="Create a password" autocomplete="new-password">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm">Confirm Password</label>
                        <input type="password" id="signupConfirm" placeholder="Confirm your password" autocomplete="new-password" onkeydown="if(event.key==='Enter') doSignup()">
                    </div>
                    <p id="signupError" class="text-red-400 text-sm hidden"></p>
                    <p id="signupSuccess" class="text-green-400 text-sm hidden"></p>
                    <button class="btn-primary w-full text-lg" onclick="doSignup()">Create Account</button>
                </div>
            </div>
            <p class="text-center text-gray-600 text-xs mt-6">Your data is securely stored and syncs across all your devices.</p>
        </div>
    </div>

    <!-- Public Signature Page (for customers signing from email) -->
    <div id="signaturePage" class="min-h-screen px-4 py-8" style="display:none; background: linear-gradient(135deg, #1a1a1a 0%, #2d1810 50%, #1a1a1a 100%);">
        <div class="max-w-2xl mx-auto">
            <div id="signPageContent">
                <div class="text-center py-12">
                    <div class="text-4xl mb-4">‚è≥</div>
                    <p class="text-gray-400">Loading estimate...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until login) -->
    <div id="mainApp" class="min-h-screen" style="display: none;">
        <!-- Header -->
        <header class="glass sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <button class="hamburger-btn" onclick="toggleSidebar()" aria-label="Menu">‚ò∞</button>
                        <h1 class="logo-text">KDRSYSTEMS</h1>
                        <p class="text-sm text-gray-400 ml-4" id="headerBusinessSubtitle">Business Management System</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="saveIndicator" class="text-xs hidden sm:inline"></span>
                        <button class="btn-secondary relative" onclick="toggleNotifications()">
                            üîî <span class="hidden sm:inline">Notifications</span>
                            <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
                        </button>
                        <button class="btn-secondary" onclick="doLogout()" title="Log Out">
                            üö™ <span class="hidden sm:inline">Log Out</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Notifications Panel -->
        <div id="notificationsPanel" class="hidden fixed right-4 top-20 w-96 max-h-[500px] overflow-y-auto bg-gray-900 border border-orange-500 border-opacity-30 rounded-xl p-4 z-50 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-orange">Notifications</h3>
                <button onclick="clearAllNotifications()" class="text-xs text-gray-400 hover:text-orange">Clear All</button>
            </div>
            <div id="notificationsList"></div>
        </div>

        <!-- Navigation -->
        <div class="flex">
            <!-- Sidebar overlay for mobile -->
            <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

            <!-- Left Sidebar Navigation -->
            <nav id="sidebarNav" class="glass border-r border-orange-500 border-opacity-20 fixed left-0 top-[73px] bottom-0 w-64 overflow-y-auto z-40">
                <div class="p-4 space-y-2">
                    <button class="nav-btn-side active w-full text-left" onclick="switchTab('dashboard', this)">
                        <span class="text-xl mr-3">üìä</span> Dashboard
                    </button>
                    <button class="nav-btn-side w-full text-left" onclick="switchTab('customers', this)">
                        <span class="text-xl mr-3">üë•</span> Customers
                    </button>
                    <button class="nav-btn-side w-full text-left" onclick="switchTab('schedule', this)">
                        <span class="text-xl mr-3">üìÖ</span> Schedule
                    </button>
                    <button class="nav-btn-side w-full text-left" onclick="switchTab('estimates', this)">
                        <span class="text-xl mr-3">üìÑ</span> Estimates & Invoices
                    </button>
                    <button class="nav-btn-side w-full text-left" onclick="switchTab('materials', this)">
                        <span class="text-xl mr-3">üì¶</span> Materials
                    </button>
                    <button class="nav-btn-side w-full text-left" onclick="switchTab('templates', this)">
                        <span class="text-xl mr-3">üìã</span> Templates
                    </button>
                    <button class="nav-btn-side w-full text-left" onclick="switchTab('calculator', this)">
                        <span class="text-xl mr-3">üßÆ</span> Rate Calculator
                    </button>
                    <button class="nav-btn-side w-full text-left" onclick="switchTab('settings', this)">
                        <span class="text-xl mr-3">‚öôÔ∏è</span> Settings
                    </button>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main class="main-content flex-1 ml-64 p-8">
            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active">
                <h2 class="text-3xl font-bold mb-8">Dashboard Overview</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card">
                        <p class="text-sm text-gray-400 mb-2">Total Customers</p>
                        <p class="text-4xl font-bold text-white" id="dashCustomers">0</p>
                    </div>
                    <div class="stat-card">
                        <p class="text-sm text-gray-400 mb-2">Active Estimates</p>
                        <p class="text-4xl font-bold text-orange" id="dashEstimates">0</p>
                    </div>
                    <div class="stat-card">
                        <p class="text-sm text-gray-400 mb-2">Unpaid Invoices</p>
                        <p class="text-4xl font-bold text-red-400" id="dashUnpaid">$0</p>
                    </div>
                    <div class="stat-card">
                        <p class="text-sm text-gray-400 mb-2">Total Revenue</p>
                        <p class="text-4xl font-bold text-green-400" id="dashRevenue">$0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="font-semibold text-xl mb-4">Recent Activity</h3>
                        <div id="recentActivity" class="space-y-3"></div>
                    </div>
                    <div class="card">
                        <h3 class="font-semibold text-xl mb-4">Monthly Summary</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">Revenue Target</span>
                                <span class="font-bold text-lg text-orange" id="dashRevenueTarget">$0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">Monthly Expenses</span>
                                <span class="font-bold text-lg" id="dashExpenses">$0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-400">Team Costs</span>
                                <span class="font-bold text-lg" id="dashTeamCosts">$0</span>
                            </div>
                            <div class="flex justify-between items-center pt-3 border-t border-orange-500 border-opacity-20">
                                <span class="text-gray-400">Target Profit</span>
                                <span class="font-bold text-xl text-green-400" id="dashProfit">$0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customers -->
            <div id="customers" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Customers</h2>
                    <button class="btn-primary" onclick="openModal('customerModal')">Add Customer</button>
                </div>
                
                <div class="card">
                    <div class="table-wrap">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th class="text-left py-3 px-4">Name</th>
                                <th class="text-left py-3 px-4">Email</th>
                                <th class="text-left py-3 px-4">Phone</th>
                                <th class="text-left py-3 px-4">Address</th>
                                <th class="text-right py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersTable"></tbody>
                    </table>
                    </div>
                </div>
            </div>

            <!-- Schedule Calendar -->
            <div id="schedule" class="tab-content">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-3">
                    <h2 class="text-3xl font-bold">Schedule</h2>
                    <div class="flex flex-wrap gap-3">
                        <button class="btn-secondary" onclick="previousMonth()">‚Üê Prev</button>
                        <button class="btn-secondary" onclick="nextMonth()">Next ‚Üí</button>
                        <button class="btn-primary" onclick="openModal('scheduleModal')">Schedule Job</button>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <h3 class="text-xl font-bold mb-2" id="calendarMonth">Month Year</h3>
                </div>
                
                <div class="card">
                    <div class="grid grid-cols-7 gap-2 mb-2">
                        <div class="text-center font-semibold text-orange py-2">Sun</div>
                        <div class="text-center font-semibold text-orange py-2">Mon</div>
                        <div class="text-center font-semibold text-orange py-2">Tue</div>
                        <div class="text-center font-semibold text-orange py-2">Wed</div>
                        <div class="text-center font-semibold text-orange py-2">Thu</div>
                        <div class="text-center font-semibold text-orange py-2">Fri</div>
                        <div class="text-center font-semibold text-orange py-2">Sat</div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
                </div>
            </div>

            <!-- Estimates & Invoices -->
            <div id="estimates" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Estimates & Invoices</h2>
                    <button class="btn-primary" onclick="openModal('estimateModal')">Create Estimate</button>
                </div>
                
                <div id="documentsList" class="space-y-4"></div>
            </div>

            <!-- Materials -->
            <div id="materials" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-bold mb-2">Materials Library</h2>
                        <p class="text-gray-400 text-sm">Organize and manage all your materials by category</p>
                    </div>
                    <button class="btn-primary" onclick="openModal('materialModal')">Add Material</button>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2 text-gray-400">Filter by Category</label>
                    <select id="categoryFilter" onchange="filterMaterialsByCategory()" class="max-w-xs">
                        <option value="all">All Categories</option>
                    </select>
                </div>
                
                <div id="materialsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- Templates -->
            <div id="templates" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-bold mb-2">Material Templates</h2>
                        <p class="text-gray-400 text-sm">Create reusable material packages for common jobs</p>
                    </div>
                    <button class="btn-primary" onclick="openModal('templateModal')">Create Template</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="templatesList"></div>
                    
                    <div class="card">
                        <h3 class="text-xl font-bold mb-4 text-orange">Terms & Conditions Templates</h3>
                        <div id="termsList" class="space-y-3 mb-4"></div>
                        <button class="btn-secondary w-full" onclick="openModal('termsModal')">Add Terms Template</button>
                    </div>
                </div>
            </div>

            <!-- Rate Calculator -->
            <div id="calculator" class="tab-content">
                <h2 class="text-3xl font-bold mb-8">Rate Calculator</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Team Members Section -->
                    <div class="card">
                        <div class="calc-section">
                            <h3>Team Members</h3>
                            <p class="text-xs text-gray-400 mb-3">What you PAY your team</p>
                            <div id="teamMembersList" class="space-y-3 mb-4"></div>
                            <button class="btn-secondary w-full" onclick="addTeamMember()">Add Team Member</button>
                            <div class="mt-4 pt-4 border-t border-orange-500 border-opacity-20">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Total Team Cost/Month:</span>
                                    <span class="font-bold text-orange" id="totalTeamCost">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monthly Expenses Section -->
                    <div class="card">
                        <div class="calc-section">
                            <h3>Monthly Expenses</h3>
                            <p class="text-xs text-gray-400 mb-3">Rent, tools, insurance, etc.</p>
                            <div id="expensesList" class="space-y-3 mb-4"></div>
                            <button class="btn-secondary w-full" onclick="addExpense()">Add Expense</button>
                            <div class="mt-4 pt-4 border-t border-orange-500 border-opacity-20">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Total Monthly Expenses:</span>
                                    <span class="font-bold text-orange" id="totalExpenses">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profit Margin Section -->
                    <div class="card">
                        <div class="calc-section">
                            <h3>Profit & Hours</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block mb-2">Desired Monthly Profit ($)</label>
                                    <input type="number" id="desiredProfit" placeholder="5000" step="0.01" 
                                        onchange="calculateAll()">
                                </div>
                                <div>
                                    <label class="block mb-2">OR Profit Margin (%)</label>
                                    <input type="number" id="profitMargin" placeholder="20" step="0.1" 
                                        onchange="calculateFromMargin()">
                                    <p class="text-xs text-gray-500 mt-1">% of total costs (team + expenses)</p>
                                </div>
                                <div>
                                    <label class="block mb-2">Working Hours/Month</label>
                                    <input type="number" id="workingHours" value="160" step="1" 
                                        onchange="calculateAll()">
                                    <p class="text-xs text-gray-500 mt-1">Default: 160 (40 hrs/week)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Rate Breakdown -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="summary-box">
                        <h4>Your Billing Rate Breakdown</h4>
                        <p class="text-xs text-gray-400 mb-3">Add all costs together to get your minimum hourly rate</p>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Team Labor Cost/Hour:</span>
                                <span class="font-bold text-xl" id="teamCostPerHour">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Monthly Expenses/Hour:</span>
                                <span class="font-bold text-xl" id="overheadPerHour">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Profit/Hour:</span>
                                <span class="font-bold text-xl" id="profitPerHour">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t border-orange-500 border-opacity-30">
                                <span class="text-gray-300">Profit Margin:</span>
                                <span class="font-bold text-xl text-green-400" id="marginDisplay">0%</span>
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t-2 border-orange-500">
                                <span class="text-white font-semibold">YOUR BILLING RATE/HOUR:</span>
                                <span class="font-bold text-3xl text-orange" id="minimumRate">$0.00</span>
                            </div>
                            <p class="text-xs text-gray-400 text-center pt-2">Charge clients this rate to cover all costs + profit</p>
                        </div>
                    </div>
                    
                    <div class="summary-box">
                        <h4>Monthly Summary</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Team Labor Costs:</span>
                                <span class="font-bold text-xl" id="summaryTeam">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Monthly Expenses:</span>
                                <span class="font-bold text-xl" id="summaryExpenses">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t border-orange-500 border-opacity-30">
                                <span class="text-gray-300">Total Monthly Costs:</span>
                                <span class="font-bold text-xl" id="summaryTotalCosts">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Target Profit:</span>
                                <span class="font-bold text-xl text-green-400" id="summaryProfit">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t-2 border-orange-500">
                                <span class="text-white font-semibold">Revenue Needed/Month:</span>
                                <span class="font-bold text-3xl text-orange" id="requiredRevenue">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="btn-primary w-full" onclick="saveCalculator()">Save Calculator Settings</button>
            </div>

            <!-- Settings -->
            <div id="settings" class="tab-content">
                <h2 class="text-3xl font-bold mb-6">Business Settings</h2>
                
                <div class="card max-w-3xl">
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block mb-2">Business Name</label>
                                <input type="text" id="settingsBusinessName" placeholder="Your Business Name">
                            </div>
                            <div>
                                <label class="block mb-2">Email</label>
                                <input type="email" id="settingsEmail" placeholder="business@example.com">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block mb-2">Phone</label>
                                <input type="tel" id="settingsPhone" placeholder="(555) 123-4567">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block mb-2">Business Logo</label>
                            <div id="logoDropZone" class="border-2 border-dashed border-orange-500 border-opacity-30 rounded-lg p-8 text-center cursor-pointer hover:border-opacity-60 transition-all"
                                ondragover="handleDragOver(event)" 
                                ondragleave="handleDragLeave(event)"
                                ondrop="handleLogoDrop(event)"
                                onclick="document.getElementById('logoInput').click()">
                                <div id="logoPreview" class="mb-4"></div>
                                <p class="text-gray-400 mb-2">Drag and drop your logo here or click to browse</p>
                                <p class="text-xs text-gray-500">PNG, JPG, SVG up to 2MB</p>
                                <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogoFile(event)">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block mb-2">Address</label>
                            <textarea id="settingsAddress" rows="2" placeholder="123 Main St..."></textarea>
                        </div>
                        
                        <div class="pt-4 border-t border-orange-500 border-opacity-20">
                            <h4 class="text-lg font-semibold mb-4 text-orange">Social Media Links</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block mb-2">Instagram</label>
                                    <input type="text" id="settingsInstagram" placeholder="@yourbusiness">
                                </div>
                                <div>
                                    <label class="block mb-2">Facebook</label>
                                    <input type="text" id="settingsFacebook" placeholder="facebook.com/yourbusiness">
                                </div>
                                <div>
                                    <label class="block mb-2">TikTok</label>
                                    <input type="text" id="settingsTiktok" placeholder="@yourbusiness">
                                </div>
                                <div>
                                    <label class="block mb-2">Google Business</label>
                                    <input type="text" id="settingsGoogle" placeholder="g.page/yourbusiness">
                                </div>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-orange-500 border-opacity-20">
                            <h4 class="text-lg font-semibold mb-4 text-orange">Invoice Reminder Settings</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block mb-2">Send Invoice Reminders</label>
                                    <select id="invoiceReminderEnabled" class="w-full">
                                        <option value="true">Yes, send automatic reminders</option>
                                        <option value="false">No, I'll send reminders manually</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block mb-2">First Reminder (days after sending)</label>
                                    <select id="reminder1Days" class="w-full">
                                        <option value="3">3 days</option>
                                        <option value="7" selected>7 days</option>
                                        <option value="14">14 days</option>
                                        <option value="30">30 days</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block mb-2">Second Reminder (days after first reminder)</label>
                                    <select id="reminder2Days" class="w-full">
                                        <option value="3">3 days</option>
                                        <option value="7" selected>7 days</option>
                                        <option value="14">14 days</option>
                                        <option value="30">30 days</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block mb-2">Final Reminder (days after second reminder)</label>
                                    <select id="reminder3Days" class="w-full">
                                        <option value="3">3 days</option>
                                        <option value="7">7 days</option>
                                        <option value="14" selected>14 days</option>
                                        <option value="30">30 days</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-orange-500 border-opacity-20">
                            <h4 class="text-lg font-semibold mb-4 text-orange">Job Notification Settings</h4>
                            <div>
                                <label class="block mb-2">Notify Me Before Job (hours)</label>
                                <select id="jobNotificationHours" class="w-full">
                                    <option value="24" selected>24 hours before</option>
                                    <option value="48">48 hours before</option>
                                    <option value="72">72 hours before (3 days)</option>
                                    <option value="168">1 week before</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-orange-500 border-opacity-20">
                            <h4 class="text-lg font-semibold mb-4 text-orange">üìß Email Settings (EmailJS)</h4>
                            <p class="text-xs text-gray-400 mb-4">Set up EmailJS to send invoices and estimates directly to customer emails. Free for up to 200 emails/month. <a href="https://www.emailjs.com" target="_blank" class="text-orange underline">Get your keys at emailjs.com</a></p>
                            <div class="space-y-4">
                                <div>
                                    <label class="block mb-2">EmailJS Public Key</label>
                                    <input type="text" id="settingsEmailjsPublicKey" placeholder="Paste your Public Key here">
                                </div>
                                <div>
                                    <label class="block mb-2">EmailJS Service ID</label>
                                    <input type="text" id="settingsEmailjsServiceId" placeholder="e.g. service_abc123">
                                </div>
                                <div>
                                    <label class="block mb-2">EmailJS Template ID</label>
                                    <input type="text" id="settingsEmailjsTemplateId" placeholder="e.g. template_xyz789">
                                </div>
                                <div class="p-3 bg-black bg-opacity-30 rounded-lg">
                                    <p class="text-xs text-gray-400 font-semibold mb-2">Quick Setup Guide:</p>
                                    <p class="text-xs text-gray-500">1. Go to <a href="https://www.emailjs.com" target="_blank" class="text-orange underline">emailjs.com</a> ‚Üí Sign up (free)</p>
                                    <p class="text-xs text-gray-500">2. Add an Email Service (Gmail, Outlook, etc.)</p>
                                    <p class="text-xs text-gray-500">3. Create a Template with these variables: <span class="text-orange">{{to_email}}</span>, <span class="text-orange">{{to_name}}</span>, <span class="text-orange">{{from_name}}</span>, <span class="text-orange">{{subject}}</span>, <span class="text-orange">{{message}}</span></p>
                                    <p class="text-xs text-gray-500">4. Copy your Public Key, Service ID, and Template ID above</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-orange-500 border-opacity-20">
                            <h4 class="text-lg font-semibold mb-4 text-orange">üìÅ Data Backup & Restore</h4>
                            <p class="text-xs text-gray-400 mb-4">Keep your data safe by downloading a backup. You can restore it on any device.</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <button class="btn-primary w-full" onclick="downloadBackup()">‚¨áÔ∏è Download Backup</button>
                                <div>
                                    <label class="btn-secondary w-full block text-center cursor-pointer">
                                        ‚¨ÜÔ∏è Restore from Backup
                                        <input type="file" accept=".json" class="hidden" onchange="restoreBackup(event)">
                                    </label>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-3">Backup includes all customers, estimates, invoices, materials, settings, and more.</p>
                        </div>
                        
                        <button class="btn-primary w-full" onclick="saveSettings()">Save Settings</button>
                    </div>
                </div>
            </div>
            </main>
        </div>

    <!-- Modals -->
    <div id="customerModal" class="modal">
        <div class="modal-content modal-content-small">
            <div class="p-6 border-b border-orange-500 border-opacity-20">
                <h3 class="text-2xl font-bold">Add Customer</h3>
            </div>
            <div class="p-6">
                <form id="customerForm" class="space-y-4">
                    <input type="text" id="custName" placeholder="Customer Name" required>
                    <input type="email" id="custEmail" placeholder="Email">
                    <input type="tel" id="custPhone" placeholder="Phone">
                    <textarea id="custAddress" rows="2" placeholder="Address"></textarea>
                    <div class="flex gap-3">
                        <button type="submit" class="btn-primary flex-1">Add Customer</button>
                        <button type="button" class="btn-secondary flex-1" onclick="closeModal('customerModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="scheduleModal" class="modal">
        <div class="modal-content modal-content-small">
            <div class="p-6 border-b border-orange-500 border-opacity-20">
                <h3 class="text-2xl font-bold">Schedule Job</h3>
            </div>
            <div class="p-6">
                <form id="scheduleForm" class="space-y-4">
                    <div>
                        <label class="block mb-2">Customer</label>
                        <select id="schedCustomer" required></select>
                    </div>
                    <div>
                        <label class="block mb-2">Job Title</label>
                        <input type="text" id="schedTitle" placeholder="e.g., Kitchen Renovation" required>
                    </div>
                    <div>
                        <label class="block mb-2">Date</label>
                        <input type="date" id="schedDate" required>
                    </div>
                    <div>
                        <label class="block mb-2">Time</label>
                        <input type="time" id="schedTime" value="09:00" required>
                    </div>
                    <div>
                        <label class="block mb-2">Duration (hours)</label>
                        <input type="number" id="schedDuration" value="4" step="0.5" min="0.5" required>
                    </div>
                    <div>
                        <label class="block mb-2">Notes</label>
                        <textarea id="schedNotes" rows="3" placeholder="Job details, location notes, etc."></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button type="submit" class="btn-primary flex-1">Schedule Job</button>
                        <button type="button" class="btn-secondary flex-1" onclick="closeModal('scheduleModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="estimateModal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-orange-500 border-opacity-20">
                <h3 class="text-2xl font-bold">Create Estimate</h3>
            </div>
            <div class="p-6">
                <form id="estimateForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <select id="estCustomer" required>
                            <option value="">Select Customer</option>
                        </select>
                        <input type="date" id="estDate" required>
                    </div>
                    
                    <div>
                        <label class="block mb-2">Select Material Template (Optional)</label>
                        <select id="estTemplate" onchange="applyTemplate()">
                            <option value="">No Template</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block mb-2">Select Terms & Conditions (Optional)</label>
                        <select id="estTerms">
                            <option value="">No Terms</option>
                        </select>
                    </div>
                    
                    <div class="border border-orange-500 border-opacity-20 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold text-orange">Line Items</h4>
                            <button type="button" class="btn-secondary text-sm" onclick="addEstimateLine()">Add Line</button>
                        </div>
                        <div class="text-xs text-gray-400 mb-2 grid grid-cols-12 gap-2 px-1">
                            <span class="col-span-5">Description</span>
                            <span class="col-span-2">Qty</span>
                            <span class="col-span-2">Rate</span>
                            <span class="col-span-2">Markup %</span>
                            <span class="col-span-1"></span>
                        </div>
                        <div id="estimateLines" class="space-y-2"></div>
                    </div>
                    
                    <div class="summary-box">
                        <h4>Estimate Summary</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Subtotal:</span>
                                <span class="font-semibold" id="estSubtotal">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Labor Cost:</span>
                                <span class="font-semibold" id="estLaborCost">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Profit:</span>
                                <span class="font-semibold text-green-400" id="estProfit">$0.00</span>
                            </div>
                            <div class="flex justify-between text-lg pt-2 border-t border-orange-500">
                                <span>Total:</span>
                                <span class="font-bold" id="estTotal">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Profit Margin:</span>
                                <span class="font-semibold" id="estMargin">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <textarea id="estNotes" rows="3" placeholder="Notes / Terms"></textarea>
                    
                    <div class="flex gap-3">
                        <button type="submit" class="btn-primary flex-1">Create Estimate</button>
                        <button type="button" class="btn-secondary flex-1" onclick="closeModal('estimateModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="materialModal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-orange-500 border-opacity-20">
                <h3 class="text-2xl font-bold">Add Material</h3>
            </div>
            <div class="p-6">
                <form id="materialForm" class="space-y-4">
                    <div>
                        <label class="block mb-2">Material Name</label>
                        <input type="text" id="matName" placeholder="e.g., 2x4 Lumber, Concrete Mix, Paint" required>
                    </div>
                    <div>
                        <label class="block mb-2">Category</label>
                        <div class="flex gap-2">
                            <select id="matCategory" class="flex-1">
                                <option value="">Select or create category</option>
                            </select>
                            <button type="button" class="btn-secondary" onclick="toggleNewCategory()">New</button>
                        </div>
                        <input type="text" id="matNewCategory" placeholder="New category name" class="mt-2 hidden">
                    </div>
                    <div>
                        <label class="block mb-2">Description</label>
                        <textarea id="matDescription" rows="2" placeholder="Optional details about this material"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2">Cost</label>
                            <input type="number" id="matCost" placeholder="0.00" step="0.01" required>
                        </div>
                        <div>
                            <label class="block mb-2">Unit</label>
                            <input type="text" id="matUnit" placeholder="sqft, lbs, each, etc">
                        </div>
                    </div>
                    <div>
                        <label class="block mb-2">Default Markup %</label>
                        <input type="number" id="matMarkup" placeholder="20" step="0.01">
                    </div>
                    <div class="flex gap-3">
                        <button type="submit" class="btn-primary flex-1">Add Material</button>
                        <button type="button" class="btn-secondary flex-1" onclick="closeModal('materialModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-orange-500 border-opacity-20">
                <h3 class="text-2xl font-bold">Create Material Template</h3>
            </div>
            <div class="p-6">
                <form id="templateForm" class="space-y-4">
                    <input type="text" id="tempName" placeholder="Template Name" required>
                    <textarea id="tempDescription" rows="2" placeholder="Description"></textarea>
                    
                    <div>
                        <label class="block mb-2">Select Materials</label>
                        <div id="templateMaterialsList" class="border border-orange-500 border-opacity-20 rounded-lg p-4 max-h-60 overflow-y-auto space-y-2">
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button type="submit" class="btn-primary flex-1">Create Template</button>
                        <button type="button" class="btn-secondary flex-1" onclick="closeModal('templateModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="invoiceViewModal" class="modal">
        <div class="modal-content">
            <div id="invoiceViewContent"></div>
        </div>
    </div>

    <div id="docEditModal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-orange-500 border-opacity-20">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold" id="editModalTitle">Edit Document</h3>
                    <button class="text-gray-400 hover:text-white text-2xl" onclick="closeModal('docEditModal')">&times;</button>
                </div>
            </div>
            <div class="p-6">
                <input type="hidden" id="editDocId">
                <input type="hidden" id="editDocType">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block mb-2">Customer</label>
                        <input type="text" id="editDocCustomer" disabled class="opacity-60">
                    </div>
                    <div>
                        <label class="block mb-2">Date</label>
                        <input type="date" id="editDocDate">
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <label class="font-semibold text-orange">Line Items</label>
                        <button class="btn-secondary text-sm" onclick="addEditLine()">+ Add Line</button>
                    </div>
                    <div id="editLines" class="space-y-3"></div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center p-4 rounded-lg" style="background:rgba(255,107,53,0.15);border:2px solid rgba(255,107,53,0.4);">
                        <span class="text-white font-semibold text-lg">Total:</span>
                        <span class="text-3xl font-bold text-orange" id="editDocTotal">$0.00</span>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block mb-2">Notes</label>
                    <textarea id="editDocNotes" rows="3" placeholder="Notes..."></textarea>
                </div>

                <div class="mb-4">
                    <label class="block mb-2">Terms & Conditions</label>
                    <textarea id="editDocTerms" rows="4" placeholder="Terms..."></textarea>
                </div>

                <div class="flex gap-3">
                    <button class="btn-primary flex-1" onclick="saveDocEdit()">üíæ Save Changes</button>
                    <button class="btn-secondary flex-1" onclick="closeModal('docEditModal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="signatureModal" class="modal">
        <div class="modal-content modal-content-small">
            <div class="p-6 border-b border-orange-500 border-opacity-20">
                <h3 class="text-2xl font-bold">‚úçÔ∏è Approve Estimate</h3>
                <p class="text-sm text-gray-400 mt-1">Sign below to approve this estimate</p>
            </div>
            <div class="p-6">
                <input type="hidden" id="signEstimateId">
                <div class="mb-4">
                    <label class="block mb-2">Your Name</label>
                    <input type="text" id="signName" placeholder="Type your full name">
                </div>
                <div class="mb-4">
                    <label class="block mb-2">Signature (draw below)</label>
                    <canvas id="signatureCanvas" class="signature-canvas w-full" width="450" height="180" style="touch-action:none;"></canvas>
                </div>
                <div class="flex gap-3 mb-4">
                    <button class="btn-secondary flex-1" onclick="clearSignatureCanvas()">Clear Signature</button>
                </div>
                <div class="flex gap-3">
                    <button class="btn-primary flex-1" onclick="submitSignature()">‚úÖ Approve & Sign</button>
                    <button class="btn-secondary flex-1" onclick="closeModal('signatureModal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="termsModal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-orange-500 border-opacity-20">
                <h3 class="text-2xl font-bold">Create Terms & Conditions Template</h3>
            </div>
            <div class="p-6">
                <form id="termsForm" class="space-y-4">
                    <div>
                        <label class="block mb-2">Template Name</label>
                        <input type="text" id="termsName" placeholder="e.g., Standard Terms, Net 30, etc." required>
                    </div>
                    <div>
                        <label class="block mb-2">Terms & Conditions</label>
                        <textarea id="termsContent" rows="10" placeholder="Enter your terms and conditions here..." required></textarea>
                        <p class="text-xs text-gray-500 mt-1">These will appear at the bottom of estimates and invoices</p>
                    </div>
                    <div class="flex gap-3">
                        <button type="submit" class="btn-primary flex-1">Create Template</button>
                        <button type="button" class="btn-secondary flex-1" onclick="closeModal('termsModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div> <!-- end mainApp -->

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <script>
        // =============================================
        // üî• FIREBASE CONFIG ‚Äî PASTE YOUR CONFIG HERE
        // =============================================
        // Follow the setup guide to get these values from your Firebase Console
       const firebaseConfig = {
  apiKey: "AIzaSyDs8Hl8_NBzBEvJ-oou6Gi7nrq8ALy8dmY",
  authDomain: "kdrsystems-c269c.firebaseapp.com",
  projectId: "kdrsystems-c269c",
  storageBucket: "kdrsystems-c269c.firebasestorage.app",
  messagingSenderId: "436571279407",
  appId: "1:436571279407:web:eeb521438b8ff87cd6b6da"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Track save debounce
        let saveTimeout = null;
        let currentUserId = null;

        // =============================================
        // AUTH SYSTEM (Firebase)
        // =============================================
        function showLoginTab(tab) {
            var loginForm = document.getElementById('loginForm');
            var signupForm = document.getElementById('signupForm');
            var loginTabBtn = document.getElementById('loginTabBtn');
            var signupTabBtn = document.getElementById('signupTabBtn');
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('signupError').classList.add('hidden');
            document.getElementById('signupSuccess').classList.add('hidden');
            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                loginTabBtn.style.color = '#ff8c42';
                loginTabBtn.style.borderBottomColor = '#ff8c42';
                signupTabBtn.style.color = '#6b7280';
                signupTabBtn.style.borderBottomColor = 'transparent';
            } else {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                signupTabBtn.style.color = '#ff8c42';
                signupTabBtn.style.borderBottomColor = '#ff8c42';
                loginTabBtn.style.color = '#6b7280';
                loginTabBtn.style.borderBottomColor = 'transparent';
            }
        }

        function doSignup() {
            var business = document.getElementById('signupBusiness').value.trim();
            var email = document.getElementById('signupEmail').value.trim();
            var password = document.getElementById('signupPassword').value;
            var confirmPw = document.getElementById('signupConfirm').value;
            var errEl = document.getElementById('signupError');
            var successEl = document.getElementById('signupSuccess');
            errEl.classList.add('hidden');
            successEl.classList.add('hidden');

            if (!email || !password) {
                errEl.textContent = 'Email and password are required.';
                errEl.classList.remove('hidden');
                return;
            }
            if (password.length < 6) {
                errEl.textContent = 'Password must be at least 6 characters.';
                errEl.classList.remove('hidden');
                return;
            }
            if (password !== confirmPw) {
                errEl.textContent = 'Passwords do not match.';
                errEl.classList.remove('hidden');
                return;
            }

            // Disable button
            var btn = document.querySelector('#signupForm .btn-primary');
            btn.textContent = 'Creating Account...';
            btn.disabled = true;

            auth.createUserWithEmailAndPassword(email, password)
                .then(function(userCredential) {
                    // Save initial business name to Firestore
                    var uid = userCredential.user.uid;
                    var initialData = JSON.parse(JSON.stringify(appData));
                    initialData.settings.businessName = business;
                    initialData.settings.email = email;
                    return db.collection('users').doc(uid).set({ appData: initialData });
                })
                .then(function() {
                    successEl.textContent = 'Account created! Logging you in...';
                    successEl.classList.remove('hidden');
                    document.getElementById('signupBusiness').value = '';
                    document.getElementById('signupEmail').value = '';
                    document.getElementById('signupPassword').value = '';
                    document.getElementById('signupConfirm').value = '';
                })
                .catch(function(error) {
                    var msg = error.message;
                    if (error.code === 'auth/email-already-in-use') msg = 'An account with that email already exists.';
                    if (error.code === 'auth/invalid-email') msg = 'Please enter a valid email address.';
                    if (error.code === 'auth/weak-password') msg = 'Password must be at least 6 characters.';
                    errEl.textContent = msg;
                    errEl.classList.remove('hidden');
                })
                .finally(function() {
                    btn.textContent = 'Create Account';
                    btn.disabled = false;
                });
        }

        function doLogin() {
            var email = document.getElementById('loginEmail').value.trim();
            var password = document.getElementById('loginPassword').value;
            var errEl = document.getElementById('loginError');
            errEl.classList.add('hidden');

            if (!email || !password) {
                errEl.textContent = 'Please enter your email and password.';
                errEl.classList.remove('hidden');
                return;
            }

            // Disable button
            var btn = document.querySelector('#loginForm .btn-primary');
            btn.textContent = 'Logging in...';
            btn.disabled = true;

            auth.signInWithEmailAndPassword(email, password)
                .then(function() {
                    // onAuthStateChanged will handle the rest
                })
                .catch(function(error) {
                    var msg = error.message;
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        msg = 'Invalid email or password.';
                    }
                    if (error.code === 'auth/invalid-email') msg = 'Please enter a valid email address.';
                    if (error.code === 'auth/too-many-requests') msg = 'Too many attempts. Please wait a moment and try again.';
                    errEl.textContent = msg;
                    errEl.classList.remove('hidden');
                })
                .finally(function() {
                    btn.textContent = 'Log In';
                    btn.disabled = false;
                });
        }

        function doLogout() {
            if (!confirm('Are you sure you want to log out?')) return;
            // Force save before logout
            if (currentUserId) {
                try { localStorage.setItem('kdrsystems_cache_' + currentUserId, JSON.stringify(appData)); } catch(e) {}
                db.collection('users').doc(currentUserId).set({ appData: appData }, { merge: true }).catch(function(){});
            }
            auth.signOut().then(function() {
                currentUserId = null;
                dataLoaded = false;
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
            });
        }

        function enterApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadData();
        }

        function initApp() {
            renderTeamMembers();
            renderExpenses();
            calculateAll();
            updateDashboard();
            addEstimateLine();
            renderCalendar();
            checkNotifications();
            setInterval(checkNotifications, 5 * 60 * 1000);
            updateCalculatorViewButtons();
        }

        // Global Data
        let appData = {
            customers: [],
            estimates: [],
            invoices: [],
            materials: [],
            templates: [],
            terms: [],
            teamMembers: [],
            expenses: [],
            scheduledJobs: [],
            notifications: [],
            calculator: {
                desiredProfit: 0,
                workingHours: 160,
                hourlyRate: 0,
                view: 'monthly'
            },
            settings: {
                businessName: '',
                email: '',
                phone: '',
                address: '',
                logo: '',
                instagram: '',
                facebook: '',
                tiktok: '',
                google: '',
                emailjsPublicKey: '',
                emailjsServiceId: '',
                emailjsTemplateId: '',
                invoiceReminderEnabled: true,
                reminder1Days: 7,
                reminder2Days: 7,
                reminder3Days: 14,
                jobNotificationHours: 24
            }
        };

        let currentCalendarDate = new Date();

        // =============================================
        // CHECK FOR PUBLIC SIGNATURE PAGE FIRST
        // =============================================
        var urlParams = new URLSearchParams(window.location.search);
        var signToken = urlParams.get('sign');

        if (signToken) {
            // Customer is here to sign ‚Äî hide everything, show signature page
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('signaturePage').style.display = 'block';
            loadPublicEstimate(signToken);
        } else {
            // Normal app flow
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    currentUserId = user.uid;
                    enterApp();
                } else {
                    currentUserId = null;
                    document.getElementById('mainApp').style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'flex';
                }
            });
        }

        // Load public estimate for customer to sign
        function loadPublicEstimate(token) {
            db.collection('public_estimates').doc(token).get()
                .then(function(doc) {
                    if (!doc.exists) {
                        document.getElementById('signPageContent').innerHTML = '<div class="card text-center py-12"><div class="text-4xl mb-4">‚ùå</div><p class="text-gray-400">Estimate not found or link has expired.</p></div>';
                        return;
                    }
                    var est = doc.data();
                    renderPublicSignaturePage(est, token);
                })
                .catch(function(err) {
                    console.error('Signature page error:', err);
                    document.getElementById('signPageContent').innerHTML = '<div class="card text-center py-12"><div class="text-4xl mb-4">‚ö†Ô∏è</div><p class="text-gray-400">Unable to load estimate.</p><p class="text-sm text-gray-500 mt-2">This may mean the link has expired or Firebase security rules need to be updated.</p><p class="text-xs text-gray-600 mt-4">Error: ' + (err.code || err.message || 'Unknown') + '</p></div>';
                });
        }

        function renderPublicSignaturePage(est, token) {
            var itemsHtml = est.lineItems.map(function(item) {
                return '<tr>' +
                    '<td style="padding:12px;border-bottom:1px solid rgba(255,107,53,0.1);color:#ddd;">' + item.description + '</td>' +
                    '<td style="padding:12px;text-align:center;border-bottom:1px solid rgba(255,107,53,0.1);color:#ddd;">' + item.quantity + '</td>' +
                    '<td style="padding:12px;text-align:right;border-bottom:1px solid rgba(255,107,53,0.1);color:#ddd;">$' + item.rate + '</td>' +
                    '<td style="padding:12px;text-align:right;border-bottom:1px solid rgba(255,107,53,0.1);font-weight:bold;color:#ff8c42;">$' + item.amount + '</td>' +
                '</tr>';
            }).join('');

            var logoHtml = est.businessLogo ? '<img src="' + est.businessLogo + '" alt="Logo" style="max-height:70px;border-radius:8px;margin-bottom:10px;">' : '';

            var alreadySigned = est.signature ? true : false;

            var signSection = '';
            if (alreadySigned) {
                signSection = '<div class="mt-6 p-6 rounded-lg" style="background:rgba(34,197,94,0.1);border:2px solid rgba(34,197,94,0.3);text-align:center;">' +
                    '<p class="text-2xl mb-2">‚úÖ</p>' +
                    '<p class="text-green-400 font-bold text-lg">This estimate has been approved</p>' +
                    '<p class="text-sm text-gray-400 mt-2">Signed by ' + (est.signedBy || 'Customer') + ' on ' + (est.signedDate || 'N/A') + '</p>' +
                '</div>';
            } else {
                signSection = '<div class="mt-6 p-6 rounded-lg" style="background:rgba(255,107,53,0.08);border:2px solid rgba(255,107,53,0.3);">' +
                    '<h3 class="text-xl font-bold text-orange mb-4">‚úçÔ∏è Sign to Approve</h3>' +
                    '<div class="mb-4">' +
                        '<label class="block mb-2 text-sm text-gray-400">Your Full Name</label>' +
                        '<input type="text" id="publicSignName" placeholder="Type your full name" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,107,53,0.3);border-radius:10px;padding:14px;width:100%;color:#fff;font-size:16px;">' +
                    '</div>' +
                    '<div class="mb-4">' +
                        '<label class="block mb-2 text-sm text-gray-400">Draw Your Signature Below</label>' +
                        '<canvas id="publicSigCanvas" class="signature-canvas w-full" width="500" height="180" style="touch-action:none;background:white;border-radius:12px;"></canvas>' +
                    '</div>' +
                    '<div class="flex gap-3 mb-4">' +
                        '<button class="btn-secondary flex-1" onclick="clearPublicSigCanvas()">Clear</button>' +
                    '</div>' +
                    '<button class="btn-primary w-full text-lg" onclick="submitPublicSignature(\'' + token + '\')">‚úÖ Approve Estimate</button>' +
                '</div>';
            }

            var html = '<div class="card">' +
                '<div class="text-center mb-6">' +
                    logoHtml +
                    '<h2 class="text-2xl font-bold text-orange">' + (est.businessName || 'KDRSYSTEMS') + '</h2>' +
                    (est.businessPhone ? '<p class="text-sm text-gray-400">' + est.businessPhone + '</p>' : '') +
                    (est.businessEmail ? '<p class="text-sm text-gray-400">' + est.businessEmail + '</p>' : '') +
                    (est.businessAddress ? '<p class="text-sm text-gray-400" style="white-space:pre-wrap;">' + est.businessAddress + '</p>' : '') +
                '</div>' +
                '<div class="text-center mb-6">' +
                    '<h3 class="text-xl font-bold">ESTIMATE #' + est.id.slice(-6) + '</h3>' +
                    '<p class="text-sm text-gray-500">Date: ' + est.date + '</p>' +
                '</div>' +
                '<div class="mb-4 p-4 rounded-lg" style="background:rgba(255,107,53,0.05);border:1px solid rgba(255,107,53,0.15);">' +
                    '<p class="text-xs text-gray-500 mb-1">PREPARED FOR:</p>' +
                    '<p class="font-semibold text-white text-lg">' + est.customerName + '</p>' +
                    (est.customerEmail ? '<p class="text-sm text-gray-400">' + est.customerEmail + '</p>' : '') +
                    (est.customerPhone ? '<p class="text-sm text-gray-400">' + est.customerPhone + '</p>' : '') +
                    (est.customerAddress ? '<p class="text-sm text-gray-400">' + est.customerAddress + '</p>' : '') +
                '</div>' +
                '<div class="table-wrap">' +
                '<table style="width:100%;border-collapse:collapse;margin:16px 0;">' +
                    '<tr style="background:rgba(255,107,53,0.1);">' +
                        '<th style="padding:12px;text-align:left;color:#ff8c42;font-size:13px;">Description</th>' +
                        '<th style="padding:12px;text-align:center;color:#ff8c42;font-size:13px;">Qty</th>' +
                        '<th style="padding:12px;text-align:right;color:#ff8c42;font-size:13px;">Rate</th>' +
                        '<th style="padding:12px;text-align:right;color:#ff8c42;font-size:13px;">Amount</th>' +
                    '</tr>' +
                    itemsHtml +
                '</table>' +
                '</div>' +
                '<div class="p-4 rounded-lg text-right" style="background:rgba(255,107,53,0.15);border:2px solid rgba(255,107,53,0.4);">' +
                    '<span class="text-gray-300 text-lg">Total: </span>' +
                    '<span class="text-3xl font-bold text-orange">$' + est.total + '</span>' +
                '</div>' +
                (est.notes ? '<div class="mt-4 p-3 rounded" style="background:rgba(0,0,0,0.2);"><p class="text-sm text-gray-400"><strong>Notes:</strong> ' + est.notes + '</p></div>' : '') +
                (est.terms ? '<div class="mt-4 p-3 rounded border border-orange-500 border-opacity-20"><p class="text-xs font-semibold text-orange mb-1">Terms & Conditions:</p><p class="text-xs text-gray-500 whitespace-pre-wrap">' + est.terms + '</p></div>' : '') +
                signSection +
            '</div>';

            document.getElementById('signPageContent').innerHTML = html;

            // Init canvas if not signed
            if (!alreadySigned) {
                setTimeout(function() {
                    var c = document.getElementById('publicSigCanvas');
                    if (!c) return;
                    var ctx = c.getContext('2d');
                    c.width = c.offsetWidth;
                    c.height = 180;
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, c.width, c.height);
                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 2.5;
                    ctx.lineCap = 'round';
                    var drawing = false;

                    function startD(x, y) { drawing = true; ctx.beginPath(); ctx.moveTo(x, y); }
                    function doD(x, y) { if (drawing) { ctx.lineTo(x, y); ctx.stroke(); } }

                    c.onmousedown = function(e) { startD(e.offsetX, e.offsetY); };
                    c.onmousemove = function(e) { doD(e.offsetX, e.offsetY); };
                    c.onmouseup = function() { drawing = false; };
                    c.onmouseleave = function() { drawing = false; };
                    c.ontouchstart = function(e) { e.preventDefault(); var r = c.getBoundingClientRect(); startD(e.touches[0].clientX - r.left, e.touches[0].clientY - r.top); };
                    c.ontouchmove = function(e) { e.preventDefault(); var r = c.getBoundingClientRect(); doD(e.touches[0].clientX - r.left, e.touches[0].clientY - r.top); };
                    c.ontouchend = function() { drawing = false; };
                }, 300);
            }
        }

        function clearPublicSigCanvas() {
            var c = document.getElementById('publicSigCanvas');
            if (c) { var ctx = c.getContext('2d'); ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, c.width, c.height); }
        }

        function submitPublicSignature(token) {
            var name = document.getElementById('publicSignName').value.trim();
            if (!name) { alert('Please type your full name.'); return; }

            var c = document.getElementById('publicSigCanvas');
            var sigData = c.toDataURL('image/png');
            var signedDate = new Date().toLocaleDateString();

            // Save signature to public estimate
            db.collection('public_estimates').doc(token).update({
                signature: sigData,
                signedBy: name,
                signedDate: signedDate,
                status: 'approved'
            })
            .then(function() {
                // Also update the owner's data
                return db.collection('public_estimates').doc(token).get();
            })
            .then(function(doc) {
                var est = doc.data();
                if (est.ownerId) {
                    return db.collection('users').doc(est.ownerId).get().then(function(userDoc) {
                        if (userDoc.exists) {
                            var userData = userDoc.data().appData;
                            var estimate = userData.estimates.find(function(e) { return e.id === est.id; });
                            if (estimate) {
                                estimate.signature = sigData;
                                estimate.signedBy = name;
                                estimate.signedDate = signedDate;
                                estimate.status = 'approved';
                                return db.collection('users').doc(est.ownerId).set({ appData: userData }, { merge: true });
                            }
                        }
                    });
                }
            })
            .then(function() {
                document.getElementById('signPageContent').innerHTML = '<div class="card text-center py-12">' +
                    '<div class="text-5xl mb-4">‚úÖ</div>' +
                    '<h2 class="text-2xl font-bold text-green-400 mb-2">Estimate Approved!</h2>' +
                    '<p class="text-gray-400">Thank you, ' + name + '. Your signature has been recorded.</p>' +
                    '<p class="text-sm text-gray-500 mt-2">You can close this page now.</p>' +
                '</div>';
            })
            .catch(function(err) {
                console.error(err);
                alert('Error saving signature. Please try again.');
            });
        }

        // =============================================
        // DATA: SAVE TO FIRESTORE (reliable)
        // =============================================
        var isSaving = false;
        var pendingSave = false;

        function saveData() {
            updateDashboard();
            
            // ALWAYS save to localStorage immediately (never lose data)
            try { localStorage.setItem('kdrsystems_cache_' + currentUserId, JSON.stringify(appData)); } catch(e) {}

            if (!currentUserId) return;
            showSaveStatus('saving');

            // If already saving, queue another save
            if (isSaving) { pendingSave = true; return; }
            
            isSaving = true;
            db.collection('users').doc(currentUserId).set({ appData: appData }, { merge: true })
                .then(function() { 
                    showSaveStatus('saved');
                    isSaving = false;
                    if (pendingSave) { pendingSave = false; saveData(); }
                })
                .catch(function(err) { 
                    console.error('Save error:', err); 
                    showSaveStatus('error');
                    isSaving = false;
                    // Retry once after 2 seconds
                    setTimeout(function() {
                        if (currentUserId) {
                            db.collection('users').doc(currentUserId).set({ appData: appData }, { merge: true })
                                .then(function() { showSaveStatus('saved'); })
                                .catch(function() { showSaveStatus('error'); });
                        }
                    }, 2000);
                });
        }

        // Force save before leaving page
        window.addEventListener('beforeunload', function() {
            if (currentUserId) {
                try { localStorage.setItem('kdrsystems_cache_' + currentUserId, JSON.stringify(appData)); } catch(e) {}
                // Sync save (best effort)
                var xhr = new XMLHttpRequest();
                // Can't do Firestore sync, but cache is saved
            }
        });

        function showSaveStatus(status) {
            var el = document.getElementById('saveIndicator');
            if (!el) return;
            if (status === 'saving') {
                el.textContent = '‚òÅÔ∏è Saving...';
                el.style.color = '#fbbf24';
                el.style.display = 'inline';
            } else if (status === 'saved') {
                el.textContent = '‚úÖ Saved';
                el.style.color = '#22c55e';
                el.style.display = 'inline';
                setTimeout(function() { el.style.display = 'none'; }, 3000);
            } else {
                el.textContent = '‚ö†Ô∏è Retrying...';
                el.style.color = '#ef4444';
                el.style.display = 'inline';
            }
        }

        // =============================================
        // DATA: LOAD FROM FIRESTORE (safe)
        // =============================================
        var dataLoaded = false;

        function loadData() {
            if (!currentUserId) return;

            // Step 1: Load from localStorage cache for instant display
            var hasCachedData = false;
            try {
                var cached = localStorage.getItem('kdrsystems_cache_' + currentUserId);
                if (cached) {
                    var parsed = JSON.parse(cached);
                    // Only use cache if it has real data
                    if (parsed && (parsed.customers.length > 0 || parsed.estimates.length > 0 || parsed.invoices.length > 0 || parsed.settings.businessName)) {
                        appData = parsed;
                        hasCachedData = true;
                    }
                }
            } catch(e) { console.error('Cache read error:', e); }

            if (hasCachedData) {
                populateSettings();
                if (!dataLoaded) { dataLoaded = true; initApp(); }
                else { renderAll(); }
            }

            // Step 2: Fetch from Firestore (authoritative)
            db.collection('users').doc(currentUserId).get()
                .then(function(doc) {
                    if (doc.exists && doc.data().appData) {
                        var serverData = doc.data().appData;
                        // Only use server data if it has content, OR if we have no cache
                        var serverHasData = serverData.customers.length > 0 || serverData.estimates.length > 0 || serverData.invoices.length > 0 || serverData.settings.businessName;
                        
                        if (serverHasData || !hasCachedData) {
                            // Merge: keep whichever has MORE data
                            if (serverHasData) {
                                appData = serverData;
                                try { localStorage.setItem('kdrsystems_cache_' + currentUserId, JSON.stringify(appData)); } catch(e) {}
                            }
                            populateSettings();
                            if (!dataLoaded) { dataLoaded = true; initApp(); }
                            else { renderAll(); }
                        }
                    } else if (!hasCachedData) {
                        // First time user, no cache ‚Äî use defaults
                        if (!dataLoaded) { dataLoaded = true; initApp(); }
                    }
                })
                .catch(function(err) {
                    console.error('Load error:', err);
                    if (!dataLoaded) { dataLoaded = true; initApp(); }
                });
        }

        function renderAll() {
            try {
                renderTeamMembers();
                renderExpenses();
                calculateAll();
                updateDashboard();
                renderCalendar();
                renderDocuments();
                checkNotifications();
            } catch(e) { console.error('Render error:', e); }
        }

        function switchTab(tabName, element) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            document.querySelectorAll('.nav-btn-side').forEach(b => b.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            
            if (tabName === 'customers') renderCustomers();
            if (tabName === 'estimates') renderDocuments();
            if (tabName === 'materials') renderMaterials();
            if (tabName === 'templates') renderTemplates();
            if (tabName === 'schedule') renderCalendar();

            // Close sidebar on mobile after selecting
            closeSidebar();
        }

        // Sidebar toggle for mobile
        function toggleSidebar() {
            var nav = document.getElementById('sidebarNav');
            var overlay = document.getElementById('sidebarOverlay');
            nav.classList.toggle('open');
            overlay.classList.toggle('show');
        }
        function closeSidebar() {
            var nav = document.getElementById('sidebarNav');
            var overlay = document.getElementById('sidebarOverlay');
            if (nav) nav.classList.remove('open');
            if (overlay) overlay.classList.remove('show');
        }

        // Data Backup & Restore
        function downloadBackup() {
            var data = JSON.stringify(appData, null, 2);
            if (!data) {
                alert('No data to backup.');
                return;
            }
            var blob = new Blob([data], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            var datestamp = new Date().toISOString().split('T')[0];
            a.download = 'kdrsystems-backup-' + datestamp + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Backup downloaded!');
        }

        function restoreBackup(event) {
            var file = event.target.files[0];
            if (!file) return;
            if (!confirm('This will replace ALL your current data with the backup. Are you sure?')) {
                event.target.value = '';
                return;
            }
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var parsed = JSON.parse(e.target.result);
                    // Basic validation
                    if (!parsed.settings || typeof parsed.customers === 'undefined') {
                        alert('Invalid backup file. Please select a valid KDRSYSTEMS backup.');
                        return;
                    }
                    appData = parsed;
                    saveData();
                    populateSettings();
                    renderTeamMembers();
                    renderExpenses();
                    calculateAll();
                    updateDashboard();
                    renderCalendar();
                    alert('Data restored successfully!');
                } catch(err) {
                    alert('Error reading backup file. Make sure it is a valid JSON backup.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            if (modalId === 'estimateModal') {
                populateCustomerSelect('estCustomer');
                populateTemplateSelect();
                populateTermsSelect();
            }
            if (modalId === 'scheduleModal') {
                populateCustomerSelect('schedCustomer');
            }
            if (modalId === 'materialModal') {
                populateCategoryDropdown();
            }
            if (modalId === 'templateModal') {
                populateTemplateMaterialsList();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Notifications
        function checkNotifications() {
            const now = new Date();
            const notificationHours = parseInt(appData.settings.jobNotificationHours) || 24;
            const notificationMs = notificationHours * 60 * 60 * 1000;
            
            appData.scheduledJobs.forEach(function(job) {
                const jobDate = new Date(job.date + ' ' + job.time);
                const timeUntilJob = jobDate - now;
                
                if (timeUntilJob > 0 && timeUntilJob <= notificationMs) {
                    const notificationId = 'job-' + job.id;
                    const exists = appData.notifications.find(function(n) { return n.id === notificationId; });
                    
                    if (!exists) {
                        const hoursUntil = Math.round(timeUntilJob / (60 * 60 * 1000));
                        appData.notifications.push({
                            id: notificationId,
                            type: 'job',
                            title: 'Upcoming Job',
                            message: job.title + ' with ' + job.customerName + ' in ' + hoursUntil + ' hours',
                            date: now.toISOString(),
                            read: false,
                            jobId: job.id
                        });
                    }
                }
            });
            
            if (appData.settings.invoiceReminderEnabled) {
                const reminder1Days = parseInt(appData.settings.reminder1Days) || 7;
                const reminder2Days = parseInt(appData.settings.reminder2Days) || 7;
                const reminder3Days = parseInt(appData.settings.reminder3Days) || 14;
                
                appData.invoices.forEach(function(invoice) {
                    if (invoice.status === 'unpaid' && invoice.sentDate) {
                        const sentDate = new Date(invoice.sentDate);
                        const daysSinceSent = Math.floor((now - sentDate) / (24 * 60 * 60 * 1000));
                        
                        const shouldRemind = (
                            daysSinceSent === reminder1Days ||
                            daysSinceSent === (reminder1Days + reminder2Days) ||
                            daysSinceSent === (reminder1Days + reminder2Days + reminder3Days)
                        );
                        
                        if (shouldRemind) {
                            const notificationId = 'invoice-' + invoice.id + '-day' + daysSinceSent;
                            const exists = appData.notifications.find(function(n) { return n.id === notificationId; });
                            
                            if (!exists) {
                                appData.notifications.push({
                                    id: notificationId,
                                    type: 'invoice',
                                    title: 'Invoice Reminder',
                                    message: 'Invoice #' + invoice.id.slice(-6) + ' for ' + invoice.customerName + ' ($' + invoice.total + ') is ' + daysSinceSent + ' days overdue',
                                    date: now.toISOString(),
                                    read: false,
                                    invoiceId: invoice.id
                                });
                            }
                        }
                    }
                });
            }
            
            saveData();
            updateNotificationBadge();
            renderNotifications();
        }

        function updateNotificationBadge() {
            const unreadCount = appData.notifications.filter(function(n) { return !n.read; }).length;
            const badge = document.getElementById('notificationBadge');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('hidden');
            
            if (!panel.classList.contains('hidden')) {
                renderNotifications();
            }
        }

        function renderNotifications() {
            const container = document.getElementById('notificationsList');
            
            if (appData.notifications.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No notifications</p>';
                return;
            }
            
            const sorted = appData.notifications.slice().sort(function(a, b) { 
                return new Date(b.date) - new Date(a.date); 
            });
            
            container.innerHTML = sorted.map(function(notif) {
                return '<div class="notification-item ' + (!notif.read ? 'unread' : '') + '" onclick="markNotificationRead(\'' + notif.id + '\')">' +
                    '<div class="flex justify-between items-start mb-1">' +
                        '<span class="font-semibold text-orange text-sm">' + notif.title + '</span>' +
                        '<span class="text-xs text-gray-500">' + formatNotificationDate(notif.date) + '</span>' +
                    '</div>' +
                    '<p class="text-xs text-gray-300">' + notif.message + '</p>' +
                '</div>';
            }).join('');
        }

        function markNotificationRead(notifId) {
            const notif = appData.notifications.find(function(n) { return n.id === notifId; });
            if (notif) {
                notif.read = true;
                saveData();
                updateNotificationBadge();
                renderNotifications();
            }
        }

        function clearAllNotifications() {
            if (confirm('Clear all notifications?')) {
                appData.notifications = [];
                saveData();
                updateNotificationBadge();
                renderNotifications();
            }
        }

        function formatNotificationDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 60) return diffMins + 'm ago';
            if (diffHours < 24) return diffHours + 'h ago';
            if (diffDays < 7) return diffDays + 'd ago';
            return date.toLocaleDateString();
        }

        // Calendar Functions
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            document.getElementById('calendarMonth').textContent = 
                currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day bg-gray-800 bg-opacity-30';
                grid.appendChild(emptyCell);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                
                const today = new Date();
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dayCell.classList.add('today');
                }
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'font-semibold text-sm mb-2';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);
                
                const jobsForDay = appData.scheduledJobs.filter(function(j) { return j.date === dateStr; });
                jobsForDay.forEach(function(job) {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'calendar-event';
                    eventDiv.textContent = job.time + ' - ' + job.title;
                    eventDiv.onclick = function(e) {
                        e.stopPropagation();
                        viewJob(job.id);
                    };
                    dayCell.appendChild(eventDiv);
                });
                
                dayCell.onclick = function() { openScheduleModalForDate(dateStr); };
                grid.appendChild(dayCell);
            }
        }

        function previousMonth() {
            currentCalendarDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() - 1, 1);
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 1);
            renderCalendar();
        }

        function openScheduleModalForDate(dateStr) {
            openModal('scheduleModal');
            document.getElementById('schedDate').value = dateStr;
        }

        function viewJob(jobId) {
            const job = appData.scheduledJobs.find(function(j) { return j.id === jobId; });
            if (!job) return;
            
            alert('Job: ' + job.title + '\nCustomer: ' + job.customerName + '\nDate: ' + job.date + ' at ' + job.time + '\nDuration: ' + job.duration + ' hours\nNotes: ' + (job.notes || 'None'));
        }

        document.getElementById('scheduleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customerId = document.getElementById('schedCustomer').value;
            const customer = appData.customers.find(function(c) { return c.id === customerId; });
            
            const job = {
                id: Date.now().toString(),
                customerId: customerId,
                customerName: customer.name,
                title: document.getElementById('schedTitle').value,
                date: document.getElementById('schedDate').value,
                time: document.getElementById('schedTime').value,
                duration: parseFloat(document.getElementById('schedDuration').value),
                notes: document.getElementById('schedNotes').value,
                status: 'scheduled',
                createdAt: new Date().toISOString()
            };
            
            appData.scheduledJobs.push(job);
            saveData();
            this.reset();
            closeModal('scheduleModal');
            renderCalendar();
            checkNotifications();
            alert('Job scheduled successfully!');
        });

        // Team Members
        function renderTeamMembers() {
            const container = document.getElementById('teamMembersList');
            container.innerHTML = appData.teamMembers.map(function(member, i) {
                const monthlyCost = (member.hourlyRate || 0) * (member.hoursPerMonth || 0);
                return '<div class="mb-3 p-3 bg-black bg-opacity-20 rounded border border-orange-500 border-opacity-20">' +
                    '<input type="text" value="' + member.name + '" ' +
                        'onchange="appData.teamMembers[' + i + '].name = this.value; calculateAll();" ' +
                        'placeholder="Team Member Name" class="w-full mb-2 p-2 border border-orange-500 border-opacity-30 rounded text-sm">' +
                    '<div class="grid grid-cols-2 gap-2 mb-2">' +
                        '<input type="number" value="' + (member.hourlyRate || '') + '" step="0.01" ' +
                            'onchange="appData.teamMembers[' + i + '].hourlyRate = parseFloat(this.value) || 0; renderTeamMembers(); calculateAll();" ' +
                            'placeholder="$/hr" class="p-2 border border-orange-500 border-opacity-30 rounded text-sm">' +
                        '<input type="number" value="' + (member.hoursPerMonth || '') + '" step="1" ' +
                            'onchange="appData.teamMembers[' + i + '].hoursPerMonth = parseFloat(this.value) || 0; renderTeamMembers(); calculateAll();" ' +
                            'placeholder="hrs/mo" class="p-2 border border-orange-500 border-opacity-30 rounded text-sm">' +
                    '</div>' +
                    '<div class="flex justify-between items-center">' +
                        '<span class="text-xs text-gray-400">Monthly Cost: <span class="text-orange font-semibold">$' + monthlyCost.toFixed(2) + '</span></span>' +
                        '<button type="button" class="btn-danger text-sm px-3 py-1" onclick="removeTeamMember(' + i + ')">Remove</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function addTeamMember() {
            appData.teamMembers.push({ name: '', hourlyRate: 0, hoursPerMonth: 0 });
            renderTeamMembers();
        }

        function removeTeamMember(index) {
            appData.teamMembers.splice(index, 1);
            renderTeamMembers();
            calculateAll();
        }

        // Expenses
        function renderExpenses() {
            const container = document.getElementById('expensesList');
            container.innerHTML = appData.expenses.map(function(exp, i) {
                return '<div class="grid grid-cols-12 gap-2 items-center">' +
                    '<input type="text" value="' + exp.name + '" ' +
                        'onchange="appData.expenses[' + i + '].name = this.value; calculateAll();" ' +
                        'placeholder="Expense name" class="col-span-7 p-2 border border-orange-500 border-opacity-30 rounded text-sm">' +
                    '<input type="number" value="' + exp.amount + '" step="0.01" ' +
                        'onchange="appData.expenses[' + i + '].amount = parseFloat(this.value) || 0; calculateAll();" ' +
                        'placeholder="Amount" class="col-span-4 p-2 border border-orange-500 border-opacity-30 rounded text-sm">' +
                    '<button type="button" class="btn-danger col-span-1 text-sm p-2" onclick="removeExpense(' + i + ')">√ó</button>' +
                '</div>';
            }).join('');
        }

        function addExpense() {
            appData.expenses.push({ name: '', amount: 0 });
            renderExpenses();
        }

        function removeExpense(index) {
            appData.expenses.splice(index, 1);
            renderExpenses();
            calculateAll();
        }

        // Calculator
        function calculateAll() {
            const teamCost = appData.teamMembers.reduce(function(sum, m) {
                const memberCost = (parseFloat(m.hourlyRate) || 0) * (parseFloat(m.hoursPerMonth) || 0);
                return sum + memberCost;
            }, 0);
            const expenses = appData.expenses.reduce(function(sum, e) { return sum + (parseFloat(e.amount) || 0); }, 0);
            const profit = parseFloat(document.getElementById('desiredProfit') ? document.getElementById('desiredProfit').value : 0) || appData.calculator.desiredProfit;
            const hours = parseFloat(document.getElementById('workingHours') ? document.getElementById('workingHours').value : 0) || appData.calculator.workingHours;
            
            const totalCosts = teamCost + expenses;
            const profitMarginPercent = totalCosts > 0 ? ((profit / totalCosts) * 100) : 0;
            
            if (document.getElementById('profitMargin') && document.activeElement.id !== 'profitMargin') {
                document.getElementById('profitMargin').value = profitMarginPercent.toFixed(1);
            }
            
            const teamCostPerHour = hours > 0 ? teamCost / hours : 0;
            const overheadPerHour = hours > 0 ? expenses / hours : 0;
            const profitPerHour = hours > 0 ? profit / hours : 0;
            const hourlyRate = teamCostPerHour + overheadPerHour + profitPerHour;
            const requiredRevenue = teamCost + expenses + profit;
            
            document.getElementById('totalTeamCost').textContent = '$' + teamCost.toFixed(2);
            document.getElementById('totalExpenses').textContent = '$' + expenses.toFixed(2);
            document.getElementById('teamCostPerHour').textContent = '$' + teamCostPerHour.toFixed(2);
            document.getElementById('overheadPerHour').textContent = '$' + overheadPerHour.toFixed(2);
            document.getElementById('profitPerHour').textContent = '$' + profitPerHour.toFixed(2);
            document.getElementById('minimumRate').textContent = '$' + hourlyRate.toFixed(2);
            document.getElementById('marginDisplay').textContent = profitMarginPercent.toFixed(1) + '%';
            document.getElementById('summaryTeam').textContent = '$' + teamCost.toFixed(2);
            document.getElementById('summaryExpenses').textContent = '$' + expenses.toFixed(2);
            document.getElementById('summaryTotalCosts').textContent = '$' + totalCosts.toFixed(2);
            document.getElementById('summaryProfit').textContent = '$' + profit.toFixed(2);
            document.getElementById('requiredRevenue').textContent = '$' + requiredRevenue.toFixed(2);
            
            appData.calculator.hourlyRate = hourlyRate;
        }

        function calculateFromMargin() {
            const teamCost = appData.teamMembers.reduce(function(sum, m) {
                const memberCost = (parseFloat(m.hourlyRate) || 0) * (parseFloat(m.hoursPerMonth) || 0);
                return sum + memberCost;
            }, 0);
            const expenses = appData.expenses.reduce(function(sum, e) { return sum + (parseFloat(e.amount) || 0); }, 0);
            const totalCosts = teamCost + expenses;
            const marginPercent = parseFloat(document.getElementById('profitMargin').value) || 0;
            
            const calculatedProfit = (totalCosts * marginPercent) / 100;
            document.getElementById('desiredProfit').value = calculatedProfit.toFixed(2);
            
            calculateAll();
        }

        function toggleCalculatorView(view) {
            appData.calculator.view = view;
            updateCalculatorViewButtons();
            calculateAll();
            saveData();
        }

        function updateCalculatorViewButtons() {
            const monthlyBtn = document.getElementById('monthlyViewBtn');
            const yearlyBtn = document.getElementById('yearlyViewBtn');
            
            if (appData.calculator.view === 'monthly') {
                monthlyBtn.classList.add('btn-primary');
                monthlyBtn.classList.remove('btn-secondary');
                yearlyBtn.classList.remove('btn-primary');
                yearlyBtn.classList.add('btn-secondary');
            } else {
                yearlyBtn.classList.add('btn-primary');
                yearlyBtn.classList.remove('btn-secondary');
                monthlyBtn.classList.remove('btn-primary');
                monthlyBtn.classList.add('btn-secondary');
            }
        }

        function saveCalculator() {
            appData.calculator.desiredProfit = parseFloat(document.getElementById('desiredProfit').value) || 0;
            appData.calculator.workingHours = parseFloat(document.getElementById('workingHours').value) || 160;
            calculateAll();
            saveData();
            alert('Calculator settings saved!');
        }

        // Customers
        document.getElementById('customerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            appData.customers.push({
                id: Date.now().toString(),
                name: document.getElementById('custName').value,
                email: document.getElementById('custEmail').value,
                phone: document.getElementById('custPhone').value,
                address: document.getElementById('custAddress').value
            });
            saveData();
            this.reset();
            closeModal('customerModal');
            renderCustomers();
        });

        function renderCustomers() {
            const tbody = document.getElementById('customersTable');
            if (appData.customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No customers yet</td></tr>';
                return;
            }
            tbody.innerHTML = appData.customers.map(function(c) {
                return '<tr>' +
                    '<td class="py-3 px-4">' + c.name + '</td>' +
                    '<td class="py-3 px-4">' + (c.email || '-') + '</td>' +
                    '<td class="py-3 px-4">' + (c.phone || '-') + '</td>' +
                    '<td class="py-3 px-4">' + (c.address || '-') + '</td>' +
                    '<td class="py-3 px-4 text-right">' +
                        '<button class="btn-danger" onclick="deleteCustomer(\'' + c.id + '\')">Delete</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        function deleteCustomer(id) {
            if (confirm('Delete this customer?')) {
                appData.customers = appData.customers.filter(function(c) { return c.id !== id; });
                saveData();
                renderCustomers();
            }
        }

        function populateCustomerSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select Customer</option>' +
                appData.customers.map(function(c) { return '<option value="' + c.id + '">' + c.name + '</option>'; }).join('');
        }

        // Materials
        document.getElementById('materialForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            let category = document.getElementById('matCategory').value;
            const newCategory = document.getElementById('matNewCategory').value;
            
            if (newCategory) {
                category = newCategory;
            }
            
            appData.materials.push({
                id: Date.now().toString(),
                name: document.getElementById('matName').value,
                category: category || 'Uncategorized',
                description: document.getElementById('matDescription').value,
                cost: parseFloat(document.getElementById('matCost').value),
                unit: document.getElementById('matUnit').value,
                markup: parseFloat(document.getElementById('matMarkup').value) || 0
            });
            saveData();
            this.reset();
            document.getElementById('matNewCategory').classList.add('hidden');
            closeModal('materialModal');
            renderMaterials();
        });

        function toggleNewCategory() {
            const input = document.getElementById('matNewCategory');
            const select = document.getElementById('matCategory');
            if (input.classList.contains('hidden')) {
                input.classList.remove('hidden');
                select.value = '';
            } else {
                input.classList.add('hidden');
                input.value = '';
            }
        }

        function populateCategoryDropdown() {
            const categories = [];
            const seen = {};
            appData.materials.forEach(function(m) {
                const cat = m.category || 'Uncategorized';
                if (!seen[cat]) {
                    seen[cat] = true;
                    categories.push(cat);
                }
            });
            const select = document.getElementById('matCategory');
            select.innerHTML = '<option value="">Select or create category</option>' +
                categories.map(function(cat) { return '<option value="' + cat + '">' + cat + '</option>'; }).join('');
                
            const filter = document.getElementById('categoryFilter');
            if (filter) {
                filter.innerHTML = '<option value="all">All Categories</option>' +
                    categories.map(function(cat) { return '<option value="' + cat + '">' + cat + '</option>'; }).join('');
            }
        }

        function filterMaterialsByCategory() {
            renderMaterials();
        }

        function renderMaterials() {
            const container = document.getElementById('materialsList');
            const filterValue = document.getElementById('categoryFilter') ? document.getElementById('categoryFilter').value : 'all';
            
            let filteredMaterials = appData.materials;
            if (filterValue !== 'all') {
                filteredMaterials = appData.materials.filter(function(m) { return (m.category || 'Uncategorized') === filterValue; });
            }
            
            if (filteredMaterials.length === 0) {
                container.innerHTML = '<div class="card col-span-full text-center text-gray-500 py-8">No materials in this category</div>';
                return;
            }
            
            const grouped = {};
            filteredMaterials.forEach(function(m) {
                const cat = m.category || 'Uncategorized';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(m);
            });
            
            container.innerHTML = Object.keys(grouped).map(function(category) {
                return '<div class="card">' +
                    '<div class="mb-4 pb-3 border-b border-orange-500 border-opacity-20">' +
                        '<h4 class="font-bold text-lg text-orange">' + category + '</h4>' +
                        '<p class="text-xs text-gray-500">' + grouped[category].length + ' items</p>' +
                    '</div>' +
                    '<div class="space-y-3">' +
                        grouped[category].map(function(m) {
                            return '<div class="p-3 bg-black bg-opacity-20 rounded border border-orange-500 border-opacity-10">' +
                                '<div class="flex justify-between items-start mb-2">' +
                                    '<div class="flex-1">' +
                                        '<h5 class="font-semibold text-white">' + m.name + '</h5>' +
                                        (m.description ? '<p class="text-xs text-gray-400 mt-1">' + m.description + '</p>' : '') +
                                    '</div>' +
                                    '<button class="btn-danger text-xs px-2 py-1" onclick="deleteMaterial(\'' + m.id + '\')">√ó</button>' +
                                '</div>' +
                                '<div class="flex justify-between items-center text-sm">' +
                                    '<span class="text-gray-400">$' + m.cost + (m.unit ? ' / ' + m.unit : '') + '</span>' +
                                    '<span class="text-orange font-medium">' + m.markup + '% markup</span>' +
                                '</div>' +
                            '</div>';
                        }).join('') +
                    '</div>' +
                '</div>';
            }).join('');
            
            populateCategoryDropdown();
        }

        function deleteMaterial(id) {
            if (confirm('Delete this material?')) {
                appData.materials = appData.materials.filter(function(m) { return m.id !== id; });
                saveData();
                renderMaterials();
            }
        }

        // Templates
        document.getElementById('templateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const selectedMaterials = [];
            const checkboxes = document.querySelectorAll('#templateMaterialsList input[type="checkbox"]:checked');
            checkboxes.forEach(function(cb) {
                const matId = cb.value;
                const qtyInput = document.getElementById('qty_' + matId);
                const qty = parseFloat(qtyInput ? qtyInput.value : 1) || 1;
                selectedMaterials.push({ materialId: matId, quantity: qty });
            });
            
            appData.templates.push({
                id: Date.now().toString(),
                name: document.getElementById('tempName').value,
                description: document.getElementById('tempDescription').value,
                materials: selectedMaterials
            });
            saveData();
            this.reset();
            closeModal('templateModal');
            renderTemplates();
        });

        function populateTemplateMaterialsList() {
            const container = document.getElementById('templateMaterialsList');
            if (appData.materials.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No materials available. Add materials first.</p>';
                return;
            }
            
            const grouped = {};
            appData.materials.forEach(function(m) {
                const cat = m.category || 'Uncategorized';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(m);
            });
            
            container.innerHTML = Object.keys(grouped).map(function(category) {
                return '<div class="mb-3">' +
                    '<p class="text-xs font-semibold text-orange mb-2">' + category + '</p>' +
                    grouped[category].map(function(m) {
                        return '<div class="flex items-center gap-3 p-2 mb-1 border border-orange-500 border-opacity-20 rounded">' +
                            '<input type="checkbox" value="' + m.id + '" id="mat_' + m.id + '">' +
                            '<label for="mat_' + m.id + '" class="flex-1 text-sm">' + m.name + ' ($' + m.cost + '/' + (m.unit || 'ea') + ')</label>' +
                            '<input type="number" id="qty_' + m.id + '" placeholder="Qty" step="0.01" ' +
                                'class="w-20 p-1 border border-orange-500 border-opacity-30 rounded text-sm" value="1">' +
                        '</div>';
                    }).join('') +
                '</div>';
            }).join('');
        }

        function deleteTemplate(id) {
            if (confirm('Delete this template?')) {
                appData.templates = appData.templates.filter(function(t) { return t.id !== id; });
                saveData();
                renderTemplates();
            }
        }

        function renderTemplates() {
            const templatesList = document.getElementById('templatesList');
            if (appData.templates.length === 0) {
                templatesList.innerHTML = '<div class="card text-center text-gray-500 py-8">No templates yet. Create your first material package.</div>';
            } else {
                templatesList.innerHTML = '<div class="space-y-4">' +
                    appData.templates.map(function(t) {
                        return '<div class="card">' +
                            '<div class="flex justify-between items-start mb-3">' +
                                '<div class="flex-1">' +
                                    '<h4 class="font-bold text-xl text-orange mb-1">' + t.name + '</h4>' +
                                    '<p class="text-sm text-gray-400">' + (t.description || '') + '</p>' +
                                '</div>' +
                                '<button class="btn-danger text-sm px-3 py-1" onclick="deleteTemplate(\'' + t.id + '\')">Delete</button>' +
                            '</div>' +
                            '<div class="pt-3 border-t border-orange-500 border-opacity-20">' +
                                '<p class="text-xs text-gray-500 mb-2">' + t.materials.length + ' materials included:</p>' +
                                '<div class="space-y-1">' +
                                    t.materials.slice(0, 3).map(function(tm) {
                                        const mat = appData.materials.find(function(m) { return m.id === tm.materialId; });
                                        return mat ? '<div class="text-xs text-gray-400">‚Ä¢ ' + mat.name + ' (' + tm.quantity + ' ' + (mat.unit || 'units') + ')</div>' : '';
                                    }).join('') +
                                    (t.materials.length > 3 ? '<div class="text-xs text-gray-500">+ ' + (t.materials.length - 3) + ' more...</div>' : '') +
                                '</div>' +
                            '</div>' +
                        '</div>';
                    }).join('') +
                '</div>';
            }
            
            const termsList = document.getElementById('termsList');
            if (appData.terms.length === 0) {
                termsList.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No terms templates yet</p>';
            } else {
                termsList.innerHTML = appData.terms.map(function(t) {
                    return '<div class="p-3 bg-black bg-opacity-20 rounded border border-orange-500 border-opacity-10">' +
                        '<div class="flex justify-between items-start mb-2">' +
                            '<h5 class="font-semibold text-white">' + t.name + '</h5>' +
                            '<button class="btn-danger text-xs px-2 py-1" onclick="deleteTerms(\'' + t.id + '\')">√ó</button>' +
                        '</div>' +
                        '<p class="text-xs text-gray-400">' + t.content.substring(0, 80) + (t.content.length > 80 ? '...' : '') + '</p>' +
                    '</div>';
                }).join('');
            }
        }

        document.getElementById('termsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            appData.terms.push({
                id: Date.now().toString(),
                name: document.getElementById('termsName').value,
                content: document.getElementById('termsContent').value
            });
            saveData();
            this.reset();
            closeModal('termsModal');
            renderTemplates();
        });

        function deleteTerms(id) {
            if (confirm('Delete this terms template?')) {
                appData.terms = appData.terms.filter(function(t) { return t.id !== id; });
                saveData();
                renderTemplates();
            }
        }

        function populateTermsSelect() {
            const select = document.getElementById('estTerms');
            select.innerHTML = '<option value="">No Terms</option>' +
                appData.terms.map(function(t) { return '<option value="' + t.id + '">' + t.name + '</option>'; }).join('');
        }

        // Estimates
        function addEstimateLine() {
            const container = document.getElementById('estimateLines');
            const lineDiv = document.createElement('div');
            lineDiv.className = 'grid grid-cols-12 gap-2 items-center';
            lineDiv.innerHTML = 
                '<input type="text" placeholder="Description" class="col-span-5 p-2 border border-orange-500 border-opacity-30 rounded text-sm" onchange="calculateEstimate()">' +
                '<input type="number" placeholder="Qty" value="1" step="0.01" class="col-span-2 p-2 border border-orange-500 border-opacity-30 rounded text-sm" onchange="calculateEstimate()">' +
                '<input type="number" placeholder="Rate" step="0.01" class="col-span-2 p-2 border border-orange-500 border-opacity-30 rounded text-sm" onchange="calculateEstimate()">' +
                '<input type="number" placeholder="Markup %" value="0" step="0.01" class="col-span-2 p-2 border border-orange-500 border-opacity-30 rounded text-sm" onchange="calculateEstimate()">' +
                '<button type="button" class="btn-danger text-sm col-span-1 p-2" onclick="this.parentElement.remove(); calculateEstimate()">√ó</button>';
            container.appendChild(lineDiv);
        }

        function populateTemplateSelect() {
            const select = document.getElementById('estTemplate');
            select.innerHTML = '<option value="">No Template</option>' +
                appData.templates.map(function(t) { return '<option value="' + t.id + '">' + t.name + '</option>'; }).join('');
        }

        function applyTemplate() {
            const templateId = document.getElementById('estTemplate').value;
            if (!templateId) return;
            
            const template = appData.templates.find(function(t) { return t.id === templateId; });
            const container = document.getElementById('estimateLines');
            container.innerHTML = '';
            
            template.materials.forEach(function(tm) {
                const material = appData.materials.find(function(m) { return m.id === tm.materialId; });
                if (material) {
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'grid grid-cols-12 gap-2 items-center';
                    const priceWithMarkup = material.cost * (1 + material.markup / 100);
                    lineDiv.innerHTML = 
                        '<input type="text" value="' + material.name + ' - ' + (material.description || '') + '" class="col-span-5 p-2 border border-orange-500 border-opacity-30 rounded text-sm" onchange="calculateEstimate()">' +
                        '<input type="number" value="' + tm.quantity + '" step="0.01" class="col-span-2 p-2 border border-orange-500 border-opacity-30 rounded text-sm" onchange="calculateEstimate()">' +
                        '<input type="number" value="' + priceWithMarkup.toFixed(2) + '" step="0.01" class="col-span-2 p-2 border border-orange-500 border-opacity-30 rounded text-sm" onchange="calculateEstimate()">' +
                        '<input type="number" value="' + material.markup + '" step="0.01" class="col-span-2 p-2 border border-orange-500 border-opacity-30 rounded text-sm" onchange="calculateEstimate()">' +
                        '<button type="button" class="btn-danger text-sm col-span-1 p-2" onclick="this.parentElement.remove(); calculateEstimate()">√ó</button>';
                    container.appendChild(lineDiv);
                }
            });
            
            calculateEstimate();
        }

        function calculateEstimate() {
            const lines = document.querySelectorAll('#estimateLines > div');
            let subtotal = 0;
            let laborHours = 0;
            
            lines.forEach(function(line) {
                const inputs = line.querySelectorAll('input');
                const desc = inputs[0].value.toLowerCase();
                const qty = parseFloat(inputs[1].value) || 0;
                const rate = parseFloat(inputs[2].value) || 0;
                const markup = parseFloat(inputs[3].value) || 0;
                
                const baseAmount = qty * rate;
                const markupAmount = baseAmount * (markup / 100);
                const total = baseAmount + markupAmount;
                
                subtotal += total;
                
                if (desc.includes('labor') || desc.includes('hour')) {
                    laborHours += qty;
                }
            });
            
            const laborCost = laborHours * appData.calculator.hourlyRate;
            const profit = subtotal - laborCost;
            const margin = subtotal > 0 ? (profit / subtotal * 100) : 0;
            
            document.getElementById('estSubtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('estLaborCost').textContent = '$' + laborCost.toFixed(2);
            document.getElementById('estProfit').textContent = '$' + profit.toFixed(2);
            document.getElementById('estTotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('estMargin').textContent = margin.toFixed(1) + '%';
        }

        document.getElementById('estimateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customerId = document.getElementById('estCustomer').value;
            const customer = appData.customers.find(function(c) { return c.id === customerId; });
            
            const lines = [];
            document.querySelectorAll('#estimateLines > div').forEach(function(line) {
                const inputs = line.querySelectorAll('input');
                const qty = parseFloat(inputs[1].value) || 0;
                const rate = parseFloat(inputs[2].value) || 0;
                const markup = parseFloat(inputs[3].value) || 0;
                lines.push({
                    description: inputs[0].value,
                    quantity: qty,
                    rate: rate,
                    markup: markup,
                    amount: (qty * rate * (1 + markup/100)).toFixed(2)
                });
            });
            
            const termsId = document.getElementById('estTerms').value;
            const termsTemplate = termsId ? appData.terms.find(function(t) { return t.id === termsId; }) : null;
            
            const estimate = {
                id: Date.now().toString(),
                type: 'estimate',
                customerId: customerId,
                customerName: customer.name,
                customerEmail: customer.email,
                customerPhone: customer.phone || '',
                customerAddress: customer.address || '',
                date: document.getElementById('estDate').value,
                lineItems: lines,
                notes: document.getElementById('estNotes').value,
                terms: termsTemplate ? termsTemplate.content : '',
                termsName: termsTemplate ? termsTemplate.name : '',
                total: document.getElementById('estTotal').textContent.replace('$', ''),
                profit: document.getElementById('estProfit').textContent.replace('$', ''),
                margin: document.getElementById('estMargin').textContent,
                status: 'pending',
                sentDate: null,
                reminderSent: false
            };
            
            appData.estimates.push(estimate);
            saveData();
            this.reset();
            document.getElementById('estimateLines').innerHTML = '';
            addEstimateLine();
            closeModal('estimateModal');
            renderDocuments();
        });

        function renderDocuments() {
            const container = document.getElementById('documentsList');
            const allDocs = appData.estimates.concat(appData.invoices).sort(function(a, b) { return b.id - a.id; });
            
            if (allDocs.length === 0) {
                container.innerHTML = '<div class="card text-center text-gray-500 py-8">No documents yet</div>';
                return;
            }
            
            container.innerHTML = allDocs.map(function(doc) {
                return '<div class="card">' +
                    '<div class="flex justify-between items-start mb-4">' +
                        '<div>' +
                            '<div class="flex items-center gap-3 mb-1">' +
                                '<h3 class="text-xl font-semibold">' + (doc.type === 'estimate' ? 'Estimate' : 'Invoice') + ' #' + doc.id.slice(-6) + '</h3>' +
                                '<span class="status-badge status-' + doc.status + '">' + doc.status + '</span>' +
                            '</div>' +
                            '<p class="text-gray-400">' + doc.customerName + '</p>' +
                            '<p class="text-sm text-gray-500">Date: ' + doc.date + '</p>' +
                            (doc.termsName ? '<p class="text-xs text-orange mt-1">Terms: ' + doc.termsName + '</p>' : '') +
                        '</div>' +
                        '<div class="text-right">' +
                            '<p class="text-3xl font-bold text-orange">$' + doc.total + '</p>' +
                            '<p class="text-sm text-green-400">Profit: $' + doc.profit + ' (' + doc.margin + ')</p>' +
                        '</div>' +
                    '</div>' +
                    '<div class="space-y-1 mb-4 text-sm">' +
                        doc.lineItems.map(function(item) {
                            return '<div class="flex justify-between text-gray-300">' +
                                '<span>' + item.description + ' (' + item.quantity + ' √ó $' + item.rate + (item.markup > 0 ? ' + ' + item.markup + '%' : '') + ')</span>' +
                                '<span class="font-medium">$' + item.amount + '</span>' +
                            '</div>';
                        }).join('') +
                    '</div>' +
                    (doc.notes ? '<div class="text-sm text-gray-400 mb-3 p-3 bg-black bg-opacity-20 rounded">' + doc.notes + '</div>' : '') +
                    (doc.terms ? '<div class="text-xs text-gray-500 mb-3 p-3 border border-orange-500 border-opacity-20 rounded">' +
                        '<p class="font-semibold text-orange mb-1">Terms & Conditions:</p>' +
                        '<p class="whitespace-pre-wrap">' + doc.terms + '</p>' +
                    '</div>' : '') +
                    '<div class="flex flex-wrap gap-2 pt-4 border-t border-orange-500 border-opacity-20">' +
                        (doc.type === 'estimate' ? 
                            '<button class="btn-primary" onclick="viewEstimate(\'' + doc.id + '\')">üëÅ View</button>' +
                            '<button class="btn-secondary" onclick="editDocument(\'' + doc.id + '\', \'estimate\')">‚úèÔ∏è Edit</button>' +
                            '<button class="btn-secondary" onclick="convertToInvoice(\'' + doc.id + '\')">üìÑ Convert to Invoice</button>' +
                            '<button class="btn-secondary" onclick="sendDocument(\'' + doc.id + '\')">üìß Send</button>' :
                            '<button class="btn-primary" onclick="viewInvoice(\'' + doc.id + '\')">üëÅ View</button>' +
                            '<button class="btn-secondary" onclick="editDocument(\'' + doc.id + '\', \'invoice\')">‚úèÔ∏è Edit</button>' +
                            '<button class="btn-secondary" onclick="sendDocument(\'' + doc.id + '\')">üìß Send</button>') +
                        '<button class="btn-danger" onclick="deleteDocument(\'' + doc.id + '\', \'' + doc.type + '\')">üóë</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function convertToInvoice(estimateId) {
            const estimate = appData.estimates.find(function(e) { return e.id === estimateId; });
            const invoice = JSON.parse(JSON.stringify(estimate));
            invoice.id = Date.now().toString();
            invoice.type = 'invoice';
            invoice.dueDate = new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0];
            invoice.status = 'unpaid';
            invoice.estimateId = estimateId;
            invoice.signature = null;
            invoice.signedDate = null;
            invoice.sentDate = new Date().toISOString();
            
            appData.invoices.push(invoice);
            estimate.status = 'approved';
            saveData();
            renderDocuments();
            checkNotifications();
            alert('Estimate converted to invoice!');
        }

        function sendDocument(id) {
            const allDocs = appData.estimates.concat(appData.invoices);
            const doc = allDocs.find(function(d) { return d.id === id; });
            if (!doc) return;

            var pubKey = appData.settings.emailjsPublicKey;
            var serviceId = appData.settings.emailjsServiceId;
            var templateId = appData.settings.emailjsTemplateId;

            if (!pubKey || !serviceId || !templateId) {
                alert('Email not set up yet. Go to Settings ‚Üí Email Settings (EmailJS) to configure.');
                return;
            }
            if (!doc.customerEmail) {
                alert('This customer has no email address on file.');
                return;
            }

            var s = appData.settings;
            var bizName = s.businessName || 'KDRSYSTEMS';
            var docType = doc.type === 'estimate' ? 'Estimate' : 'Invoice';
            var docNum = '#' + doc.id.slice(-6);
            var siteUrl = window.location.origin + window.location.pathname;

            // Line items (K-DR orange row style)
            var itemsHtml = doc.lineItems.map(function(item, idx) {
                var bgColor = idx % 2 === 0 ? '#fff3ec' : '#ffe8d9';
                return '<tr style="background:' + bgColor + ';">' +
                    '<td style="padding:14px 16px;color:#333;font-size:14px;font-weight:600;text-transform:uppercase;">' + item.description + '</td>' +
                    '<td style="padding:14px 12px;text-align:center;color:#333;font-size:14px;">' + item.quantity + '</td>' +
                    '<td style="padding:14px 12px;text-align:right;color:#333;font-size:14px;">$' + item.rate + '</td>' +
                    '<td style="padding:14px 16px;text-align:right;font-weight:700;color:#222;font-size:14px;">$' + item.amount + '</td>' +
                '</tr>';
            }).join('');

            // Social icons
            var socialIcons = [];
            if (s.instagram) socialIcons.push('<a href="' + (s.instagram.startsWith('http') ? s.instagram : 'https://instagram.com/' + s.instagram.replace('@','')) + '" style="display:inline-block;margin:0 8px;" target="_blank"><img src="https://img.icons8.com/fluency/28/instagram-new.png" alt="Instagram" style="width:28px;height:28px;"></a>');
            if (s.facebook) socialIcons.push('<a href="' + (s.facebook.startsWith('http') ? s.facebook : 'https://facebook.com/' + s.facebook) + '" style="display:inline-block;margin:0 8px;" target="_blank"><img src="https://img.icons8.com/fluency/28/facebook-new.png" alt="Facebook" style="width:28px;height:28px;"></a>');
            if (s.tiktok) socialIcons.push('<a href="' + (s.tiktok.startsWith('http') ? s.tiktok : 'https://tiktok.com/@' + s.tiktok.replace('@','')) + '" style="display:inline-block;margin:0 8px;" target="_blank"><img src="https://img.icons8.com/fluency/28/tiktok.png" alt="TikTok" style="width:28px;height:28px;"></a>');
            if (s.google) socialIcons.push('<a href="' + (s.google.startsWith('http') ? s.google : 'https://g.page/' + s.google) + '" style="display:inline-block;margin:0 8px;" target="_blank"><img src="https://img.icons8.com/fluency/28/google-logo.png" alt="Google" style="width:28px;height:28px;"></a>');
            var socialsRow = socialIcons.length ? '<div style="margin:16px 0;">' + socialIcons.join('') + '</div>' : '';

            // Create public estimate for signing (estimates only)
            var signToken = doc.id + '_' + Date.now();
            var signLinkHtml = '';

            function buildAndSendEmail() {
                if (doc.type === 'estimate') {
                    signLinkHtml = '<div style="text-align:center;margin:25px 0;padding:24px;background:#fff8f0;border-radius:8px;border:1px solid #ffe0c2;">' +
                        '<p style="font-family:Georgia,serif;font-size:16px;font-weight:700;color:#333;margin:0 0 8px;">Ready to approve this estimate?</p>' +
                        '<p style="font-size:13px;color:#777;margin:0 0 16px;">Click below to review and sign digitally</p>' +
                        '<a href="' + siteUrl + '?sign=' + signToken + '" style="display:inline-block;background:#ff6b35;color:white;padding:16px 40px;border-radius:6px;text-decoration:none;font-weight:700;font-size:16px;text-transform:uppercase;letter-spacing:1px;">‚úçÔ∏è Sign & Approve</a>' +
                    '</div>';
                }

                // K-DR Style Email (matching PDF design)
                var emailBody = '' +
                '<div style="max-width:640px;margin:0 auto;font-family:Arial,Helvetica,sans-serif;background:#fff;">' +
                    // Dark Header with branding
                    '<div style="background:#2a2a2a;padding:30px;text-align:center;">' +
                        (s.logo ? '<img src="' + s.logo + '" alt="' + bizName + '" style="max-height:80px;margin-bottom:8px;">' : '') +
                        '<h1 style="color:#ff6b35;margin:0;font-size:28px;font-weight:900;text-transform:uppercase;letter-spacing:2px;">' + bizName + '</h1>' +
                        '<p style="color:#ccc;margin:6px 0 0;font-size:12px;font-style:italic;letter-spacing:1px;">"Your Property, Our Experience"</p>' +
                    '</div>' +
                    // White Body
                    '<div style="padding:30px 35px;background:#ffffff;">' +
                        // Title + Date
                        '<div style="margin-bottom:20px;">' +
                            '<h2 style="color:#222;margin:0;font-size:32px;font-weight:900;text-transform:uppercase;letter-spacing:1px;">' + docType.toUpperCase() + '</h2>' +
                            '<p style="color:#999;font-size:13px;margin:4px 0 0;">' + docType + ' Date: ' + doc.date + '&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;' + docNum + '</p>' +
                        '</div>' +
                        // Bill To
                        '<table style="width:100%;margin-bottom:24px;"><tr>' +
                            '<td style="vertical-align:top;">' +
                                '<p style="color:#222;font-size:14px;font-weight:700;text-transform:uppercase;margin:0 0 6px;">TO:</p>' +
                                '<p style="font-weight:600;color:#333;font-size:15px;margin:0;">' + doc.customerName + '</p>' +
                                (doc.customerEmail ? '<p style="color:#666;font-size:13px;margin:3px 0 0;">' + doc.customerEmail + '</p>' : '') +
                                (doc.customerPhone ? '<p style="color:#666;font-size:13px;margin:2px 0 0;">' + doc.customerPhone + '</p>' : '') +
                                (doc.customerAddress ? '<p style="color:#666;font-size:13px;margin:2px 0 0;">' + doc.customerAddress + '</p>' : '') +
                            '</td>' +
                            (doc.dueDate ? '<td style="vertical-align:top;text-align:right;"><p style="color:#999;font-size:12px;margin:0;">Due: <strong style="color:#333;">' + doc.dueDate + '</strong></p></td>' : '') +
                        '</tr></table>' +
                        // Items Table (K-DR Orange Style)
                        '<table style="width:100%;border-collapse:collapse;margin:20px 0;">' +
                            '<tr style="background:#ff6b35;">' +
                                '<th style="padding:14px 16px;text-align:left;font-size:13px;color:#fff;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">Item Description</th>' +
                                '<th style="padding:14px 12px;text-align:center;font-size:13px;color:#fff;font-weight:700;text-transform:uppercase;">Qty</th>' +
                                '<th style="padding:14px 12px;text-align:right;font-size:13px;color:#fff;font-weight:700;text-transform:uppercase;">Price</th>' +
                                '<th style="padding:14px 16px;text-align:right;font-size:13px;color:#fff;font-weight:700;text-transform:uppercase;">Amount</th>' +
                            '</tr>' +
                            itemsHtml +
                        '</table>' +
                        // Subtotal / Total Section
                        '<table style="width:100%;margin-top:10px;"><tr>' +
                            '<td style="width:50%;"></td>' +
                            '<td style="width:50%;">' +
                                '<table style="width:100%;border-collapse:collapse;">' +
                                    '<tr><td style="padding:8px 16px;color:#666;font-size:14px;text-align:left;font-weight:600;">SUBTOTAL =</td><td style="padding:8px 16px;color:#333;font-size:14px;text-align:right;">$' + doc.total + '</td></tr>' +
                                    '<tr><td style="padding:8px 16px;color:#666;font-size:14px;text-align:left;font-weight:600;">DISCOUNT =</td><td style="padding:8px 16px;color:#333;font-size:14px;text-align:right;">$0</td></tr>' +
                                    '<tr style="border-top:3px solid #ff6b35;"><td style="padding:12px 16px;color:#222;font-size:18px;text-align:left;font-weight:900;">TOTAL</td><td style="padding:12px 16px;color:#ff6b35;font-size:24px;text-align:right;font-weight:900;">$' + doc.total + '</td></tr>' +
                                '</table>' +
                            '</td>' +
                        '</tr></table>' +
                        (doc.notes ? '<div style="margin-top:20px;padding:16px;background:#f9f9f9;border-left:4px solid #ff6b35;border-radius:4px;"><p style="margin:0;font-size:13px;color:#555;"><strong>Notes:</strong> ' + doc.notes + '</p></div>' : '') +
                        (doc.terms ? '<div style="margin-top:16px;padding:16px;border:1px solid #eee;border-radius:4px;"><p style="font-size:12px;font-weight:700;color:#333;margin:0 0 6px;text-transform:uppercase;">Terms & Conditions</p><p style="font-size:11px;color:#888;margin:0;white-space:pre-wrap;">' + doc.terms + '</p></div>' : '') +
                        signLinkHtml +
                    '</div>' +
                    // Orange Footer (matching K-DR PDF style)
                    '<div style="background:#ff6b35;padding:24px 30px;">' +
                        '<table style="width:100%;"><tr>' +
                            '<td style="vertical-align:top;">' +
                                '<p style="margin:0;font-size:13px;color:#fff;font-weight:700;text-transform:uppercase;">Terms & Conditions</p>' +
                                (s.phone ? '<p style="margin:8px 0 0;font-size:14px;color:#fff;">üìû ' + s.phone + '</p>' : '') +
                            '</td>' +
                            '<td style="vertical-align:top;text-align:right;">' +
                                '<p style="margin:0;font-size:13px;color:#fff;font-weight:700;">CONTACT US AT</p>' +
                                (s.email ? '<p style="margin:4px 0 0;font-size:13px;color:#fff;">‚úâÔ∏è ' + s.email + '</p>' : '') +
                                socialIcons.map(function(icon) { return icon; }).join('') +
                            '</td>' +
                        '</tr></table>' +
                    '</div>' +
                '</div>';

                if (!confirm('Send this ' + docType.toLowerCase() + ' to ' + doc.customerEmail + '?')) return;

                var sendBtns = document.querySelectorAll('button');
                sendBtns.forEach(function(b) { if (b.textContent.indexOf('Send') >= 0) b.disabled = true; });

                emailjs.send(serviceId, templateId, {
                    to_email: doc.customerEmail,
                    to_name: doc.customerName,
                    from_name: bizName,
                    subject: docType + ' ' + docNum + ' from ' + bizName,
                    message: emailBody
                }, pubKey)
                .then(function() {
                    doc.sentDate = new Date().toISOString();
                    doc.status = doc.type === 'estimate' ? 'sent' : doc.status;
                    saveData();
                    renderDocuments();
                    checkNotifications();
                    alert(docType + ' sent to ' + doc.customerEmail + ' ‚úÖ');
                })
                .catch(function(err) {
                    console.error('EmailJS error:', err);
                    alert('Failed to send email.\n\nError: ' + (err.text || err.message || 'Unknown error'));
                })
                .finally(function() {
                    sendBtns.forEach(function(b) { b.disabled = false; });
                });
            }

            // For estimates: create public document for signing, then send
            if (doc.type === 'estimate') {
                var pubDoc = {
                    id: doc.id,
                    ownerId: currentUserId,
                    businessName: bizName,
                    businessEmail: s.email || '',
                    businessPhone: s.phone || '',
                    businessAddress: s.address || '',
                    businessLogo: s.logo || '',
                    customerName: doc.customerName,
                    customerEmail: doc.customerEmail,
                    customerPhone: doc.customerPhone || '',
                    customerAddress: doc.customerAddress || '',
                    date: doc.date,
                    lineItems: doc.lineItems,
                    total: doc.total,
                    notes: doc.notes || '',
                    terms: doc.terms || '',
                    status: 'sent',
                    signature: null,
                    signedBy: null,
                    signedDate: null
                };
                db.collection('public_estimates').doc(signToken).set(pubDoc)
                    .then(function() { buildAndSendEmail(); })
                    .catch(function(err) { console.error(err); buildAndSendEmail(); });
            } else {
                signLinkHtml = '';
                buildAndSendEmail();
            }
        }

        function deleteDocument(id, type) {
            if (!confirm('Delete this ' + type + '?')) return;
            
            if (type === 'estimate') {
                appData.estimates = appData.estimates.filter(function(e) { return e.id !== id; });
            } else {
                appData.invoices = appData.invoices.filter(function(i) { return i.id !== id; });
            }
            saveData();
            renderDocuments();
        }

        function viewInvoice(id) {
            var doc = appData.invoices.find(function(i) { return i.id === id; });
            if (!doc) return;

            var bizName = appData.settings.businessName || 'KDRSYSTEMS';
            var itemsHtml = doc.lineItems.map(function(item) {
                return '<tr>' +
                    '<td style="padding:10px;border-bottom:1px solid rgba(255,107,53,0.1);color:#ddd;">' + item.description + '</td>' +
                    '<td style="padding:10px;text-align:center;border-bottom:1px solid rgba(255,107,53,0.1);color:#ddd;">' + item.quantity + '</td>' +
                    '<td style="padding:10px;text-align:right;border-bottom:1px solid rgba(255,107,53,0.1);color:#ddd;">$' + item.rate + '</td>' +
                    '<td style="padding:10px;text-align:right;border-bottom:1px solid rgba(255,107,53,0.1);font-weight:bold;color:#ff8c42;">$' + item.amount + '</td>' +
                '</tr>';
            }).join('');

            var html = '' +
                '<div class="p-6">' +
                    '<div class="flex justify-between items-start mb-6">' +
                        '<div>' +
                            '<h2 class="text-2xl font-bold text-orange">' + bizName + '</h2>' +
                            (appData.settings.address ? '<p class="text-sm text-gray-400 mt-1" style="white-space:pre-wrap;">' + appData.settings.address + '</p>' : '') +
                            (appData.settings.phone ? '<p class="text-sm text-gray-400">' + appData.settings.phone + '</p>' : '') +
                            (appData.settings.email ? '<p class="text-sm text-gray-400">' + appData.settings.email + '</p>' : '') +
                        '</div>' +
                        '<div class="text-right">' +
                            '<h3 class="text-xl font-bold">INVOICE</h3>' +
                            '<p class="text-gray-400">#' + doc.id.slice(-6) + '</p>' +
                            '<p class="text-sm text-gray-500">Date: ' + doc.date + '</p>' +
                            (doc.dueDate ? '<p class="text-sm text-gray-500">Due: ' + doc.dueDate + '</p>' : '') +
                            '<span class="status-badge status-' + doc.status + ' mt-2 inline-block">' + doc.status + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="mb-4 p-3 rounded" style="background:rgba(255,107,53,0.05);border:1px solid rgba(255,107,53,0.15);">' +
                        '<p class="text-sm text-gray-400">Bill To:</p>' +
                        '<p class="font-semibold text-white">' + doc.customerName + '</p>' +
                        (doc.customerEmail ? '<p class="text-sm text-gray-400">' + doc.customerEmail + '</p>' : '') +
                    '</div>' +
                    '<table style="width:100%;border-collapse:collapse;margin:16px 0;">' +
                        '<tr style="background:rgba(255,107,53,0.1);">' +
                            '<th style="padding:10px;text-align:left;color:#ff8c42;font-size:13px;">Description</th>' +
                            '<th style="padding:10px;text-align:center;color:#ff8c42;font-size:13px;">Qty</th>' +
                            '<th style="padding:10px;text-align:right;color:#ff8c42;font-size:13px;">Rate</th>' +
                            '<th style="padding:10px;text-align:right;color:#ff8c42;font-size:13px;">Amount</th>' +
                        '</tr>' +
                        itemsHtml +
                    '</table>' +
                    '<div class="text-right mt-4 p-4 rounded" style="background:rgba(255,107,53,0.15);border:2px solid rgba(255,107,53,0.4);">' +
                        '<span class="text-gray-300 text-lg">Total: </span>' +
                        '<span class="text-3xl font-bold text-orange">$' + doc.total + '</span>' +
                    '</div>' +
                    (doc.notes ? '<div class="mt-4 p-3 rounded" style="background:rgba(0,0,0,0.2);"><p class="text-sm text-gray-400"><strong>Notes:</strong> ' + doc.notes + '</p></div>' : '') +
                    (doc.terms ? '<div class="mt-4 p-3 rounded border border-orange-500 border-opacity-20"><p class="text-xs font-semibold text-orange mb-1">Terms & Conditions:</p><p class="text-xs text-gray-500 whitespace-pre-wrap">' + doc.terms + '</p></div>' : '') +
                    '<div class="flex gap-3 mt-6 pt-4 border-t border-orange-500 border-opacity-20">' +
                        '<button class="btn-primary" onclick="sendDocument(\'' + doc.id + '\')">üìß Email to Customer</button>' +
                        (doc.status === 'unpaid' ? '<button class="btn-secondary" onclick="markInvoicePaid(\'' + doc.id + '\')">‚úÖ Mark as Paid</button>' : '') +
                        '<button class="btn-secondary" onclick="closeModal(\'invoiceViewModal\')">Close</button>' +
                    '</div>' +
                '</div>';

            document.getElementById('invoiceViewContent').innerHTML = html;
            openModal('invoiceViewModal');
        }

        function markInvoicePaid(id) {
            var invoice = appData.invoices.find(function(i) { return i.id === id; });
            if (invoice) {
                invoice.status = 'paid';
                invoice.paidDate = new Date().toISOString();
                saveData();
                renderDocuments();
                viewInvoice(id);
                alert('Invoice marked as paid! ‚úÖ');
            }
        }

        // View Estimate (read-only viewer)
        function viewEstimate(id) {
            var doc = appData.estimates.find(function(e) { return e.id === id; });
            if (!doc) return;

            var bizName = appData.settings.businessName || 'KDRSYSTEMS';
            var itemsHtml = doc.lineItems.map(function(item) {
                return '<tr>' +
                    '<td style="padding:10px;border-bottom:1px solid rgba(255,107,53,0.1);color:#ddd;">' + item.description + '</td>' +
                    '<td style="padding:10px;text-align:center;border-bottom:1px solid rgba(255,107,53,0.1);color:#ddd;">' + item.quantity + '</td>' +
                    '<td style="padding:10px;text-align:right;border-bottom:1px solid rgba(255,107,53,0.1);color:#ddd;">$' + item.rate + '</td>' +
                    '<td style="padding:10px;text-align:center;border-bottom:1px solid rgba(255,107,53,0.1);color:#ddd;">' + (item.markup || 0) + '%</td>' +
                    '<td style="padding:10px;text-align:right;border-bottom:1px solid rgba(255,107,53,0.1);font-weight:bold;color:#ff8c42;">$' + item.amount + '</td>' +
                '</tr>';
            }).join('');

            // Logo
            var logoHtml = '';
            if (appData.settings.logo) {
                logoHtml = '<img src="' + appData.settings.logo + '" alt="Logo" style="max-height:60px;border-radius:6px;margin-bottom:8px;">';
            }

            // Customer info
            var custHtml = '<p class="font-semibold text-white">' + doc.customerName + '</p>';
            if (doc.customerEmail) custHtml += '<p class="text-sm text-gray-400">' + doc.customerEmail + '</p>';
            if (doc.customerPhone) custHtml += '<p class="text-sm text-gray-400">' + doc.customerPhone + '</p>';
            if (doc.customerAddress) custHtml += '<p class="text-sm text-gray-400" style="white-space:pre-wrap;">' + doc.customerAddress + '</p>';

            // Signature display
            var sigHtml = '';
            if (doc.signature) {
                sigHtml = '<div class="mt-4 p-4 rounded" style="background:rgba(34,197,94,0.1);border:2px solid rgba(34,197,94,0.3);">' +
                    '<p class="text-sm font-semibold text-green-400 mb-2">‚úÖ Approved & Signed</p>' +
                    '<img src="' + doc.signature + '" alt="Signature" style="max-height:80px;background:white;border-radius:6px;padding:4px;">' +
                    '<p class="text-xs text-gray-400 mt-2">Signed by: ' + (doc.signedBy || 'Customer') + '</p>' +
                    '<p class="text-xs text-gray-500">Date: ' + (doc.signedDate || 'N/A') + '</p>' +
                '</div>';
            }

            var html = '' +
                '<div class="p-6">' +
                    '<div class="flex flex-wrap justify-between items-start mb-6 gap-4">' +
                        '<div>' +
                            logoHtml +
                            '<h2 class="text-2xl font-bold text-orange">' + bizName + '</h2>' +
                            (appData.settings.address ? '<p class="text-sm text-gray-400 mt-1" style="white-space:pre-wrap;">' + appData.settings.address + '</p>' : '') +
                            (appData.settings.phone ? '<p class="text-sm text-gray-400">' + appData.settings.phone + '</p>' : '') +
                            (appData.settings.email ? '<p class="text-sm text-gray-400">' + appData.settings.email + '</p>' : '') +
                        '</div>' +
                        '<div class="text-right">' +
                            '<h3 class="text-xl font-bold">ESTIMATE</h3>' +
                            '<p class="text-gray-400">#' + doc.id.slice(-6) + '</p>' +
                            '<p class="text-sm text-gray-500">Date: ' + doc.date + '</p>' +
                            '<span class="status-badge status-' + doc.status + ' mt-2 inline-block">' + doc.status + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="mb-4 p-3 rounded" style="background:rgba(255,107,53,0.05);border:1px solid rgba(255,107,53,0.15);">' +
                        '<p class="text-sm text-gray-400 mb-1">Customer:</p>' +
                        custHtml +
                    '</div>' +
                    '<div class="table-wrap">' +
                    '<table style="width:100%;border-collapse:collapse;margin:16px 0;">' +
                        '<tr style="background:rgba(255,107,53,0.1);">' +
                            '<th style="padding:10px;text-align:left;color:#ff8c42;font-size:13px;">Description</th>' +
                            '<th style="padding:10px;text-align:center;color:#ff8c42;font-size:13px;">Qty</th>' +
                            '<th style="padding:10px;text-align:right;color:#ff8c42;font-size:13px;">Rate</th>' +
                            '<th style="padding:10px;text-align:center;color:#ff8c42;font-size:13px;">Markup</th>' +
                            '<th style="padding:10px;text-align:right;color:#ff8c42;font-size:13px;">Amount</th>' +
                        '</tr>' +
                        itemsHtml +
                    '</table>' +
                    '</div>' +
                    '<div class="text-right mt-4 p-4 rounded" style="background:rgba(255,107,53,0.15);border:2px solid rgba(255,107,53,0.4);">' +
                        '<div class="flex justify-between items-center">' +
                            '<div class="text-left">' +
                                '<p class="text-sm text-green-400">Profit: $' + doc.profit + ' (' + doc.margin + ')</p>' +
                            '</div>' +
                            '<div>' +
                                '<span class="text-gray-300 text-lg">Total: </span>' +
                                '<span class="text-3xl font-bold text-orange">$' + doc.total + '</span>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    (doc.notes ? '<div class="mt-4 p-3 rounded" style="background:rgba(0,0,0,0.2);"><p class="text-sm text-gray-400"><strong>Notes:</strong> ' + doc.notes + '</p></div>' : '') +
                    (doc.terms ? '<div class="mt-4 p-3 rounded border border-orange-500 border-opacity-20"><p class="text-xs font-semibold text-orange mb-1">Terms & Conditions' + (doc.termsName ? ' (' + doc.termsName + ')' : '') + ':</p><p class="text-xs text-gray-500 whitespace-pre-wrap">' + doc.terms + '</p></div>' : '') +
                    sigHtml +
                    '<div class="flex flex-wrap gap-3 mt-6 pt-4 border-t border-orange-500 border-opacity-20">' +
                        (!doc.signature ? '<button class="btn-primary" onclick="openSignatureModal(\'' + doc.id + '\')">‚úçÔ∏è Approve & Sign</button>' : '') +
                        '<button class="btn-secondary" onclick="editDocument(\'' + doc.id + '\', \'estimate\'); closeModal(\'invoiceViewModal\');">‚úèÔ∏è Edit</button>' +
                        '<button class="btn-secondary" onclick="sendDocument(\'' + doc.id + '\')">üìß Send</button>' +
                        '<button class="btn-secondary" onclick="convertToInvoice(\'' + doc.id + '\'); closeModal(\'invoiceViewModal\');">üìÑ Convert to Invoice</button>' +
                        '<button class="btn-secondary" onclick="closeModal(\'invoiceViewModal\')">Close</button>' +
                    '</div>' +
                '</div>';

            document.getElementById('invoiceViewContent').innerHTML = html;
            openModal('invoiceViewModal');
        }

        // Signature Canvas
        var sigCanvas, sigCtx, sigDrawing = false;

        function openSignatureModal(estimateId) {
            document.getElementById('signEstimateId').value = estimateId;
            document.getElementById('signName').value = '';
            openModal('signatureModal');

            setTimeout(function() {
                sigCanvas = document.getElementById('signatureCanvas');
                sigCtx = sigCanvas.getContext('2d');
                sigCanvas.width = sigCanvas.offsetWidth;
                sigCanvas.height = 180;
                sigCtx.fillStyle = '#fff';
                sigCtx.fillRect(0, 0, sigCanvas.width, sigCanvas.height);
                sigCtx.strokeStyle = '#333';
                sigCtx.lineWidth = 2.5;
                sigCtx.lineCap = 'round';
                sigCtx.lineJoin = 'round';
                sigDrawing = false;

                // Mouse events
                sigCanvas.onmousedown = function(e) { startSigDraw(e.offsetX, e.offsetY); };
                sigCanvas.onmousemove = function(e) { if (sigDrawing) drawSig(e.offsetX, e.offsetY); };
                sigCanvas.onmouseup = function() { sigDrawing = false; };
                sigCanvas.onmouseleave = function() { sigDrawing = false; };

                // Touch events
                sigCanvas.ontouchstart = function(e) {
                    e.preventDefault();
                    var r = sigCanvas.getBoundingClientRect();
                    var t = e.touches[0];
                    startSigDraw(t.clientX - r.left, t.clientY - r.top);
                };
                sigCanvas.ontouchmove = function(e) {
                    e.preventDefault();
                    if (sigDrawing) {
                        var r = sigCanvas.getBoundingClientRect();
                        var t = e.touches[0];
                        drawSig(t.clientX - r.left, t.clientY - r.top);
                    }
                };
                sigCanvas.ontouchend = function() { sigDrawing = false; };
            }, 200);
        }

        function startSigDraw(x, y) {
            sigDrawing = true;
            sigCtx.beginPath();
            sigCtx.moveTo(x, y);
        }

        function drawSig(x, y) {
            sigCtx.lineTo(x, y);
            sigCtx.stroke();
        }

        function clearSignatureCanvas() {
            if (sigCanvas && sigCtx) {
                sigCtx.fillStyle = '#fff';
                sigCtx.fillRect(0, 0, sigCanvas.width, sigCanvas.height);
            }
        }

        function submitSignature() {
            var estId = document.getElementById('signEstimateId').value;
            var name = document.getElementById('signName').value.trim();
            if (!name) {
                alert('Please type your name.');
                return;
            }

            // Check if canvas has been drawn on
            var sigData = sigCanvas.toDataURL('image/png');

            var estimate = appData.estimates.find(function(e) { return e.id === estId; });
            if (estimate) {
                estimate.signature = sigData;
                estimate.signedBy = name;
                estimate.signedDate = new Date().toLocaleDateString();
                estimate.status = 'approved';
                saveData();
                renderDocuments();
                closeModal('signatureModal');
                viewEstimate(estId);
                alert('Estimate approved and signed! ‚úÖ');
            }
        }

        // Edit Document (estimates and invoices)
        function editDocument(id, type) {
            var doc;
            if (type === 'estimate') {
                doc = appData.estimates.find(function(e) { return e.id === id; });
            } else {
                doc = appData.invoices.find(function(i) { return i.id === id; });
            }
            if (!doc) return;

            document.getElementById('editDocId').value = doc.id;
            document.getElementById('editDocType').value = type;
            document.getElementById('editModalTitle').textContent = 'Edit ' + (type === 'estimate' ? 'Estimate' : 'Invoice') + ' #' + doc.id.slice(-6);
            document.getElementById('editDocCustomer').value = doc.customerName;
            document.getElementById('editDocDate').value = doc.date;
            document.getElementById('editDocNotes').value = doc.notes || '';
            document.getElementById('editDocTerms').value = doc.terms || '';

            // Build line items
            var container = document.getElementById('editLines');
            container.innerHTML = '';
            doc.lineItems.forEach(function(item) {
                addEditLine(item);
            });

            recalcEditTotal();
            openModal('docEditModal');
        }

        function addEditLine(item) {
            var container = document.getElementById('editLines');
            var row = document.createElement('div');
            row.className = 'p-3 rounded-lg space-y-2';
            row.style.background = 'rgba(255,107,53,0.05)';
            row.style.border = '1px solid rgba(255,107,53,0.15)';

            var descVal = item ? item.description.replace(/"/g, '&quot;') : '';
            var qtyVal = item ? item.quantity : '';
            var rateVal = item ? item.rate : '';
            var markupVal = item ? (item.markup || 0) : '0';

            row.innerHTML = '' +
                '<div class="flex justify-between items-center mb-2">' +
                    '<span class="text-xs text-gray-500 font-semibold">LINE ITEM</span>' +
                    '<button type="button" class="text-red-400 hover:text-red-300 text-sm font-bold" onclick="removeEditLine(this)" title="Remove line">‚úï Remove</button>' +
                '</div>' +
                '<div>' +
                    '<input type="text" class="edit-desc" placeholder="Description" value="' + descVal + '">' +
                '</div>' +
                '<div class="grid grid-cols-3 gap-2">' +
                    '<div>' +
                        '<label class="text-xs text-gray-500">Qty</label>' +
                        '<input type="number" class="edit-qty" placeholder="Qty" step="0.01" value="' + qtyVal + '" oninput="recalcEditTotal()">' +
                    '</div>' +
                    '<div>' +
                        '<label class="text-xs text-gray-500">Rate ($)</label>' +
                        '<input type="number" class="edit-rate" placeholder="Rate" step="0.01" value="' + rateVal + '" oninput="recalcEditTotal()">' +
                    '</div>' +
                    '<div>' +
                        '<label class="text-xs text-gray-500">Markup %</label>' +
                        '<input type="number" class="edit-markup" placeholder="0" step="0.01" value="' + markupVal + '" oninput="recalcEditTotal()">' +
                    '</div>' +
                '</div>' +
                '<div class="text-right">' +
                    '<span class="text-sm text-gray-400">Line total: </span>' +
                    '<span class="edit-line-total font-bold text-orange">$0.00</span>' +
                '</div>';

            container.appendChild(row);
            recalcEditTotal();
        }

        function removeEditLine(btn) {
            var row = btn.closest('.rounded-lg');
            if (document.getElementById('editLines').children.length <= 1) {
                alert('You need at least one line item.');
                return;
            }
            row.remove();
            recalcEditTotal();
        }

        function recalcEditTotal() {
            var total = 0;
            var rows = document.getElementById('editLines').children;
            for (var i = 0; i < rows.length; i++) {
                var qty = parseFloat(rows[i].querySelector('.edit-qty').value) || 0;
                var rate = parseFloat(rows[i].querySelector('.edit-rate').value) || 0;
                var markup = parseFloat(rows[i].querySelector('.edit-markup').value) || 0;
                var lineTotal = qty * rate * (1 + markup / 100);
                rows[i].querySelector('.edit-line-total').textContent = '$' + lineTotal.toFixed(2);
                total += lineTotal;
            }
            document.getElementById('editDocTotal').textContent = '$' + total.toFixed(2);
        }

        function saveDocEdit() {
            var id = document.getElementById('editDocId').value;
            var type = document.getElementById('editDocType').value;

            var doc;
            if (type === 'estimate') {
                doc = appData.estimates.find(function(e) { return e.id === id; });
            } else {
                doc = appData.invoices.find(function(i) { return i.id === id; });
            }
            if (!doc) return;

            doc.date = document.getElementById('editDocDate').value;
            doc.notes = document.getElementById('editDocNotes').value;
            doc.terms = document.getElementById('editDocTerms').value;

            var newLines = [];
            var total = 0;
            var costTotal = 0;
            var rows = document.getElementById('editLines').children;
            for (var i = 0; i < rows.length; i++) {
                var desc = rows[i].querySelector('.edit-desc').value;
                var qty = parseFloat(rows[i].querySelector('.edit-qty').value) || 0;
                var rate = parseFloat(rows[i].querySelector('.edit-rate').value) || 0;
                var markup = parseFloat(rows[i].querySelector('.edit-markup').value) || 0;
                var amount = (qty * rate * (1 + markup / 100)).toFixed(2);
                var baseCost = qty * rate;

                if (desc || qty || rate) {
                    newLines.push({
                        description: desc,
                        quantity: qty,
                        rate: rate,
                        markup: markup,
                        amount: amount
                    });
                    total += parseFloat(amount);
                    costTotal += baseCost;
                }
            }

            if (newLines.length === 0) {
                alert('Please add at least one line item.');
                return;
            }

            doc.lineItems = newLines;
            doc.total = total.toFixed(2);
            doc.profit = (total - costTotal).toFixed(2);
            doc.margin = costTotal > 0 ? ((total - costTotal) / total * 100).toFixed(1) + '%' : '0%';

            saveData();
            renderDocuments();
            closeModal('docEditModal');
            alert('Changes saved! ‚úÖ');
        }

        // Settings
        function populateSettings() {
            document.getElementById('settingsBusinessName').value = appData.settings.businessName || '';
            document.getElementById('settingsEmail').value = appData.settings.email || '';
            document.getElementById('settingsPhone').value = appData.settings.phone || '';
            document.getElementById('settingsAddress').value = appData.settings.address || '';
            document.getElementById('settingsInstagram').value = appData.settings.instagram || '';
            document.getElementById('settingsFacebook').value = appData.settings.facebook || '';
            document.getElementById('settingsTiktok').value = appData.settings.tiktok || '';
            document.getElementById('settingsGoogle').value = appData.settings.google || '';
            document.getElementById('settingsEmailjsPublicKey').value = appData.settings.emailjsPublicKey || '';
            document.getElementById('settingsEmailjsServiceId').value = appData.settings.emailjsServiceId || '';
            document.getElementById('settingsEmailjsTemplateId').value = appData.settings.emailjsTemplateId || '';
            document.getElementById('invoiceReminderEnabled').value = String(appData.settings.invoiceReminderEnabled !== false);
            document.getElementById('reminder1Days').value = appData.settings.reminder1Days || 7;
            document.getElementById('reminder2Days').value = appData.settings.reminder2Days || 7;
            document.getElementById('reminder3Days').value = appData.settings.reminder3Days || 14;
            document.getElementById('jobNotificationHours').value = appData.settings.jobNotificationHours || 24;
            
            if (appData.settings.businessName) {
                document.getElementById('headerBusinessSubtitle').textContent = appData.settings.businessName;
            }
            
            if (appData.settings.logo) {
                displayLogoPreview(appData.settings.logo);
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('logoDropZone').classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('logoDropZone').classList.remove('drag-over');
        }

        function handleLogoDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('logoDropZone').classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                processLogoFile(file);
            }
        }

        function handleLogoFile(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                processLogoFile(file);
            }
        }

        function processLogoFile(file) {
            if (file.size > 2 * 1024 * 1024) {
                alert('File size must be less than 2MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const logoData = e.target.result;
                appData.settings.logo = logoData;
                displayLogoPreview(logoData);
            };
            reader.readAsDataURL(file);
        }

        function displayLogoPreview(logoData) {
            const preview = document.getElementById('logoPreview');
            preview.innerHTML = 
                '<img src="' + logoData + '" alt="Logo Preview" class="max-h-32 mx-auto rounded border border-orange-500 border-opacity-30">' +
                '<button type="button" onclick="removeLogo()" class="btn-danger text-sm mt-2">Remove Logo</button>';
        }

        function removeLogo() {
            appData.settings.logo = '';
            document.getElementById('logoPreview').innerHTML = '';
        }

        function saveSettings() {
            appData.settings = {
                businessName: document.getElementById('settingsBusinessName').value,
                email: document.getElementById('settingsEmail').value,
                phone: document.getElementById('settingsPhone').value,
                address: document.getElementById('settingsAddress').value,
                logo: appData.settings.logo || '',
                instagram: document.getElementById('settingsInstagram').value,
                facebook: document.getElementById('settingsFacebook').value,
                tiktok: document.getElementById('settingsTiktok').value,
                google: document.getElementById('settingsGoogle').value,
                emailjsPublicKey: document.getElementById('settingsEmailjsPublicKey').value,
                emailjsServiceId: document.getElementById('settingsEmailjsServiceId').value,
                emailjsTemplateId: document.getElementById('settingsEmailjsTemplateId').value,
                invoiceReminderEnabled: document.getElementById('invoiceReminderEnabled').value === 'true',
                reminder1Days: parseInt(document.getElementById('reminder1Days').value) || 7,
                reminder2Days: parseInt(document.getElementById('reminder2Days').value) || 7,
                reminder3Days: parseInt(document.getElementById('reminder3Days').value) || 14,
                jobNotificationHours: parseInt(document.getElementById('jobNotificationHours').value) || 24
            };
            
            saveData();
            document.getElementById('headerBusinessSubtitle').textContent = appData.settings.businessName || 'Business Management System';
            alert('Settings saved!');
        }

        // Dashboard
        function updateDashboard() {
            document.getElementById('dashCustomers').textContent = appData.customers.length;
            document.getElementById('dashEstimates').textContent = appData.estimates.filter(function(e) { return e.status === 'pending' || e.status === 'sent'; }).length;
            
            const unpaid = appData.invoices.filter(function(i) { return i.status === 'unpaid'; }).reduce(function(sum, i) { return sum + parseFloat(i.total); }, 0);
            const paid = appData.invoices.filter(function(i) { return i.status === 'paid'; }).reduce(function(sum, i) { return sum + parseFloat(i.total); }, 0);
            
            document.getElementById('dashUnpaid').textContent = '$' + unpaid.toFixed(2);
            document.getElementById('dashRevenue').textContent = '$' + paid.toFixed(2);
            
            const teamCost = appData.teamMembers.reduce(function(sum, m) {
                const memberCost = (parseFloat(m.hourlyRate) || 0) * (parseFloat(m.hoursPerMonth) || 0);
                return sum + memberCost;
            }, 0);
            const expenses = appData.expenses.reduce(function(sum, e) { return sum + parseFloat(e.amount || 0); }, 0);
            const profit = appData.calculator.desiredProfit || 0;
            const revenue = teamCost + expenses + profit;
            
            document.getElementById('dashRevenueTarget').textContent = '$' + revenue.toFixed(2);
            document.getElementById('dashExpenses').textContent = '$' + expenses.toFixed(2);
            document.getElementById('dashTeamCosts').textContent = '$' + teamCost.toFixed(2);
            document.getElementById('dashProfit').textContent = '$' + profit.toFixed(2);
            
            const allDocs = appData.estimates.concat(appData.invoices).sort(function(a, b) { return b.id - a.id; }).slice(0, 5);
            const activityHTML = allDocs.map(function(doc) {
                return '<div class="flex justify-between items-center py-2 border-b border-orange-500 border-opacity-10">' +
                    '<div>' +
                        '<p class="font-medium">' + (doc.type === 'estimate' ? 'Estimate' : 'Invoice') + ' - ' + doc.customerName + '</p>' +
                        '<p class="text-xs text-gray-500">' + doc.date + '</p>' +
                    '</div>' +
                    '<span class="status-badge status-' + doc.status + '">' + doc.status + '</span>' +
                '</div>';
            }).join('');
            
            document.getElementById('recentActivity').innerHTML = activityHTML || '<p class="text-gray-500 text-sm">No recent activity</p>';
            
            updateNotificationBadge();
        }
    </script>
</body>
</html>
