<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ff6b35">
    <title>KDRSYSTEMS - Business Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        
        h1, h2, h3, h4, h5, h6, .logo-text {
            font-family: 'Inter', sans-serif;
            letter-spacing: -0.025em;
        }
        
        body {
            background: #f8f9fb;
            min-height: 100vh;
            color: #1a1a2e;
        }
        
        .gradient-orange {
            background: #ff6b35;
        }
        
        .gradient-orange-soft {
            background: #fef7f4;
        }
        
        .gradient-dark {
            background: #ffffff;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid #e8e8ec;
        }
        
        .card {
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid #e8e8ec;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
            transition: box-shadow 0.2s;
        }
        
        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #64748b;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        
        .nav-btn:hover {
            color: #ff6b35;
        }
        
        .nav-btn.active {
            color: #ff6b35;
            border-bottom-color: #ff6b35;
            font-weight: 600;
        }
        
        .nav-btn-side {
            padding: 10px 14px;
            background: transparent;
            border: none;
            color: #475569;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
            border-left: 2px solid transparent;
            border-radius: 6px;
            display: flex;
            align-items: center;
        }
        
        .nav-btn-side:hover {
            color: #ff6b35;
            background: #fef7f4;
        }
        
        .nav-btn-side.active {
            color: #ff6b35;
            border-left-color: #ff6b35;
            background: #fef7f4;
            font-weight: 600;
        }
        
        .btn-primary {
            background: #ff6b35;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .btn-primary:hover {
            background: #e85d2c;
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
        }
        
        .btn-secondary {
            background: #fff;
            color: #475569;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .btn-secondary:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            color: #1e293b;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        input, select, textarea {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 12px;
            width: 100%;
            color: #1e293b;
            font-size: 14px;
            transition: all 0.15s;
        }
        
        input::placeholder, textarea::placeholder {
            color: #94a3b8;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.2s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: #fff;
            border-radius: 16px;
            border: 1px solid #e8e8ec;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
        }
        
        .modal-content-small {
            max-width: 500px;
        }
        
        .stat-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e8e8ec;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        
        .stat-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pending { background: #fef9c3; color: #a16207; }
        .status-sent { background: #dbeafe; color: #1d4ed8; }
        .status-viewed { background: #fef3c7; color: #92400e; }
        .status-approved { background: #dcfce7; color: #15803d; }
        .status-paid { background: #dcfce7; color: #15803d; }
        .status-unpaid { background: #fee2e2; color: #b91c1c; }
        .status-scheduled { background: #f3e8ff; color: #7e22ce; }
        .status-completed { background: #dcfce7; color: #15803d; }
        
        .calc-section {
            background: #fef7f4;
            border: 1px solid #fed7c5;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .calc-section h3 {
            color: #ff6b35;
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .signature-canvas {
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            cursor: crosshair;
            background: #fff;
        }
        
        table {
            color: #1e293b;
            font-size: 14px;
        }
        
        table thead {
            background: #f8f9fb;
            border-bottom: 1px solid #e2e8f0;
        }
        
        table thead th {
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
        }
        
        table tbody tr {
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.1s;
        }
        
        table tbody tr:hover {
            background: #f8f9fb;
        }
        
        .summary-box {
            background: #fef7f4;
            border: 1px solid #fed7c5;
            border-radius: 12px;
            padding: 20px;
        }
        
        .summary-box h4 {
            color: #ff6b35;
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 14px;
        }
        
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        label {
            color: #374151;
            font-size: 13px;
            font-weight: 500;
        }
        
        h1, h2, h3, h4 {
            color: #0f172a;
        }
        
        .text-orange {
            color: #ff6b35;
        }
        
        .logo-text {
            color: #ff6b35;
            font-weight: 800;
            font-size: 22px;
            letter-spacing: -0.02em;
        }
        
        #logoDropZone {
            transition: all 0.2s;
        }
        
        #logoDropZone:hover {
            background: #fef7f4;
            border-color: #ff6b35;
        }
        
        #logoDropZone.drag-over {
            background: #fef7f4;
            border-color: #ff6b35;
            border-width: 2px;
        }
        
        .calendar-day {
            min-height: 100px;
            border: 1px solid #e8e8ec;
            padding: 8px;
            cursor: pointer;
            transition: all 0.15s;
            background: #fff;
            border-radius: 4px;
        }
        
        .calendar-day:hover {
            background: #fef7f4;
            border-color: #ff6b35;
        }
        
        .calendar-day.today {
            background: #fef7f4;
            border-color: #ff6b35;
            border-width: 2px;
        }
        
        .calendar-event {
            background: #ff6b35;
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-top: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .calendar-event:hover {
            background: #e85d2c;
        }
        
        .notification-badge {
            background: #ef4444;
            color: white;
            border-radius: 10px;
            padding: 1px 7px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 6px;
        }
        
        .notification-item {
            background: #fff;
            border: 1px solid #e8e8ec;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .notification-item:hover {
            background: #f8f9fb;
        }
        
        .notification-item.unread {
            border-left: 3px solid #ff6b35;
            background: #fef7f4;
        }

        /* Hamburger Button */
        .hamburger-btn {
            display: none;
            background: none;
            border: none;
            color: #ff6b35;
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
        }

        /* Sidebar overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15,23,42,0.5);
            z-index: 39;
        }
        .sidebar-overlay.show { display: block; }

        /* Table wrapper for horizontal scroll on mobile */
        .table-wrap {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* ---- TABLET (<= 1024px) ---- */
        @media (max-width: 1024px) {
            .hamburger-btn { display: block; }

            nav#sidebarNav {
                transform: translateX(-100%);
                transition: transform 0.25s ease;
                z-index: 45;
            }
            nav#sidebarNav.open {
                transform: translateX(0);
            }

            main.main-content {
                margin-left: 0 !important;
                padding: 16px !important;
            }

            .modal-content {
                max-width: 95vw;
                max-height: 95vh;
                margin: 10px;
            }

            #notificationsPanel {
                right: 10px;
                left: 10px;
                width: auto;
            }

            .stat-card { padding: 14px; }
            .stat-card .text-4xl { font-size: 1.5rem; }
        }

        /* ---- PHONE (<= 640px) ---- */
        @media (max-width: 640px) {
            header .max-w-7xl { padding-left: 12px; padding-right: 12px; }

            .logo-text { font-size: 18px !important; }

            #headerBusinessSubtitle { display: none; }

            .btn-primary, .btn-secondary { padding: 10px 14px; font-size: 13px; }

            main.main-content {
                padding: 12px !important;
            }

            h2.text-3xl { font-size: 1.25rem; }

            .card { padding: 14px; border-radius: 10px; }

            .grid.lg\\:grid-cols-4 { grid-template-columns: repeat(2, 1fr); }

            .modal { padding: 6px; }
            .modal-content {
                border-radius: 12px;
                max-height: 94vh;
            }

            input, select, textarea {
                padding: 12px 10px;
                font-size: 16px;
            }

            .nav-btn-side {
                padding: 14px;
                font-size: 14px;
            }

            .calendar-day { min-height: 60px; padding: 4px; }
            .calendar-event { font-size: 9px; padding: 2px 4px; }

            .stat-card .text-4xl { font-size: 1.2rem; }
            .stat-card p.text-sm { font-size: 11px; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center px-4" style="background: #f5f5f5;">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="logo-text text-4xl mb-2">KDRSYSTEMS</h1>
                <p class="text-gray-900">Business Management System</p>
            </div>
            <div class="card">
                <!-- Login Tab / Signup Tab -->
                <div class="flex mb-6 border-b border-gray-200">
                    <button id="loginTabBtn" class="flex-1 py-3 text-center font-semibold text-orange-400 border-b-2 border-orange-500 transition-all" onclick="showLoginTab('login')" style="color: #ff8c42; border-bottom-color: #ff8c42;">Log In</button>
                    <button id="signupTabBtn" class="flex-1 py-3 text-center font-semibold text-gray-700 border-b-2 border-transparent transition-all" onclick="showLoginTab('signup')">Sign Up</button>
                </div>

                <!-- Login Form -->
                <div id="loginForm" class="space-y-4">
                    <div>
                        <label class="block mb-2 text-sm">Email</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" autocomplete="username">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" autocomplete="current-password" onkeydown="if(event.key==='Enter') doLogin()">
                    </div>
                    <p id="loginError" class="text-red-600 text-sm hidden"></p>
                    <button class="btn-primary w-full text-lg" onclick="doLogin()">Log In</button>
                </div>

                <!-- Signup Form -->
                <div id="signupForm" class="space-y-4 hidden">
                    <div>
                        <label class="block mb-2 text-sm">Business Name</label>
                        <input type="text" id="signupBusiness" placeholder="Your business name">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm">Email</label>
                        <input type="email" id="signupEmail" placeholder="Enter your email" autocomplete="username">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm">Password</label>
                        <input type="password" id="signupPassword" placeholder="Create a password" autocomplete="new-password">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm">Confirm Password</label>
                        <input type="password" id="signupConfirm" placeholder="Confirm your password" autocomplete="new-password" onkeydown="if(event.key==='Enter') doSignup()">
                    </div>
                    <p id="signupError" class="text-red-600 text-sm hidden"></p>
                    <p id="signupSuccess" class="text-green-600 text-sm hidden"></p>
                    <button class="btn-primary w-full text-lg" onclick="doSignup()">Create Account</button>
                </div>
            </div>
            <p class="text-center text-gray-900 text-xs mt-6">Your data is securely stored and syncs across all your devices.</p>
        </div>
    </div>

    <!-- Public Signature Page (for customers signing from email) -->
    <div id="signaturePage" class="min-h-screen px-4 py-8" style="display:none; background: #f5f5f5;">
        <div class="max-w-2xl mx-auto">
            <div id="signPageContent">
                <div class="text-center py-12">
                    <div class="text-4xl mb-4"></div>
                    <p class="text-gray-900">Loading estimate...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until login) -->
    <div id="mainApp" class="min-h-screen" style="display: none;">
        <!-- Header -->
        <header class="sticky top-0 z-50" style="background:#fff;border-bottom:1px solid #e5e5e5;">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <button class="hamburger-btn" onclick="toggleSidebar()" aria-label="Menu">☰</button>
                        <h1 class="logo-text">KDRSYSTEMS</h1>
                        <p class="text-sm text-gray-700 ml-4" id="headerBusinessSubtitle">Business Management System</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="saveIndicator" class="text-xs hidden sm:inline"></span>
                        <button class="btn-secondary relative" onclick="toggleNotifications()">
                            <span class="hidden sm:inline">Notifications</span>
                            <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
                        </button>
                        <button class="btn-secondary" onclick="doLogout()" title="Log Out">
                            <span class="hidden sm:inline">Log Out</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Notifications Panel -->
        <div id="notificationsPanel" class="hidden fixed right-4 top-20 w-96 max-h-[500px] overflow-y-auto bg-white border border-gray-200 shadow-lg rounded-xl p-4 z-50 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-orange">Notifications</h3>
                <button onclick="clearAllNotifications()" class="text-xs text-gray-700 hover:text-orange">Clear All</button>
            </div>
            <div id="notificationsList"></div>
        </div>

        <!-- Navigation -->
        <div class="flex">
            <!-- Sidebar overlay for mobile -->
            <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

            <!-- Left Sidebar Navigation -->
            <nav id="sidebarNav" class="fixed left-0 top-[73px] bottom-0 w-64 overflow-y-auto z-40" style="background:#fff;border-right:1px solid #e5e5e5;">
                <div class="p-4 space-y-2">
                    <button class="nav-btn-side active w-full text-left" onclick="switchTab('dashboard', this)">
                        Dashboard
                    </button>
                    <button class="nav-btn-side w-full text-left" onclick="switchTab('customers', this)">
                        Customers
                    </button>
                    <button class="nav-btn-side w-full text-left" onclick="switchTab('schedule', this)">
                        Schedule
                    </button>
                    <button class="nav-btn-side w-full text-left" onclick="switchTab('estimates', this)">
                         Estimates & Invoices
                    </button>
                    <button class="nav-btn-side w-full text-left" onclick="switchTab('materials', this)">
                        Materials
                    </button>
                    <button class="nav-btn-side w-full text-left" onclick="switchTab('templates', this)">
                        Templates
                    </button>
                    <button class="nav-btn-side w-full text-left" onclick="switchTab('calculator', this)">
                        Profitability
                    </button>
                    <button class="nav-btn-side w-full text-left" onclick="switchTab('settings', this)">
                         Settings
                    </button>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main class="main-content flex-1 ml-64 p-8">
            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active">
                <h2 class="text-3xl font-bold mb-8">Dashboard Overview</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card">
                        <p class="text-sm text-gray-700 mb-2">Total Customers</p>
                        <p class="text-4xl font-bold text-gray-900" id="dashCustomers">0</p>
                    </div>
                    <div class="stat-card">
                        <p class="text-sm text-gray-700 mb-2">Active Estimates</p>
                        <p class="text-4xl font-bold text-orange" id="dashEstimates">0</p>
                    </div>
                    <div class="stat-card">
                        <p class="text-sm text-gray-700 mb-2">Unpaid Invoices</p>
                        <p class="text-4xl font-bold text-red-600" id="dashUnpaid">$0</p>
                    </div>
                    <div class="stat-card">
                        <p class="text-sm text-gray-700 mb-2">Total Revenue</p>
                        <p class="text-4xl font-bold text-green-600" id="dashRevenue">$0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="font-semibold text-xl mb-4">Recent Activity</h3>
                        <div id="recentActivity" class="space-y-3"></div>
                    </div>
                    <div class="card">
                        <h3 class="font-semibold text-xl mb-4">Monthly Summary</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-900">Revenue Target</span>
                                <span class="font-bold text-lg text-orange" id="dashRevenueTarget">$0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-900">Monthly Expenses</span>
                                <span class="font-bold text-lg" id="dashExpenses">$0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-900">Team Costs</span>
                                <span class="font-bold text-lg" id="dashTeamCosts">$0</span>
                            </div>
                            <div class="flex justify-between items-center pt-3 border-t border-gray-200">
                                <span class="text-gray-900">Target Profit</span>
                                <span class="font-bold text-xl text-green-600" id="dashProfit">$0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customers -->
            <div id="customers" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Customers</h2>
                    <button class="btn-primary" onclick="openModal('customerModal')">Add Customer</button>
                </div>
                
                <div class="card">
                    <div class="table-wrap">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th class="text-left py-3 px-4">Name</th>
                                <th class="text-left py-3 px-4">Email</th>
                                <th class="text-left py-3 px-4">Phone</th>
                                <th class="text-left py-3 px-4">Address</th>
                                <th class="text-right py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customersTable"></tbody>
                    </table>
                    </div>
                </div>
            </div>

            <!-- Schedule Calendar -->
            <div id="schedule" class="tab-content">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-3">
                    <h2 class="text-3xl font-bold">Schedule</h2>
                    <div class="flex flex-wrap gap-3">
                        <button class="btn-secondary" onclick="previousMonth()">← Prev</button>
                        <button class="btn-secondary" onclick="nextMonth()">Next →</button>
                        <button class="btn-primary" onclick="openModal('scheduleModal')">Schedule Job</button>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <h3 class="text-xl font-bold mb-2" id="calendarMonth">Month Year</h3>
                </div>
                
                <div class="card">
                    <div class="grid grid-cols-7 gap-2 mb-2">
                        <div class="text-center font-semibold text-orange py-2">Sun</div>
                        <div class="text-center font-semibold text-orange py-2">Mon</div>
                        <div class="text-center font-semibold text-orange py-2">Tue</div>
                        <div class="text-center font-semibold text-orange py-2">Wed</div>
                        <div class="text-center font-semibold text-orange py-2">Thu</div>
                        <div class="text-center font-semibold text-orange py-2">Fri</div>
                        <div class="text-center font-semibold text-orange py-2">Sat</div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
                </div>
            </div>

            <!-- Estimates & Invoices -->
            <div id="estimates" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Estimates & Invoices</h2>
                    <button class="btn-primary" onclick="openModal('estimateModal')">Create Estimate</button>
                </div>
                
                <div id="documentsList" class="space-y-4"></div>
            </div>

            <!-- Materials -->
            <div id="materials" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-bold mb-2">Materials Library</h2>
                        <p class="text-gray-700 text-sm">Organize and manage all your materials by category</p>
                    </div>
                    <button class="btn-primary" onclick="openAddMaterial()">Add Material</button>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2 text-gray-900">Filter by Category</label>
                    <select id="categoryFilter" onchange="filterMaterialsByCategory()" class="max-w-xs">
                        <option value="all">All Categories</option>
                    </select>
                </div>
                
                <div id="materialsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- Templates -->
            <div id="templates" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-bold mb-2">Material Templates</h2>
                        <p class="text-gray-700 text-sm">Create reusable material packages for common jobs</p>
                    </div>
                    <button class="btn-primary" onclick="openAddTemplate()">Create Template</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="templatesList"></div>
                    
                    <div class="card">
                        <h3 class="text-xl font-bold mb-4 text-orange">Terms & Conditions Templates</h3>
                        <div id="termsList" class="space-y-3 mb-4"></div>
                        <button class="btn-secondary w-full" onclick="openModal('termsModal')">Add Terms Template</button>
                    </div>
                </div>
            </div>

            <!-- Profitability -->
            <div id="calculator" class="tab-content">
                <h2 class="text-3xl font-bold mb-2">Profitability Calculator</h2>
                <p class="text-sm text-gray-700 mb-8">Your billing rate here auto-fills labor costs when creating estimates</p>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Team Members Section -->
                    <div class="card">
                        <div class="calc-section">
                            <h3>Team Members</h3>
                            <p class="text-xs text-gray-700 mb-3">What you PAY your team</p>
                            <div id="teamMembersList" class="space-y-3 mb-4"></div>
                            <button class="btn-secondary w-full" onclick="addTeamMember()">Add Team Member</button>
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="flex justify-between">
                                    <span class="text-gray-900">Total Team Cost/Month:</span>
                                    <span class="font-bold text-orange" id="totalTeamCost">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monthly Expenses Section -->
                    <div class="card">
                        <div class="calc-section">
                            <h3>Monthly Expenses</h3>
                            <p class="text-xs text-gray-700 mb-3">Rent, tools, insurance, etc.</p>
                            <div id="expensesList" class="space-y-3 mb-4"></div>
                            <button class="btn-secondary w-full" onclick="addExpense()">Add Expense</button>
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="flex justify-between">
                                    <span class="text-gray-900">Total Monthly Expenses:</span>
                                    <span class="font-bold text-orange" id="totalExpenses">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profit Margin Section -->
                    <div class="card">
                        <div class="calc-section">
                            <h3>Profit & Hours</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block mb-2">Desired Monthly Profit ($)</label>
                                    <input type="number" id="desiredProfit" placeholder="5000" step="0.01" 
                                        onchange="calculateAll()">
                                </div>
                                <div>
                                    <label class="block mb-2">OR Profit Margin (%)</label>
                                    <input type="number" id="profitMargin" placeholder="20" step="0.1" 
                                        onchange="calculateFromMargin()">
                                    <p class="text-xs text-gray-700 mt-1">% of total costs (team + expenses)</p>
                                </div>
                                <div>
                                    <label class="block mb-2">Working Hours/Month</label>
                                    <input type="number" id="workingHours" value="160" step="1" 
                                        onchange="calculateAll()">
                                    <p class="text-xs text-gray-700 mt-1">Default: 160 (40 hrs/week)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Rate Breakdown -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="summary-box">
                        <h4>Your Billing Rate Breakdown</h4>
                        <p class="text-xs text-gray-700 mb-3">Add all costs together to get your minimum hourly rate</p>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-900">Team Labor Cost/Hour:</span>
                                <span class="font-bold text-xl" id="teamCostPerHour">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-900">Monthly Expenses/Hour:</span>
                                <span class="font-bold text-xl" id="overheadPerHour">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-900">Profit/Hour:</span>
                                <span class="font-bold text-xl" id="profitPerHour">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t border-gray-200">
                                <span class="text-gray-900">Profit Margin:</span>
                                <span class="font-bold text-xl text-green-600" id="marginDisplay">0%</span>
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t-2 border-orange-500">
                                <span class="text-gray-900 font-semibold">YOUR BILLING RATE/HOUR:</span>
                                <span class="font-bold text-3xl text-orange" id="minimumRate">$0.00</span>
                            </div>
                            <p class="text-xs text-gray-700 text-center pt-2">Charge clients this rate to cover all costs + profit</p>
                        </div>
                    </div>
                    
                    <div class="summary-box">
                        <h4>Monthly Summary</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-900">Team Labor Costs:</span>
                                <span class="font-bold text-xl" id="summaryTeam">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-900">Monthly Expenses:</span>
                                <span class="font-bold text-xl" id="summaryExpenses">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t border-gray-200">
                                <span class="text-gray-900">Total Monthly Costs:</span>
                                <span class="font-bold text-xl" id="summaryTotalCosts">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-900">Target Profit:</span>
                                <span class="font-bold text-xl text-green-600" id="summaryProfit">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t-2 border-orange-500">
                                <span class="text-gray-900 font-semibold">Revenue Needed/Month:</span>
                                <span class="font-bold text-3xl text-orange" id="requiredRevenue">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="btn-primary w-full" onclick="saveCalculator()">Save Calculator Settings</button>
            </div>

            <!-- Settings -->
            <div id="settings" class="tab-content">
                <h2 class="text-3xl font-bold mb-6">Business Settings</h2>
                
                <div class="card max-w-3xl">
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block mb-2">Business Name</label>
                                <input type="text" id="settingsBusinessName" placeholder="Your Business Name">
                            </div>
                            <div>
                                <label class="block mb-2">Email</label>
                                <input type="email" id="settingsEmail" placeholder="business@example.com">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block mb-2">Phone</label>
                                <input type="tel" id="settingsPhone" placeholder="(555) 123-4567">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block mb-2">Business Logo</label>
                            <div id="logoDropZone" class="border-2 border-dashed border-gray-200 rounded-lg p-8 text-center cursor-pointer hover:border-opacity-60 transition-all"
                                ondragover="handleDragOver(event)" 
                                ondragleave="handleDragLeave(event)"
                                ondrop="handleLogoDrop(event)"
                                onclick="document.getElementById('logoInput').click()">
                                <div id="logoPreview" class="mb-4"></div>
                                <p class="text-gray-700 mb-2">Drag and drop your logo here or click to browse</p>
                                <p class="text-xs text-gray-900">PNG, JPG, SVG up to 2MB</p>
                                <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogoFile(event)">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block mb-2">Address</label>
                            <textarea id="settingsAddress" rows="2" placeholder="123 Main St..."></textarea>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-200">
                            <h4 class="text-lg font-semibold mb-4 text-orange">Social Media Links</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block mb-2">Instagram</label>
                                    <input type="text" id="settingsInstagram" placeholder="@yourbusiness">
                                </div>
                                <div>
                                    <label class="block mb-2">Facebook</label>
                                    <input type="text" id="settingsFacebook" placeholder="facebook.com/yourbusiness">
                                </div>
                                <div>
                                    <label class="block mb-2">TikTok</label>
                                    <input type="text" id="settingsTiktok" placeholder="@yourbusiness">
                                </div>
                                <div>
                                    <label class="block mb-2">Google Business</label>
                                    <input type="text" id="settingsGoogle" placeholder="g.page/yourbusiness">
                                </div>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-200">
                            <h4 class="text-lg font-semibold mb-4 text-orange">Invoice Reminder Settings</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block mb-2">Send Invoice Reminders</label>
                                    <select id="invoiceReminderEnabled" class="w-full">
                                        <option value="true">Yes, send automatic reminders</option>
                                        <option value="false">No, I'll send reminders manually</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block mb-2">First Reminder (days after sending)</label>
                                    <select id="reminder1Days" class="w-full">
                                        <option value="3">3 days</option>
                                        <option value="7" selected>7 days</option>
                                        <option value="14">14 days</option>
                                        <option value="30">30 days</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block mb-2">Second Reminder (days after first reminder)</label>
                                    <select id="reminder2Days" class="w-full">
                                        <option value="3">3 days</option>
                                        <option value="7" selected>7 days</option>
                                        <option value="14">14 days</option>
                                        <option value="30">30 days</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block mb-2">Final Reminder (days after second reminder)</label>
                                    <select id="reminder3Days" class="w-full">
                                        <option value="3">3 days</option>
                                        <option value="7">7 days</option>
                                        <option value="14" selected>14 days</option>
                                        <option value="30">30 days</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-200">
                            <h4 class="text-lg font-semibold mb-4 text-orange">Job Notification Settings</h4>
                            <div>
                                <label class="block mb-2">Notify Me Before Job (hours)</label>
                                <select id="jobNotificationHours" class="w-full">
                                    <option value="24" selected>24 hours before</option>
                                    <option value="48">48 hours before</option>
                                    <option value="72">72 hours before (3 days)</option>
                                    <option value="168">1 week before</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-200">
                            <h4 class="text-lg font-semibold mb-4 text-orange">Email Settings (EmailJS)</h4>
                            <p class="text-xs text-gray-700 mb-4">Set up EmailJS to send invoices and estimates directly to customer emails. Free for up to 200 emails/month. <a href="https://www.emailjs.com" target="_blank" class="text-orange underline">Get your keys at emailjs.com</a></p>
                            <div class="space-y-4">
                                <div>
                                    <label class="block mb-2">EmailJS Public Key</label>
                                    <input type="text" id="settingsEmailjsPublicKey" placeholder="Paste your Public Key here">
                                </div>
                                <div>
                                    <label class="block mb-2">EmailJS Service ID</label>
                                    <input type="text" id="settingsEmailjsServiceId" placeholder="e.g. service_abc123">
                                </div>
                                <div>
                                    <label class="block mb-2">EmailJS Template ID</label>
                                    <input type="text" id="settingsEmailjsTemplateId" placeholder="e.g. template_xyz789">
                                </div>
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <p class="text-xs text-gray-700 font-semibold mb-2">Quick Setup Guide:</p>
                                    <p class="text-xs text-gray-900">1. Go to <a href="https://www.emailjs.com" target="_blank" class="text-orange underline">emailjs.com</a> → Sign up (free)</p>
                                    <p class="text-xs text-gray-900">2. Add an Email Service (Gmail, Outlook, etc.)</p>
                                    <p class="text-xs text-gray-900">3. Create a Template with these variables: <span class="text-orange">{{to_email}}</span>, <span class="text-orange">{{to_name}}</span>, <span class="text-orange">{{from_name}}</span>, <span class="text-orange">{{subject}}</span>, <span class="text-orange">{{message}}</span></p>
                                    <p class="text-xs text-gray-900">4. Copy your Public Key, Service ID, and Template ID above</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-200">
                            <h4 class="text-lg font-semibold mb-4 text-orange">Data Backup & Restore</h4>
                            <p class="text-xs text-gray-700 mb-4">Keep your data safe by downloading a backup. You can restore it on any device.</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <button class="btn-primary w-full" onclick="downloadBackup()">Download Backup</button>
                                <div>
                                    <label class="btn-secondary w-full block text-center cursor-pointer">
                                        Restore from Backup
                                        <input type="file" accept=".json" class="hidden" onchange="restoreBackup(event)">
                                    </label>
                                </div>
                            </div>
                            <p class="text-xs text-gray-700 mt-3">Backup includes all customers, estimates, invoices, materials, settings, and more.</p>
                        </div>
                        
                        <button class="btn-primary w-full" onclick="saveSettings()">Save Settings</button>
                    </div>
                </div>
            </div>
            </main>
        </div>

    <!-- Modals -->
    <div id="customerModal" class="modal">
        <div class="modal-content modal-content-small">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-2xl font-bold">Add Customer</h3>
            </div>
            <div class="p-6">
                <form id="customerForm" class="space-y-4">
                    <input type="text" id="custName" placeholder="Customer Name" required>
                    <input type="email" id="custEmail" placeholder="Email">
                    <input type="tel" id="custPhone" placeholder="Phone">
                    <textarea id="custAddress" rows="2" placeholder="Address"></textarea>
                    <div class="flex gap-3">
                        <button type="submit" class="btn-primary flex-1">Add Customer</button>
                        <button type="button" class="btn-secondary flex-1" onclick="closeModal('customerModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="scheduleModal" class="modal">
        <div class="modal-content modal-content-small">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-2xl font-bold">Schedule Job</h3>
            </div>
            <div class="p-6">
                <form id="scheduleForm" class="space-y-4">
                    <div>
                        <label class="block mb-2">Customer</label>
                        <select id="schedCustomer" required></select>
                    </div>
                    <div>
                        <label class="block mb-2">Job Title</label>
                        <input type="text" id="schedTitle" placeholder="e.g., Kitchen Renovation" required>
                    </div>
                    <div>
                        <label class="block mb-2">Date</label>
                        <input type="date" id="schedDate" required>
                    </div>
                    <div>
                        <label class="block mb-2">Time</label>
                        <input type="time" id="schedTime" value="09:00" required>
                    </div>
                    <div>
                        <label class="block mb-2">Duration (hours)</label>
                        <input type="number" id="schedDuration" value="4" step="0.5" min="0.5" required>
                    </div>
                    <div>
                        <label class="block mb-2">Notes</label>
                        <textarea id="schedNotes" rows="3" placeholder="Job details, location notes, etc."></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button type="submit" class="btn-primary flex-1">Schedule Job</button>
                        <button type="button" class="btn-secondary flex-1" onclick="closeModal('scheduleModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="estimateModal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-2xl font-bold">Create Estimate</h3>
            </div>
            <div class="p-6">
                <form id="estimateForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <select id="estCustomer" required>
                            <option value="">Select Customer</option>
                        </select>
                        <input type="date" id="estDate" required>
                    </div>
                    
                    <div>
                        <label class="block mb-2">Select Material Template (Optional)</label>
                        <select id="estTemplate" onchange="applyTemplate()">
                            <option value="">No Template</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block mb-2">Select Terms & Conditions (Optional)</label>
                        <select id="estTerms">
                            <option value="">No Terms</option>
                        </select>
                    </div>
                    
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold text-orange">Line Items</h4>
                            <button type="button" class="btn-secondary text-sm" onclick="addEstimateLine()">Add Line</button>
                        </div>
                        <div class="text-xs text-gray-700 mb-2 grid grid-cols-12 gap-2 px-1">
                            <span class="col-span-5">Description</span>
                            <span class="col-span-2">Qty</span>
                            <span class="col-span-2">Rate</span>
                            <span class="col-span-2">Markup %</span>
                            <span class="col-span-1"></span>
                        </div>
                        <div id="estimateLines" class="space-y-2"></div>
                    </div>
                    
                    <!-- Labor Section linked to Profitability -->
                    <div class="border border-gray-200 rounded-lg p-4" style="background:#fff5f0;">
                        <h4 class="font-semibold text-orange mb-3">Labor</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block mb-1 text-xs">Hours</label>
                                <input type="number" id="estLaborHours" placeholder="0" step="0.5" value="" onchange="calculateEstimate()">
                            </div>
                            <div>
                                <label class="block mb-1 text-xs">Rate/Hr</label>
                                <input type="number" id="estLaborRate" placeholder="0" step="0.01" value="" onchange="calculateEstimate()">
                                <p class="text-xs text-gray-700 mt-1" id="estLaborRateHint">From Profitability tab</p>
                            </div>
                            <div>
                                <label class="block mb-1 text-xs">Labor Total</label>
                                <p class="font-bold text-lg text-orange mt-2" id="estLaborTotal">$0.00</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-box">
                        <h4>Estimate Summary</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Materials:</span>
                                <span class="font-semibold" id="estSubtotal">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Labor:</span>
                                <span class="font-semibold" id="estLaborCost">$0.00</span>
                            </div>
                            <div class="flex justify-between text-lg pt-2 border-t border-orange-500">
                                <span>Total:</span>
                                <span class="font-bold" id="estTotal">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-600">Profit:</span>
                                <span class="font-semibold text-green-600" id="estProfit">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Margin:</span>
                                <span class="font-semibold" id="estMargin">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <textarea id="estNotes" rows="3" placeholder="Notes / Terms"></textarea>
                    
                    <div>
                        <label class="block mb-2">Property / Job Photos (optional)</label>
                        <div id="estPhotosPreview" class="flex flex-wrap gap-2 mb-2"></div>
                        <label class="btn-secondary text-sm cursor-pointer inline-block">
                            Add Photos
                            <input type="file" accept="image/*" multiple class="hidden" onchange="handleEstPhotos(event)">
                        </label>
                        <p class="text-xs text-gray-700 mt-1">Upload up to 5 photos of the property or job site</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button type="submit" class="btn-primary flex-1">Create Estimate</button>
                        <button type="button" class="btn-secondary flex-1" onclick="closeModal('estimateModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="materialModal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-2xl font-bold" id="materialModalTitle">Add Material</h3>
            </div>
            <div class="p-6">
                <form id="materialForm" class="space-y-4">
                    <input type="hidden" id="matEditId" value="">
                    <div>
                        <label class="block mb-2">Material Name</label>
                        <input type="text" id="matName" placeholder="e.g., 2x4 Lumber, Concrete Mix, Paint" required>
                    </div>
                    <div>
                        <label class="block mb-2">Category</label>
                        <div class="flex gap-2">
                            <select id="matCategory" class="flex-1">
                                <option value="">Select or create category</option>
                            </select>
                            <button type="button" class="btn-secondary" onclick="toggleNewCategory()">New</button>
                        </div>
                        <input type="text" id="matNewCategory" placeholder="New category name" class="mt-2 hidden">
                    </div>
                    <div>
                        <label class="block mb-2">Description</label>
                        <textarea id="matDescription" rows="2" placeholder="Optional details about this material"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2">Cost</label>
                            <input type="number" id="matCost" placeholder="0.00" step="0.01" required>
                        </div>
                        <div>
                            <label class="block mb-2">Unit</label>
                            <input type="text" id="matUnit" placeholder="sqft, lbs, each, etc">
                        </div>
                    </div>
                    <div>
                        <label class="block mb-2">Default Markup %</label>
                        <input type="number" id="matMarkup" placeholder="20" step="0.01">
                    </div>
                    <div>
                        <label class="block mb-2">Material Photo (optional)</label>
                        <div id="matPhotoPreview" class="hidden mb-2">
                            <img id="matPhotoImg" src="" alt="Preview" style="max-height:120px;border-radius:8px;border:2px solid #e5e5e5;">
                            <button type="button" class="text-red-600 text-xs ml-2" onclick="clearMatPhoto()">Remove</button>
                        </div>
                        <label class="btn-secondary text-sm cursor-pointer inline-block">
                            Upload Photo
                            <input type="file" accept="image/*" class="hidden" onchange="handleMatPhoto(event)">
                        </label>
                    </div>
                    <div class="flex gap-3">
                        <button type="submit" class="btn-primary flex-1" id="matSubmitBtn">Save Material</button>
                        <button type="button" class="btn-secondary flex-1" onclick="closeModal('materialModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-2xl font-bold" id="templateModalTitle">Create Material Template</h3>
            </div>
            <div class="p-6">
                <form id="templateForm" class="space-y-4">
                    <input type="hidden" id="tempEditId" value="">
                    <input type="text" id="tempName" placeholder="Template Name (e.g. Vinyl Fence 6ft)" required>
                    <textarea id="tempDescription" rows="2" placeholder="Description customer will see (e.g. 6ft white vinyl privacy fence installation)"></textarea>
                    
                    <div>
                        <label class="block mb-2">Select Materials</label>
                        <div id="templateMaterialsList" class="border border-gray-200 rounded-lg p-4 max-h-60 overflow-y-auto space-y-2">
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button type="submit" class="btn-primary flex-1" id="tempSubmitBtn">Save Template</button>
                        <button type="button" class="btn-secondary flex-1" onclick="closeModal('templateModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="invoiceViewModal" class="modal">
        <div class="modal-content">
            <div id="invoiceViewContent"></div>
        </div>
    </div>

    <div id="docEditModal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold" id="editModalTitle">Edit Document</h3>
                    <button class="text-gray-700 hover:text-gray-900 text-2xl" onclick="closeModal('docEditModal')">&times;</button>
                </div>
            </div>
            <div class="p-6">
                <input type="hidden" id="editDocId">
                <input type="hidden" id="editDocType">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block mb-2">Customer</label>
                        <input type="text" id="editDocCustomer" disabled class="opacity-60">
                    </div>
                    <div>
                        <label class="block mb-2">Date</label>
                        <input type="date" id="editDocDate">
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <label class="font-semibold text-orange">Line Items</label>
                        <button class="btn-secondary text-sm" onclick="addEditLine()">+ Add Line</button>
                    </div>
                    <div id="editLines" class="space-y-3"></div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center p-4 rounded-lg" style="background:#ffede3;border:2px solid #ff6b35;">
                        <span class="text-gray-900 font-semibold text-lg">Total:</span>
                        <span class="text-3xl font-bold text-orange" id="editDocTotal">$0.00</span>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block mb-2">Notes</label>
                    <textarea id="editDocNotes" rows="3" placeholder="Notes..."></textarea>
                </div>

                <div class="mb-4">
                    <label class="block mb-2">Terms & Conditions</label>
                    <textarea id="editDocTerms" rows="4" placeholder="Terms..."></textarea>
                </div>

                <div class="mb-4">
                    <label class="block mb-2">Photos</label>
                    <div id="editPhotosPreview" class="flex flex-wrap gap-2 mb-2"></div>
                    <label class="btn-secondary text-sm cursor-pointer inline-block">
                        Add Photos
                        <input type="file" accept="image/*" multiple class="hidden" onchange="handleEditPhotos(event)">
                    </label>
                </div>

                <div class="flex gap-3">
                    <button class="btn-primary flex-1" onclick="saveDocEdit()">Save Changes</button>
                    <button class="btn-secondary flex-1" onclick="closeModal('docEditModal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="signatureModal" class="modal">
        <div class="modal-content modal-content-small">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-2xl font-bold">Approve Estimate</h3>
                <p class="text-sm text-gray-700 mt-1">Sign below to approve this estimate</p>
            </div>
            <div class="p-6">
                <input type="hidden" id="signEstimateId">
                <div class="mb-4">
                    <label class="block mb-2">Your Name</label>
                    <input type="text" id="signName" placeholder="Type your full name">
                </div>
                <div class="mb-4">
                    <label class="block mb-2">Signature (draw below)</label>
                    <canvas id="signatureCanvas" class="signature-canvas w-full" width="450" height="180" style="touch-action:none;"></canvas>
                </div>
                <div class="flex gap-3 mb-4">
                    <button class="btn-secondary flex-1" onclick="clearSignatureCanvas()">Clear Signature</button>
                </div>
                <div class="flex gap-3">
                    <button class="btn-primary flex-1" onclick="submitSignature()">Approve & Sign</button>
                    <button class="btn-secondary flex-1" onclick="closeModal('signatureModal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="termsModal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-2xl font-bold">Create Terms & Conditions Template</h3>
            </div>
            <div class="p-6">
                <form id="termsForm" class="space-y-4">
                    <div>
                        <label class="block mb-2">Template Name</label>
                        <input type="text" id="termsName" placeholder="e.g., Standard Terms, Net 30, etc." required>
                    </div>
                    <div>
                        <label class="block mb-2">Terms & Conditions</label>
                        <textarea id="termsContent" rows="10" placeholder="Enter your terms and conditions here..." required></textarea>
                        <p class="text-xs text-gray-700 mt-1">These will appear at the bottom of estimates and invoices</p>
                    </div>
                    <div class="flex gap-3">
                        <button type="submit" class="btn-primary flex-1">Create Template</button>
                        <button type="button" class="btn-secondary flex-1" onclick="closeModal('termsModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div> <!-- end mainApp -->

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <script>
        // =============================================
        // FIREBASE CONFIG — PASTE YOUR CONFIG HERE
        // =============================================
        // Follow the setup guide to get these values from your Firebase Console
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase (with error handling)
        var auth, db;
        try {
            if (typeof firebase === 'undefined') throw new Error('Firebase SDK not loaded. Check your internet connection.');
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        } catch(e) {
            console.error('Firebase init error:', e);
            document.addEventListener('DOMContentLoaded', function() {
                var login = document.getElementById('loginScreen');
                if (login) login.innerHTML = '<div style="text-align:center;padding:40px;max-width:500px;margin:0 auto;"><h2 style="color:#ff6b35;font-size:24px;font-weight:700;margin-bottom:16px;">Connection Error</h2><p style="color:#333;font-size:15px;margin-bottom:12px;">' + e.message + '</p><p style="color:#555;font-size:13px;">Make sure your Firebase config is set up and you have internet access.</p><button onclick="location.reload()" style="margin-top:20px;padding:12px 32px;background:#ff6b35;color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;">Retry</button></div>';
            });
        }

        // Track save debounce
        let saveTimeout = null;
        let currentUserId = null;

        // =============================================
        // AUTH SYSTEM (Firebase)
        // =============================================
        function showLoginTab(tab) {
            var loginForm = document.getElementById('loginForm');
            var signupForm = document.getElementById('signupForm');
            var loginTabBtn = document.getElementById('loginTabBtn');
            var signupTabBtn = document.getElementById('signupTabBtn');
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('signupError').classList.add('hidden');
            document.getElementById('signupSuccess').classList.add('hidden');
            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                loginTabBtn.style.color = '#ff8c42';
                loginTabBtn.style.borderBottomColor = '#ff8c42';
                signupTabBtn.style.color = '#6b7280';
                signupTabBtn.style.borderBottomColor = 'transparent';
            } else {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                signupTabBtn.style.color = '#ff8c42';
                signupTabBtn.style.borderBottomColor = '#ff8c42';
                loginTabBtn.style.color = '#6b7280';
                loginTabBtn.style.borderBottomColor = 'transparent';
            }
        }

        function doSignup() {
            if (!auth || !db) { alert('Still connecting to server. Please wait a moment and try again.'); return; }
            var business = document.getElementById('signupBusiness').value.trim();
            var email = document.getElementById('signupEmail').value.trim();
            var password = document.getElementById('signupPassword').value;
            var confirmPw = document.getElementById('signupConfirm').value;
            var errEl = document.getElementById('signupError');
            var successEl = document.getElementById('signupSuccess');
            errEl.classList.add('hidden');
            successEl.classList.add('hidden');

            if (!email || !password) {
                errEl.textContent = 'Email and password are required.';
                errEl.classList.remove('hidden');
                return;
            }
            if (password.length < 6) {
                errEl.textContent = 'Password must be at least 6 characters.';
                errEl.classList.remove('hidden');
                return;
            }
            if (password !== confirmPw) {
                errEl.textContent = 'Passwords do not match.';
                errEl.classList.remove('hidden');
                return;
            }

            // Disable button
            var btn = document.querySelector('#signupForm .btn-primary');
            btn.textContent = 'Creating Account...';
            btn.disabled = true;

            auth.createUserWithEmailAndPassword(email, password)
                .then(function(userCredential) {
                    // Save initial business name to Firestore
                    var uid = userCredential.user.uid;
                    var initialData = JSON.parse(JSON.stringify(appData));
                    initialData.settings.businessName = business;
                    initialData.settings.email = email;
                    return db.collection('users').doc(uid).set({ appData: initialData });
                })
                .then(function() {
                    successEl.textContent = 'Account created! Logging you in...';
                    successEl.classList.remove('hidden');
                    document.getElementById('signupBusiness').value = '';
                    document.getElementById('signupEmail').value = '';
                    document.getElementById('signupPassword').value = '';
                    document.getElementById('signupConfirm').value = '';
                })
                .catch(function(error) {
                    var msg = error.message;
                    if (error.code === 'auth/email-already-in-use') msg = 'An account with that email already exists.';
                    if (error.code === 'auth/invalid-email') msg = 'Please enter a valid email address.';
                    if (error.code === 'auth/weak-password') msg = 'Password must be at least 6 characters.';
                    errEl.textContent = msg;
                    errEl.classList.remove('hidden');
                })
                .finally(function() {
                    btn.textContent = 'Create Account';
                    btn.disabled = false;
                });
        }

        function doLogin() {
            if (!auth || !db) { alert('Still connecting to server. Please wait a moment and try again.'); return; }
            var email = document.getElementById('loginEmail').value.trim();
            var password = document.getElementById('loginPassword').value;
            var errEl = document.getElementById('loginError');
            errEl.classList.add('hidden');

            if (!email || !password) {
                errEl.textContent = 'Please enter your email and password.';
                errEl.classList.remove('hidden');
                return;
            }

            // Disable button
            var btn = document.querySelector('#loginForm .btn-primary');
            btn.textContent = 'Logging in...';
            btn.disabled = true;

            auth.signInWithEmailAndPassword(email, password)
                .then(function() {
                    // onAuthStateChanged will handle the rest
                })
                .catch(function(error) {
                    var msg = error.message;
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        msg = 'Invalid email or password.';
                    }
                    if (error.code === 'auth/invalid-email') msg = 'Please enter a valid email address.';
                    if (error.code === 'auth/too-many-requests') msg = 'Too many attempts. Please wait a moment and try again.';
                    errEl.textContent = msg;
                    errEl.classList.remove('hidden');
                })
                .finally(function() {
                    btn.textContent = 'Log In';
                    btn.disabled = false;
                });
        }

        function doLogout() {
            if (!confirm('Are you sure you want to log out?')) return;
            // Force save before logout
            if (currentUserId) {
                try { localStorage.setItem('kdrsystems_cache_' + currentUserId, JSON.stringify(appData)); } catch(e) {}
                if (db) db.collection('users').doc(currentUserId).set({ appData: appData }, { merge: true }).catch(function(){});
            }
            if (auth) {
                auth.signOut().then(function() {
                    currentUserId = null;
                    dataLoaded = false;
                    document.getElementById('mainApp').style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginPassword').value = '';
                });
            }
        }

        function enterApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadData();
        }

        function initApp() {
            renderTeamMembers();
            renderExpenses();
            calculateAll();
            updateDashboard();
            addEstimateLine();
            renderCalendar();
            checkNotifications();
            setInterval(checkNotifications, 5 * 60 * 1000);
            updateCalculatorViewButtons();
            
            // Background sync every 30 seconds to catch customer views and signatures
            setInterval(function() {
                if (!currentUserId) return;
                var changed = false;
                var promises = [];
                
                // Check each sent estimate's public_estimates doc for signature/view updates
                appData.estimates.forEach(function(est) {
                    if (est.signToken && est.status !== 'approved') {
                        var p = db.collection('public_estimates').doc(est.signToken).get().then(function(doc) {
                            if (!doc.exists) return;
                            var pub = doc.data();
                            
                            // Customer signed
                            if (pub.signature && !est.signature) {
                                est.signature = pub.signature;
                                est.signedBy = pub.signedBy;
                                est.signedDate = pub.signedDate;
                                est.status = 'approved';
                                if (!est.activity) est.activity = [];
                                est.activity.push({ action: 'Customer signed and approved', date: pub.signedAt || new Date().toISOString() });
                                changed = true;
                            }
                            
                            // Customer viewed
                            if (pub.lastViewed && est.status === 'sent') {
                                est.status = 'viewed';
                                est.lastViewed = pub.lastViewed;
                                if (!est.activity) est.activity = [];
                                var alreadyLogged = est.activity.find(function(a) { return a.action === 'Customer viewed estimate'; });
                                if (!alreadyLogged) {
                                    est.activity.push({ action: 'Customer viewed estimate', date: pub.lastViewed });
                                    changed = true;
                                }
                            }
                        }).catch(function(){});
                        promises.push(p);
                    }
                });
                
                Promise.all(promises).then(function() {
                    if (changed) {
                        saveData();
                        checkNotifications();
                        renderDocuments();
                        updateDashboard();
                    }
                });
            }, 30000);
        }

        // Global Data
        let appData = {
            customers: [],
            estimates: [],
            invoices: [],
            materials: [],
            templates: [],
            terms: [],
            teamMembers: [],
            expenses: [],
            scheduledJobs: [],
            notifications: [],
            calculator: {
                desiredProfit: 0,
                workingHours: 160,
                hourlyRate: 0,
                view: 'monthly'
            },
            settings: {
                businessName: '',
                email: '',
                phone: '',
                address: '',
                logo: '',
                instagram: '',
                facebook: '',
                tiktok: '',
                google: '',
                emailjsPublicKey: '',
                emailjsServiceId: '',
                emailjsTemplateId: '',
                invoiceReminderEnabled: true,
                reminder1Days: 7,
                reminder2Days: 7,
                reminder3Days: 14,
                jobNotificationHours: 24
            }
        };

        let currentCalendarDate = new Date();

        // =============================================
        // CHECK FOR PUBLIC SIGNATURE PAGE FIRST
        // =============================================
        var urlParams = new URLSearchParams(window.location.search);
        var signToken = urlParams.get('sign');

        if (signToken) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('signaturePage').style.display = 'block';
            if (typeof db !== 'undefined' && db) {
                loadPublicEstimate(signToken);
            } else {
                document.getElementById('signPageContent').innerHTML = '<div style="text-align:center;padding:60px 20px;"><p style="color:#333;">Loading...</p></div>';
                var retryCount = 0;
                var retryInterval = setInterval(function() {
                    retryCount++;
                    if (typeof db !== 'undefined' && db) { clearInterval(retryInterval); loadPublicEstimate(signToken); }
                    if (retryCount > 20) { clearInterval(retryInterval); document.getElementById('signPageContent').innerHTML = '<div style="text-align:center;padding:60px 20px;"><p style="color:#333;">Unable to connect. Please refresh.</p><button onclick="location.reload()" style="margin-top:16px;padding:12px 32px;background:#ff6b35;color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;">Retry</button></div>'; }
                }, 500);
            }
        } else {
            if (typeof auth !== 'undefined' && auth) {
                auth.onAuthStateChanged(function(user) {
                    if (user) {
                        currentUserId = user.uid;
                        enterApp();
                    } else {
                        currentUserId = null;
                        document.getElementById('mainApp').style.display = 'none';
                        document.getElementById('loginScreen').style.display = 'flex';
                    }
                });
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
            }
        }

        // Load public estimate for customer to sign
        function loadPublicEstimate(token) {
            document.getElementById('signPageContent').innerHTML = '<div style="text-align:center;padding:60px 20px;"><div style="width:40px;height:40px;border:3px solid #ff6b35;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px;"></div><p style="color:#333;">Loading estimate...</p></div><style>@keyframes spin{to{transform:rotate(360deg)}}</style>';
            
            db.collection('public_estimates').doc(token).get()
                .then(function(doc) {
                    if (!doc.exists) {
                        document.getElementById('signPageContent').innerHTML = '<div style="background:#fff;border-radius:16px;padding:60px 30px;text-align:center;max-width:500px;margin:40px auto;box-shadow:0 2px 12px rgba(0,0,0,0.08);"><p style="font-size:18px;font-weight:600;color:#333;margin:0 0 8px;">Estimate Not Found</p><p style="color:#333;font-size:14px;">This link may have expired or is no longer valid.</p></div>';
                        return;
                    }
                    var est = doc.data();
                    
                    // Track that customer viewed the estimate (only write to public_estimates)
                    var viewLog = est.viewLog || [];
                    viewLog.push({ action: 'viewed', date: new Date().toISOString() });
                    db.collection('public_estimates').doc(token).set({ 
                        viewLog: viewLog, 
                        lastViewed: new Date().toISOString(),
                        status: est.signature ? 'approved' : 'viewed'
                    }, { merge: true }).catch(function(){});
                    
                    renderPublicSignaturePage(est, token);
                })
                .catch(function(err) {
                    console.error('Signature page error:', err);
                    document.getElementById('signPageContent').innerHTML = '<div style="background:#fff;border-radius:16px;padding:60px 30px;text-align:center;max-width:500px;margin:40px auto;box-shadow:0 2px 12px rgba(0,0,0,0.08);"><p style="font-size:18px;font-weight:600;color:#333;margin:0 0 8px;">Unable to Load Estimate</p><p style="color:#333;font-size:14px;">Firebase security rules may need to be updated.</p><p style="color:#999;font-size:12px;margin-top:12px;">Error: ' + (err.code || err.message || 'Unknown') + '</p></div>';
                });
        }

        function renderPublicSignaturePage(est, token) {
            var itemsHtml = est.lineItems.map(function(item, idx) {
                var bg = idx % 2 === 0 ? '#fff' : '#fafafa';
                return '<tr style="background:' + bg + ';">' +
                    '<td style="padding:14px 20px;border-bottom:1px solid #eee;color:#000;font-weight:500;text-transform:uppercase;font-size:14px;">' + item.description + '</td>' +
                    '<td style="padding:14px 16px;text-align:center;border-bottom:1px solid #eee;color:#000;font-size:14px;">$' + item.rate + '</td>' +
                    '<td style="padding:14px 16px;text-align:center;border-bottom:1px solid #eee;color:#000;font-size:14px;">' + item.quantity + '</td>' +
                    '<td style="padding:14px 20px;text-align:right;border-bottom:1px solid #eee;font-weight:700;color:#000;font-size:14px;">$' + item.amount + '</td>' +
                '</tr>';
            }).join('');

            var alreadySigned = est.signature ? true : false;

            var signSection = '';
            if (alreadySigned) {
                signSection = '<div style="margin-top:30px;padding:30px;background:#f0fdf4;border:2px solid #22c55e;border-radius:12px;text-align:center;">' +
                    '<p style="font-size:20px;font-weight:700;color:#15803d;margin:0 0 8px;">Estimate Approved</p>' +
                    '<p style="color:#333;font-size:14px;margin:0;">Signed by ' + (est.signedBy || 'Customer') + ' on ' + (est.signedDate || 'N/A') + '</p>' +
                '</div>';
            } else {
                signSection = '<div style="margin-top:30px;padding:30px;background:#fff;border:2px solid #ff6b35;border-radius:12px;">' +
                    '<h3 style="font-size:20px;font-weight:700;color:#222;margin:0 0 20px;text-align:center;">Approve This Estimate</h3>' +
                    '<div style="margin-bottom:16px;">' +
                        '<label style="display:block;margin-bottom:6px;font-size:14px;color:#222;font-weight:600;">Your Full Name</label>' +
                        '<input type="text" id="publicSignName" placeholder="Type your full name" style="background:#fff;border:2px solid #ddd;border-radius:10px;padding:14px;width:100%;color:#222;font-size:16px;box-sizing:border-box;">' +
                    '</div>' +
                    '<div style="margin-bottom:16px;">' +
                        '<label style="display:block;margin-bottom:6px;font-size:14px;color:#222;font-weight:600;">Draw Your Signature</label>' +
                        '<canvas id="publicSigCanvas" width="500" height="180" style="touch-action:none;background:white;border:2px solid #ddd;border-radius:10px;width:100%;cursor:crosshair;"></canvas>' +
                    '</div>' +
                    '<div style="display:flex;gap:12px;margin-bottom:16px;">' +
                        '<button style="flex:1;padding:12px;background:#f5f5f5;border:1px solid #ddd;border-radius:10px;cursor:pointer;font-size:14px;color:#333;" onclick="clearPublicSigCanvas()">Clear Signature</button>' +
                    '</div>' +
                    '<button style="width:100%;padding:16px;background:#ff6b35;color:white;border:none;border-radius:10px;font-size:18px;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:1px;" onclick="submitPublicSignature(\'' + token + '\')">Approve & Sign</button>' +
                '</div>';
            }

            // Build the professional estimate page
            var html = '' +
                // Orange Header Bar with centered logo and BLACK text
                '<div style="background:#ff6b35;border-radius:16px 16px 0 0;padding:30px;text-align:center;">' +
                    (est.businessLogo ? '<img src="' + est.businessLogo + '" alt="Logo" style="max-height:80px;margin:0 auto 10px;display:block;border-radius:8px;">' : '') +
                    '<h1 style="color:#000000;margin:0;font-size:26px;font-weight:900;text-transform:uppercase;letter-spacing:2px;">' + (est.businessName || 'KDRSYSTEMS') + '</h1>' +
                    '<p style="color:#000000;margin:6px 0 0;font-size:12px;font-weight:600;letter-spacing:1px;">"YOUR PROPERTY, OUR EXPERIENCE"</p>' +
                    '<div style="margin-top:10px;">' +
                        (est.businessPhone ? '<span style="color:#000;font-size:13px;font-weight:600;">' + est.businessPhone + '</span>' : '') +
                        (est.businessPhone && est.businessEmail ? '<span style="color:#000;font-size:13px;margin:0 8px;">|</span>' : '') +
                        (est.businessEmail ? '<span style="color:#000;font-size:13px;font-weight:600;">' + est.businessEmail + '</span>' : '') +
                    '</div>' +
                    (est.businessAddress ? '<p style="color:#000;font-size:12px;margin:4px 0 0;">' + est.businessAddress + '</p>' : '') +
                '</div>' +
                // White Body
                '<div style="background:#fff;padding:35px;border-radius:0 0 16px 16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);">' +
                    // Estimate Title + Date
                    '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;flex-wrap:wrap;gap:12px;">' +
                        '<div>' +
                            '<h2 style="color:#222;margin:0;font-size:28px;font-weight:900;text-transform:uppercase;">ESTIMATE</h2>' +
                            '<p style="color:#333;font-size:13px;margin:4px 0 0;">#' + est.id.slice(-6) + '</p>' +
                        '</div>' +
                        '<div style="text-align:right;">' +
                            '<p style="color:#333;font-size:13px;margin:0;">Date: <strong style="color:#222;">' + est.date + '</strong></p>' +
                        '</div>' +
                    '</div>' +
                    // TO section
                    '<div style="margin-bottom:24px;padding:20px;background:#f9f9f9;border-radius:10px;border-left:4px solid #ff6b35;">' +
                        '<p style="color:#333;font-size:12px;text-transform:uppercase;letter-spacing:1px;margin:0 0 8px;font-weight:700;">TO:</p>' +
                        '<p style="font-weight:700;color:#222;font-size:18px;margin:0;">' + est.customerName + '</p>' +
                        (est.customerEmail ? '<p style="color:#333;font-size:14px;margin:4px 0 0;">' + est.customerEmail + '</p>' : '') +
                        (est.customerPhone ? '<p style="color:#333;font-size:14px;margin:2px 0 0;">' + est.customerPhone + '</p>' : '') +
                        (est.customerAddress ? '<p style="color:#333;font-size:14px;margin:2px 0 0;">' + est.customerAddress + '</p>' : '') +
                    '</div>' +
                    // Items Table
                    '<table style="width:100%;border-collapse:collapse;margin:20px 0;">' +
                        '<tr style="background:#ff6b35;">' +
                            '<th style="padding:14px 20px;text-align:left;font-size:13px;color:#000;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">ITEM DESCRIPTIONS</th>' +
                            '<th style="padding:14px 16px;text-align:center;font-size:13px;color:#000;font-weight:700;text-transform:uppercase;">PRICE</th>' +
                            '<th style="padding:14px 16px;text-align:center;font-size:13px;color:#000;font-weight:700;text-transform:uppercase;">QTY</th>' +
                            '<th style="padding:14px 20px;text-align:right;font-size:13px;color:#000;font-weight:700;text-transform:uppercase;">AMOUNT</th>' +
                        '</tr>' +
                        itemsHtml +
                    '</table>' +
                    // Subtotal / Total
                    '<div style="display:flex;justify-content:flex-end;margin-top:10px;">' +
                        '<div style="width:280px;">' +
                            '<div style="display:flex;justify-content:space-between;padding:10px 16px;"><span style="color:#333;font-weight:600;">SUBTOTAL</span><span style="color:#222;">$' + est.total + '</span></div>' +
                            '<div style="display:flex;justify-content:space-between;padding:10px 16px;border-bottom:1px solid #eee;"><span style="color:#333;font-weight:600;">DISCOUNT</span><span style="color:#222;">$0</span></div>' +
                            '<div style="display:flex;justify-content:space-between;padding:16px;background:#ff6b35;border-radius:8px;margin-top:8px;"><span style="color:#000;font-weight:800;font-size:18px;">TOTAL</span><span style="color:#000;font-weight:800;font-size:24px;">$' + est.total + '</span></div>' +
                        '</div>' +
                    '</div>' +
                    (est.notes ? '<div style="margin-top:24px;padding:16px;background:#f9f9f9;border-left:4px solid #ff6b35;border-radius:4px;"><p style="margin:0;font-size:14px;color:#333;"><strong>Notes:</strong> ' + est.notes + '</p></div>' : '') +
                    (est.terms ? '<div style="margin-top:16px;padding:16px;border:1px solid #eee;border-radius:8px;"><p style="font-size:13px;font-weight:700;color:#222;margin:0 0 6px;text-transform:uppercase;">Terms & Conditions</p><p style="font-size:12px;color:#333;margin:0;white-space:pre-wrap;">' + est.terms + '</p></div>' : '') +
                    signSection +
                    // Footer
                    '<div style="margin-top:30px;padding-top:20px;border-top:1px solid #eee;text-align:center;">' +
                        '<p style="font-size:14px;font-weight:700;color:#ff6b35;margin:0;">' + (est.businessName || '') + '</p>' +
                        (est.businessPhone ? '<p style="color:#333;font-size:13px;margin:4px 0 0;">' + est.businessPhone + '</p>' : '') +
                        (est.businessEmail ? '<p style="color:#333;font-size:13px;margin:2px 0 0;">' + est.businessEmail + '</p>' : '') +
                    '</div>' +
                '</div>';

            document.getElementById('signPageContent').innerHTML = html;

            // Init canvas if not signed
            if (!alreadySigned) {
                setTimeout(function() {
                    var c = document.getElementById('publicSigCanvas');
                    if (!c) return;
                    var ctx = c.getContext('2d');
                    c.width = c.offsetWidth;
                    c.height = 180;
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, c.width, c.height);
                    ctx.strokeStyle = '#222';
                    ctx.lineWidth = 2.5;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    var drawing = false;

                    function startD(x, y) { drawing = true; ctx.beginPath(); ctx.moveTo(x, y); }
                    function doD(x, y) { if (drawing) { ctx.lineTo(x, y); ctx.stroke(); } }

                    c.onmousedown = function(e) { startD(e.offsetX, e.offsetY); };
                    c.onmousemove = function(e) { doD(e.offsetX, e.offsetY); };
                    c.onmouseup = function() { drawing = false; };
                    c.onmouseleave = function() { drawing = false; };
                    c.ontouchstart = function(e) { e.preventDefault(); var r = c.getBoundingClientRect(); startD(e.touches[0].clientX - r.left, e.touches[0].clientY - r.top); };
                    c.ontouchmove = function(e) { e.preventDefault(); var r = c.getBoundingClientRect(); doD(e.touches[0].clientX - r.left, e.touches[0].clientY - r.top); };
                    c.ontouchend = function() { drawing = false; };
                }, 200);
            }
        }

        function clearPublicSigCanvas() {
            var c = document.getElementById('publicSigCanvas');
            if (c) { var ctx = c.getContext('2d'); ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, c.width, c.height); }
        }

        function submitPublicSignature(token) {
            var name = document.getElementById('publicSignName').value.trim();
            if (!name) { alert('Please type your full name.'); return; }

            var c = document.getElementById('publicSigCanvas');
            var sigData = c.toDataURL('image/png');
            var signedDate = new Date().toLocaleDateString();
            
            // Disable button to prevent double submit
            var btn = document.querySelector('#signPageContent button:last-child');
            if (btn) { btn.disabled = true; btn.textContent = 'Saving...'; btn.style.opacity = '0.6'; }

            // Save signature ONLY to public_estimates (customer is not logged in, cannot write to users collection)
            // The owner's app will pick this up via background sync
            db.collection('public_estimates').doc(token).set({
                signature: sigData,
                signedBy: name,
                signedDate: signedDate,
                status: 'approved',
                signedAt: new Date().toISOString()
            }, { merge: true })
            .then(function() {
                document.getElementById('signPageContent').innerHTML = '' +
                    '<div style="background:#fff;border-radius:16px;padding:60px 30px;text-align:center;max-width:500px;margin:40px auto;box-shadow:0 4px 20px rgba(0,0,0,0.08);">' +
                        '<div style="width:70px;height:70px;background:#f0fdf4;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;border:3px solid #22c55e;"><span style="font-size:32px;color:#22c55e;font-weight:900;">&#10003;</span></div>' +
                        '<h2 style="color:#222;font-size:24px;font-weight:700;margin:0 0 10px;">Estimate Approved</h2>' +
                        '<p style="color:#333;font-size:15px;margin:0 0 6px;">Thank you, ' + name + '.</p>' +
                        '<p style="color:#333;font-size:14px;margin:0;">Your signature has been recorded.</p>' +
                    '</div>';
            })
            .catch(function(err) {
                console.error('Signature save error:', err);
                var errMsg = 'Error saving signature.';
                if (err.code === 'permission-denied') {
                    errMsg += '\n\nFirebase security rules need to be updated.\n\nGo to Firebase Console > Firestore > Rules and add:\n\nmatch /public_estimates/{docId} {\n  allow read, write: if true;\n}';
                } else {
                    errMsg += '\n\n' + (err.message || err.code || 'Unknown error');
                }
                alert(errMsg);
                if (btn) { btn.disabled = false; btn.textContent = 'Approve & Sign'; btn.style.opacity = '1'; }
            });
        }

        // =============================================
        // DATA: SAVE TO FIRESTORE (reliable)
        // =============================================
        var isSaving = false;
        var pendingSave = false;

        function saveData() {
            updateDashboard();
            
            // ALWAYS save to localStorage immediately (never lose data)
            try { localStorage.setItem('kdrsystems_cache_' + currentUserId, JSON.stringify(appData)); } catch(e) {}

            if (!currentUserId) return;
            if (!db) return;
            showSaveStatus('saving');

            // If already saving, queue another save
            if (isSaving) { pendingSave = true; return; }
            
            isSaving = true;
            db.collection('users').doc(currentUserId).set({ appData: appData }, { merge: true })
                .then(function() { 
                    showSaveStatus('saved');
                    isSaving = false;
                    if (pendingSave) { pendingSave = false; saveData(); }
                })
                .catch(function(err) { 
                    console.error('Save error:', err); 
                    showSaveStatus('error');
                    isSaving = false;
                    // Retry once after 2 seconds
                    setTimeout(function() {
                        if (currentUserId) {
                            db.collection('users').doc(currentUserId).set({ appData: appData }, { merge: true })
                                .then(function() { showSaveStatus('saved'); })
                                .catch(function() { showSaveStatus('error'); });
                        }
                    }, 2000);
                });
        }

        // Force save before leaving page
        window.addEventListener('beforeunload', function() {
            if (currentUserId) {
                try { localStorage.setItem('kdrsystems_cache_' + currentUserId, JSON.stringify(appData)); } catch(e) {}
                // Sync save (best effort)
                var xhr = new XMLHttpRequest();
                // Can't do Firestore sync, but cache is saved
            }
        });

        function showSaveStatus(status) {
            var el = document.getElementById('saveIndicator');
            if (!el) return;
            if (status === 'saving') {
                el.textContent = 'Saving...';
                el.style.color = '#f59e0b';
                el.style.display = 'inline';
            } else if (status === 'saved') {
                el.textContent = 'Saved';
                el.style.color = '#22c55e';
                el.style.display = 'inline';
                setTimeout(function() { el.style.display = 'none'; }, 3000);
            } else {
                el.textContent = 'Retrying...';
                el.style.color = '#ef4444';
                el.style.display = 'inline';
            }
        }

        // =============================================
        // DATA: LOAD FROM FIRESTORE (safe)
        // =============================================
        var dataLoaded = false;

        function loadData() {
            if (!currentUserId) return;

            // Step 1: Load from localStorage cache for instant display
            var hasCachedData = false;
            try {
                var cached = localStorage.getItem('kdrsystems_cache_' + currentUserId);
                if (cached) {
                    var parsed = JSON.parse(cached);
                    // Only use cache if it has real data
                    if (parsed && (parsed.customers.length > 0 || parsed.estimates.length > 0 || parsed.invoices.length > 0 || parsed.settings.businessName)) {
                        appData = parsed;
                        hasCachedData = true;
                    }
                }
            } catch(e) { console.error('Cache read error:', e); }

            if (hasCachedData) {
                populateSettings();
                if (!dataLoaded) { dataLoaded = true; initApp(); }
                else { renderAll(); }
            }

            // Step 2: Fetch from Firestore (authoritative)
            if (!db) { if (!dataLoaded) { dataLoaded = true; initApp(); } return; }
            db.collection('users').doc(currentUserId).get()
                .then(function(doc) {
                    if (doc.exists && doc.data().appData) {
                        var serverData = doc.data().appData;
                        // Only use server data if it has content, OR if we have no cache
                        var serverHasData = serverData.customers.length > 0 || serverData.estimates.length > 0 || serverData.invoices.length > 0 || serverData.settings.businessName;
                        
                        if (serverHasData || !hasCachedData) {
                            // Merge: keep whichever has MORE data
                            if (serverHasData) {
                                appData = serverData;
                                try { localStorage.setItem('kdrsystems_cache_' + currentUserId, JSON.stringify(appData)); } catch(e) {}
                            }
                            populateSettings();
                            if (!dataLoaded) { dataLoaded = true; initApp(); }
                            else { renderAll(); }
                        }
                    } else if (!hasCachedData) {
                        // First time user, no cache — use defaults
                        if (!dataLoaded) { dataLoaded = true; initApp(); }
                    }
                })
                .catch(function(err) {
                    console.error('Load error:', err);
                    if (!dataLoaded) { dataLoaded = true; initApp(); }
                });
        }

        function renderAll() {
            try {
                renderTeamMembers();
                renderExpenses();
                calculateAll();
                updateDashboard();
                renderCalendar();
                renderDocuments();
                checkNotifications();
            } catch(e) { console.error('Render error:', e); }
        }

        function switchTab(tabName, element) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            document.querySelectorAll('.nav-btn-side').forEach(b => b.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            
            if (tabName === 'customers') renderCustomers();
            if (tabName === 'estimates') renderDocuments();
            if (tabName === 'materials') renderMaterials();
            if (tabName === 'templates') renderTemplates();
            if (tabName === 'schedule') renderCalendar();

            // Close sidebar on mobile after selecting
            closeSidebar();
        }

        // Sidebar toggle for mobile
        function toggleSidebar() {
            var nav = document.getElementById('sidebarNav');
            var overlay = document.getElementById('sidebarOverlay');
            nav.classList.toggle('open');
            overlay.classList.toggle('show');
        }
        function closeSidebar() {
            var nav = document.getElementById('sidebarNav');
            var overlay = document.getElementById('sidebarOverlay');
            if (nav) nav.classList.remove('open');
            if (overlay) overlay.classList.remove('show');
        }

        // Data Backup & Restore
        function downloadBackup() {
            var data = JSON.stringify(appData, null, 2);
            if (!data) {
                alert('No data to backup.');
                return;
            }
            var blob = new Blob([data], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            var datestamp = new Date().toISOString().split('T')[0];
            a.download = 'kdrsystems-backup-' + datestamp + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Backup downloaded!');
        }

        function restoreBackup(event) {
            var file = event.target.files[0];
            if (!file) return;
            if (!confirm('This will replace ALL your current data with the backup. Are you sure?')) {
                event.target.value = '';
                return;
            }
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var parsed = JSON.parse(e.target.result);
                    // Basic validation
                    if (!parsed.settings || typeof parsed.customers === 'undefined') {
                        alert('Invalid backup file. Please select a valid KDRSYSTEMS backup.');
                        return;
                    }
                    appData = parsed;
                    saveData();
                    populateSettings();
                    renderTeamMembers();
                    renderExpenses();
                    calculateAll();
                    updateDashboard();
                    renderCalendar();
                    alert('Data restored successfully!');
                } catch(err) {
                    alert('Error reading backup file. Make sure it is a valid JSON backup.');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            if (modalId === 'estimateModal') {
                populateCustomerSelect('estCustomer');
                populateTemplateSelect();
                populateTermsSelect();
            }
            if (modalId === 'scheduleModal') {
                populateCustomerSelect('schedCustomer');
            }
            if (modalId === 'materialModal') {
                populateCategoryDropdown();
            }
            if (modalId === 'templateModal') {
                populateTemplateMaterialsList();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Notifications
        function checkNotifications() {
            const now = new Date();
            const notificationHours = parseInt(appData.settings.jobNotificationHours) || 24;
            const notificationMs = notificationHours * 60 * 60 * 1000;
            
            appData.scheduledJobs.forEach(function(job) {
                const jobDate = new Date(job.date + ' ' + job.time);
                const timeUntilJob = jobDate - now;
                
                if (timeUntilJob > 0 && timeUntilJob <= notificationMs) {
                    const notificationId = 'job-' + job.id;
                    const exists = appData.notifications.find(function(n) { return n.id === notificationId; });
                    
                    if (!exists) {
                        const hoursUntil = Math.round(timeUntilJob / (60 * 60 * 1000));
                        appData.notifications.push({
                            id: notificationId,
                            type: 'job',
                            title: 'Upcoming Job',
                            message: job.title + ' with ' + job.customerName + ' in ' + hoursUntil + ' hours',
                            date: now.toISOString(),
                            read: false,
                            jobId: job.id
                        });
                    }
                }
            });
            
            if (appData.settings.invoiceReminderEnabled) {
                const reminder1Days = parseInt(appData.settings.reminder1Days) || 7;
                const reminder2Days = parseInt(appData.settings.reminder2Days) || 7;
                const reminder3Days = parseInt(appData.settings.reminder3Days) || 14;
                
                appData.invoices.forEach(function(invoice) {
                    if (invoice.status === 'unpaid' && invoice.sentDate) {
                        const sentDate = new Date(invoice.sentDate);
                        const daysSinceSent = Math.floor((now - sentDate) / (24 * 60 * 60 * 1000));
                        
                        const shouldRemind = (
                            daysSinceSent === reminder1Days ||
                            daysSinceSent === (reminder1Days + reminder2Days) ||
                            daysSinceSent === (reminder1Days + reminder2Days + reminder3Days)
                        );
                        
                        if (shouldRemind) {
                            const notificationId = 'invoice-' + invoice.id + '-day' + daysSinceSent;
                            const exists = appData.notifications.find(function(n) { return n.id === notificationId; });
                            
                            if (!exists) {
                                appData.notifications.push({
                                    id: notificationId,
                                    type: 'invoice',
                                    title: 'Invoice Reminder',
                                    message: 'Invoice #' + invoice.id.slice(-6) + ' for ' + invoice.customerName + ' ($' + invoice.total + ') is ' + daysSinceSent + ' days overdue',
                                    date: now.toISOString(),
                                    read: false,
                                    invoiceId: invoice.id
                                });
                            }
                        }
                    }
                });
            }

            // Estimate activity notifications (viewed / signed)
            appData.estimates.forEach(function(est) {
                if (est.activity && est.activity.length > 0) {
                    est.activity.forEach(function(a) {
                        var nId = 'est-activity-' + est.id + '-' + a.date;
                        var exists = appData.notifications.find(function(n) { return n.id === nId; });
                        if (!exists) {
                            appData.notifications.push({
                                id: nId,
                                type: 'estimate',
                                title: a.action.indexOf('signed') >= 0 ? 'Estimate Signed' : 'Estimate Viewed',
                                message: est.customerName + ' - Estimate #' + est.id.slice(-6) + ' ($' + est.total + ')',
                                date: a.date,
                                read: false,
                                estimateId: est.id
                            });
                        }
                    });
                }
            });
            
            saveData();
            updateNotificationBadge();
            renderNotifications();
        }

        function updateNotificationBadge() {
            const unreadCount = appData.notifications.filter(function(n) { return !n.read; }).length;
            const badge = document.getElementById('notificationBadge');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('hidden');
            
            if (!panel.classList.contains('hidden')) {
                renderNotifications();
            }
        }

        function renderNotifications() {
            const container = document.getElementById('notificationsList');
            
            if (appData.notifications.length === 0) {
                container.innerHTML = '<p class="text-gray-700 text-sm text-center py-4">No notifications</p>';
                return;
            }
            
            const sorted = appData.notifications.slice().sort(function(a, b) { 
                return new Date(b.date) - new Date(a.date); 
            });
            
            container.innerHTML = sorted.map(function(notif) {
                return '<div class="notification-item ' + (!notif.read ? 'unread' : '') + '" onclick="markNotificationRead(\'' + notif.id + '\')">' +
                    '<div class="flex justify-between items-start mb-1">' +
                        '<span class="font-semibold text-orange text-sm">' + notif.title + '</span>' +
                        '<span class="text-xs text-gray-900">' + formatNotificationDate(notif.date) + '</span>' +
                    '</div>' +
                    '<p class="text-xs text-gray-900">' + notif.message + '</p>' +
                '</div>';
            }).join('');
        }

        function markNotificationRead(notifId) {
            const notif = appData.notifications.find(function(n) { return n.id === notifId; });
            if (notif) {
                notif.read = true;
                saveData();
                updateNotificationBadge();
                renderNotifications();
            }
        }

        function clearAllNotifications() {
            if (confirm('Clear all notifications?')) {
                appData.notifications = [];
                saveData();
                updateNotificationBadge();
                renderNotifications();
            }
        }

        function formatNotificationDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 60) return diffMins + 'm ago';
            if (diffHours < 24) return diffHours + 'h ago';
            if (diffDays < 7) return diffDays + 'd ago';
            return date.toLocaleDateString();
        }

        // Calendar Functions
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            document.getElementById('calendarMonth').textContent = 
                currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day bg-gray-800 bg-opacity-30';
                grid.appendChild(emptyCell);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                
                const today = new Date();
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dayCell.classList.add('today');
                }
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'font-semibold text-sm mb-2';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);
                
                const jobsForDay = appData.scheduledJobs.filter(function(j) { return j.date === dateStr; });
                jobsForDay.forEach(function(job) {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'calendar-event';
                    eventDiv.textContent = job.time + ' - ' + job.title;
                    eventDiv.onclick = function(e) {
                        e.stopPropagation();
                        viewJob(job.id);
                    };
                    dayCell.appendChild(eventDiv);
                });
                
                dayCell.onclick = function() { openScheduleModalForDate(dateStr); };
                grid.appendChild(dayCell);
            }
        }

        function previousMonth() {
            currentCalendarDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() - 1, 1);
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 1);
            renderCalendar();
        }

        function openScheduleModalForDate(dateStr) {
            openModal('scheduleModal');
            document.getElementById('schedDate').value = dateStr;
        }

        function viewJob(jobId) {
            const job = appData.scheduledJobs.find(function(j) { return j.id === jobId; });
            if (!job) return;
            
            alert('Job: ' + job.title + '\nCustomer: ' + job.customerName + '\nDate: ' + job.date + ' at ' + job.time + '\nDuration: ' + job.duration + ' hours\nNotes: ' + (job.notes || 'None'));
        }

        document.getElementById('scheduleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customerId = document.getElementById('schedCustomer').value;
            const customer = appData.customers.find(function(c) { return c.id === customerId; });
            
            const job = {
                id: Date.now().toString(),
                customerId: customerId,
                customerName: customer.name,
                title: document.getElementById('schedTitle').value,
                date: document.getElementById('schedDate').value,
                time: document.getElementById('schedTime').value,
                duration: parseFloat(document.getElementById('schedDuration').value),
                notes: document.getElementById('schedNotes').value,
                status: 'scheduled',
                createdAt: new Date().toISOString()
            };
            
            appData.scheduledJobs.push(job);
            saveData();
            this.reset();
            closeModal('scheduleModal');
            renderCalendar();
            checkNotifications();
            alert('Job scheduled successfully!');
        });

        // Team Members
        function renderTeamMembers() {
            const container = document.getElementById('teamMembersList');
            container.innerHTML = appData.teamMembers.map(function(member, i) {
                const monthlyCost = (member.hourlyRate || 0) * (member.hoursPerMonth || 0);
                return '<div class="mb-3 p-3 bg-gray-50 rounded border border-gray-200">' +
                    '<input type="text" value="' + member.name + '" ' +
                        'onchange="appData.teamMembers[' + i + '].name = this.value; calculateAll();" ' +
                        'placeholder="Team Member Name" class="w-full mb-2 p-2 border border-gray-200 rounded text-sm">' +
                    '<div class="grid grid-cols-2 gap-2 mb-2">' +
                        '<input type="number" value="' + (member.hourlyRate || '') + '" step="0.01" ' +
                            'onchange="appData.teamMembers[' + i + '].hourlyRate = parseFloat(this.value) || 0; renderTeamMembers(); calculateAll();" ' +
                            'placeholder="$/hr" class="p-2 border border-gray-200 rounded text-sm">' +
                        '<input type="number" value="' + (member.hoursPerMonth || '') + '" step="1" ' +
                            'onchange="appData.teamMembers[' + i + '].hoursPerMonth = parseFloat(this.value) || 0; renderTeamMembers(); calculateAll();" ' +
                            'placeholder="hrs/mo" class="p-2 border border-gray-200 rounded text-sm">' +
                    '</div>' +
                    '<div class="flex justify-between items-center">' +
                        '<span class="text-xs text-gray-900">Monthly Cost: <span class="text-orange font-semibold">$' + monthlyCost.toFixed(2) + '</span></span>' +
                        '<button type="button" class="btn-danger text-sm px-3 py-1" onclick="removeTeamMember(' + i + ')">Remove</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function addTeamMember() {
            appData.teamMembers.push({ name: '', hourlyRate: 0, hoursPerMonth: 0 });
            renderTeamMembers();
        }

        function removeTeamMember(index) {
            appData.teamMembers.splice(index, 1);
            renderTeamMembers();
            calculateAll();
        }

        // Expenses
        function renderExpenses() {
            const container = document.getElementById('expensesList');
            container.innerHTML = appData.expenses.map(function(exp, i) {
                return '<div class="grid grid-cols-12 gap-2 items-center">' +
                    '<input type="text" value="' + exp.name + '" ' +
                        'onchange="appData.expenses[' + i + '].name = this.value; calculateAll();" ' +
                        'placeholder="Expense name" class="col-span-7 p-2 border border-gray-200 rounded text-sm">' +
                    '<input type="number" value="' + exp.amount + '" step="0.01" ' +
                        'onchange="appData.expenses[' + i + '].amount = parseFloat(this.value) || 0; calculateAll();" ' +
                        'placeholder="Amount" class="col-span-4 p-2 border border-gray-200 rounded text-sm">' +
                    '<button type="button" class="btn-danger col-span-1 text-sm p-2" onclick="removeExpense(' + i + ')">×</button>' +
                '</div>';
            }).join('');
        }

        function addExpense() {
            appData.expenses.push({ name: '', amount: 0 });
            renderExpenses();
        }

        function removeExpense(index) {
            appData.expenses.splice(index, 1);
            renderExpenses();
            calculateAll();
        }

        // Calculator
        function calculateAll() {
            const teamCost = appData.teamMembers.reduce(function(sum, m) {
                const memberCost = (parseFloat(m.hourlyRate) || 0) * (parseFloat(m.hoursPerMonth) || 0);
                return sum + memberCost;
            }, 0);
            const expenses = appData.expenses.reduce(function(sum, e) { return sum + (parseFloat(e.amount) || 0); }, 0);
            const profit = parseFloat(document.getElementById('desiredProfit') ? document.getElementById('desiredProfit').value : 0) || appData.calculator.desiredProfit;
            const hours = parseFloat(document.getElementById('workingHours') ? document.getElementById('workingHours').value : 0) || appData.calculator.workingHours;
            
            const totalCosts = teamCost + expenses;
            const profitMarginPercent = totalCosts > 0 ? ((profit / totalCosts) * 100) : 0;
            
            if (document.getElementById('profitMargin') && document.activeElement.id !== 'profitMargin') {
                document.getElementById('profitMargin').value = profitMarginPercent.toFixed(1);
            }
            
            const teamCostPerHour = hours > 0 ? teamCost / hours : 0;
            const overheadPerHour = hours > 0 ? expenses / hours : 0;
            const profitPerHour = hours > 0 ? profit / hours : 0;
            const hourlyRate = teamCostPerHour + overheadPerHour + profitPerHour;
            const requiredRevenue = teamCost + expenses + profit;
            
            document.getElementById('totalTeamCost').textContent = '$' + teamCost.toFixed(2);
            document.getElementById('totalExpenses').textContent = '$' + expenses.toFixed(2);
            document.getElementById('teamCostPerHour').textContent = '$' + teamCostPerHour.toFixed(2);
            document.getElementById('overheadPerHour').textContent = '$' + overheadPerHour.toFixed(2);
            document.getElementById('profitPerHour').textContent = '$' + profitPerHour.toFixed(2);
            document.getElementById('minimumRate').textContent = '$' + hourlyRate.toFixed(2);
            document.getElementById('marginDisplay').textContent = profitMarginPercent.toFixed(1) + '%';
            document.getElementById('summaryTeam').textContent = '$' + teamCost.toFixed(2);
            document.getElementById('summaryExpenses').textContent = '$' + expenses.toFixed(2);
            document.getElementById('summaryTotalCosts').textContent = '$' + totalCosts.toFixed(2);
            document.getElementById('summaryProfit').textContent = '$' + profit.toFixed(2);
            document.getElementById('requiredRevenue').textContent = '$' + requiredRevenue.toFixed(2);
            
            appData.calculator.hourlyRate = hourlyRate;
        }

        function calculateFromMargin() {
            const teamCost = appData.teamMembers.reduce(function(sum, m) {
                const memberCost = (parseFloat(m.hourlyRate) || 0) * (parseFloat(m.hoursPerMonth) || 0);
                return sum + memberCost;
            }, 0);
            const expenses = appData.expenses.reduce(function(sum, e) { return sum + (parseFloat(e.amount) || 0); }, 0);
            const totalCosts = teamCost + expenses;
            const marginPercent = parseFloat(document.getElementById('profitMargin').value) || 0;
            
            const calculatedProfit = (totalCosts * marginPercent) / 100;
            document.getElementById('desiredProfit').value = calculatedProfit.toFixed(2);
            
            calculateAll();
        }

        function toggleCalculatorView(view) {
            appData.calculator.view = view;
            updateCalculatorViewButtons();
            calculateAll();
            saveData();
        }

        function updateCalculatorViewButtons() {
            const monthlyBtn = document.getElementById('monthlyViewBtn');
            const yearlyBtn = document.getElementById('yearlyViewBtn');
            
            if (appData.calculator.view === 'monthly') {
                monthlyBtn.classList.add('btn-primary');
                monthlyBtn.classList.remove('btn-secondary');
                yearlyBtn.classList.remove('btn-primary');
                yearlyBtn.classList.add('btn-secondary');
            } else {
                yearlyBtn.classList.add('btn-primary');
                yearlyBtn.classList.remove('btn-secondary');
                monthlyBtn.classList.remove('btn-primary');
                monthlyBtn.classList.add('btn-secondary');
            }
        }

        function saveCalculator() {
            appData.calculator.desiredProfit = parseFloat(document.getElementById('desiredProfit').value) || 0;
            appData.calculator.workingHours = parseFloat(document.getElementById('workingHours').value) || 160;
            calculateAll();
            saveData();
            alert('Calculator settings saved!');
        }

        // Customers
        document.getElementById('customerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            appData.customers.push({
                id: Date.now().toString(),
                name: document.getElementById('custName').value,
                email: document.getElementById('custEmail').value,
                phone: document.getElementById('custPhone').value,
                address: document.getElementById('custAddress').value
            });
            saveData();
            this.reset();
            closeModal('customerModal');
            renderCustomers();
        });

        function renderCustomers() {
            const tbody = document.getElementById('customersTable');
            if (appData.customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-900">No customers yet</td></tr>';
                return;
            }
            tbody.innerHTML = appData.customers.map(function(c) {
                return '<tr>' +
                    '<td class="py-3 px-4">' + c.name + '</td>' +
                    '<td class="py-3 px-4">' + (c.email || '-') + '</td>' +
                    '<td class="py-3 px-4">' + (c.phone || '-') + '</td>' +
                    '<td class="py-3 px-4">' + (c.address || '-') + '</td>' +
                    '<td class="py-3 px-4 text-right">' +
                        '<button class="btn-danger" onclick="deleteCustomer(\'' + c.id + '\')">Delete</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        function deleteCustomer(id) {
            if (confirm('Delete this customer?')) {
                appData.customers = appData.customers.filter(function(c) { return c.id !== id; });
                saveData();
                renderCustomers();
            }
        }

        function populateCustomerSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select Customer</option>' +
                appData.customers.map(function(c) { return '<option value="' + c.id + '">' + c.name + '</option>'; }).join('');
        }

        // Materials
        document.getElementById('materialForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            let category = document.getElementById('matCategory').value;
            const newCategory = document.getElementById('matNewCategory').value;
            if (newCategory) category = newCategory;
            
            var editId = document.getElementById('matEditId').value;
            
            var matData = {
                name: document.getElementById('matName').value,
                category: category || 'Uncategorized',
                description: document.getElementById('matDescription').value,
                cost: parseFloat(document.getElementById('matCost').value),
                unit: document.getElementById('matUnit').value,
                markup: parseFloat(document.getElementById('matMarkup').value) || 0,
                photo: currentMatPhoto || ''
            };
            
            if (editId) {
                // Edit existing material
                var mat = appData.materials.find(function(m) { return m.id === editId; });
                if (mat) {
                    mat.name = matData.name;
                    mat.category = matData.category;
                    mat.description = matData.description;
                    mat.cost = matData.cost;
                    mat.unit = matData.unit;
                    mat.markup = matData.markup;
                    mat.photo = matData.photo || mat.photo;
                }
            } else {
                // Add new
                matData.id = Date.now().toString();
                appData.materials.push(matData);
            }
            
            saveData();
            this.reset();
            document.getElementById('matEditId').value = '';
            currentMatPhoto = '';
            document.getElementById('matPhotoPreview').classList.add('hidden');
            document.getElementById('matNewCategory').classList.add('hidden');
            document.getElementById('materialModalTitle').textContent = 'Add Material';
            closeModal('materialModal');
            renderMaterials();
        });
        
        function editMaterial(id) {
            var mat = appData.materials.find(function(m) { return m.id === id; });
            if (!mat) return;
            document.getElementById('matEditId').value = id;
            document.getElementById('matName').value = mat.name;
            document.getElementById('matDescription').value = mat.description || '';
            document.getElementById('matCost').value = mat.cost;
            document.getElementById('matUnit').value = mat.unit || '';
            document.getElementById('matMarkup').value = mat.markup || 0;
            document.getElementById('materialModalTitle').textContent = 'Edit Material';
            
            // Set category
            populateCategoryDropdown();
            document.getElementById('matCategory').value = mat.category || '';
            
            // Set photo
            if (mat.photo) {
                currentMatPhoto = mat.photo;
                document.getElementById('matPhotoImg').src = mat.photo;
                document.getElementById('matPhotoPreview').classList.remove('hidden');
            } else {
                currentMatPhoto = '';
                document.getElementById('matPhotoPreview').classList.add('hidden');
            }
            
            openModal('materialModal');
        }

        // =============================================
        // IMAGE COMPRESSION & PHOTO HANDLING
        // =============================================
        function compressImage(file, maxW, maxH, quality) {
            return new Promise(function(resolve) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = new Image();
                    img.onload = function() {
                        var canvas = document.createElement('canvas');
                        var w = img.width, h = img.height;
                        if (w > maxW) { h = h * maxW / w; w = maxW; }
                        if (h > maxH) { w = w * maxH / h; h = maxH; }
                        canvas.width = w;
                        canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', quality || 0.6));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Material photo
        var currentMatPhoto = '';
        function handleMatPhoto(event) {
            var file = event.target.files[0];
            if (!file) return;
            compressImage(file, 400, 400, 0.6).then(function(dataUrl) {
                currentMatPhoto = dataUrl;
                document.getElementById('matPhotoImg').src = dataUrl;
                document.getElementById('matPhotoPreview').classList.remove('hidden');
            });
        }
        function clearMatPhoto() {
            currentMatPhoto = '';
            document.getElementById('matPhotoPreview').classList.add('hidden');
            document.getElementById('matPhotoImg').src = '';
        }

        // Estimate photos
        var currentEstPhotos = [];
        function handleEstPhotos(event) {
            var files = Array.from(event.target.files);
            var remaining = 5 - currentEstPhotos.length;
            if (files.length > remaining) {
                alert('Maximum 5 photos. You can add ' + remaining + ' more.');
                files = files.slice(0, remaining);
            }
            files.forEach(function(file) {
                compressImage(file, 800, 600, 0.5).then(function(dataUrl) {
                    currentEstPhotos.push(dataUrl);
                    renderEstPhotoPreview();
                });
            });
            event.target.value = '';
        }
        function removeEstPhoto(idx) {
            currentEstPhotos.splice(idx, 1);
            renderEstPhotoPreview();
        }
        function renderEstPhotoPreview() {
            var container = document.getElementById('estPhotosPreview');
            container.innerHTML = currentEstPhotos.map(function(p, i) {
                return '<div style="position:relative;display:inline-block;">' +
                    '<img src="' + p + '" alt="Photo" style="height:80px;border-radius:8px;border:2px solid #e5e5e5;">' +
                    '<button type="button" onclick="removeEstPhoto(' + i + ')" style="position:absolute;top:-6px;right:-6px;background:#ef4444;color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:12px;cursor:pointer;line-height:20px;">×</button>' +
                '</div>';
            }).join('');
        }

        function toggleNewCategory() {
            const input = document.getElementById('matNewCategory');
            const select = document.getElementById('matCategory');
            if (input.classList.contains('hidden')) {
                input.classList.remove('hidden');
                select.value = '';
            } else {
                input.classList.add('hidden');
                input.value = '';
            }
        }

        function populateCategoryDropdown() {
            const categories = [];
            const seen = {};
            appData.materials.forEach(function(m) {
                const cat = m.category || 'Uncategorized';
                if (!seen[cat]) {
                    seen[cat] = true;
                    categories.push(cat);
                }
            });
            const select = document.getElementById('matCategory');
            select.innerHTML = '<option value="">Select or create category</option>' +
                categories.map(function(cat) { return '<option value="' + cat + '">' + cat + '</option>'; }).join('');
                
            const filter = document.getElementById('categoryFilter');
            if (filter) {
                filter.innerHTML = '<option value="all">All Categories</option>' +
                    categories.map(function(cat) { return '<option value="' + cat + '">' + cat + '</option>'; }).join('');
            }
        }

        function filterMaterialsByCategory() {
            renderMaterials();
        }

        function renderMaterials() {
            const container = document.getElementById('materialsList');
            const filterValue = document.getElementById('categoryFilter') ? document.getElementById('categoryFilter').value : 'all';
            
            let filteredMaterials = appData.materials;
            if (filterValue !== 'all') {
                filteredMaterials = appData.materials.filter(function(m) { return (m.category || 'Uncategorized') === filterValue; });
            }
            
            if (filteredMaterials.length === 0) {
                container.innerHTML = '<div class="card col-span-full text-center text-gray-700 py-8">No materials in this category</div>';
                return;
            }
            
            const grouped = {};
            filteredMaterials.forEach(function(m) {
                const cat = m.category || 'Uncategorized';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(m);
            });
            
            container.innerHTML = Object.keys(grouped).map(function(category) {
                return '<div class="card">' +
                    '<div class="mb-4 pb-3 border-b border-gray-200">' +
                        '<h4 class="font-bold text-lg text-orange">' + category + '</h4>' +
                        '<p class="text-xs text-gray-900">' + grouped[category].length + ' items</p>' +
                    '</div>' +
                    '<div class="space-y-3">' +
                        grouped[category].map(function(m) {
                            var photoHtml = m.photo ? '<img src="' + m.photo + '" alt="' + m.name + '" style="width:50px;height:50px;object-fit:cover;border-radius:6px;border:1px solid #e5e5e5;flex-shrink:0;">' : '<div style="width:50px;height:50px;background:#fff5f0;border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:20px;"></div>';
                            return '<div class="p-3 bg-gray-50 rounded border border-gray-100 cursor-pointer" style="position:relative;" onclick="editMaterial(\'' + m.id + '\')">' +
                                '<button class="btn-danger text-xs" style="position:absolute;top:6px;right:6px;width:22px;height:22px;padding:0;border-radius:50;line-height:22px;text-align:center;" onclick="event.stopPropagation(); deleteMaterial(\'' + m.id + '\')">×</button>' +
                                '<div class="flex gap-3 items-start">' +
                                    photoHtml +
                                    '<div class="flex-1 min-w-0">' +
                                        '<h5 class="font-semibold text-gray-800">' + m.name + '</h5>' +
                                        (m.description ? '<p class="text-xs text-gray-700 mt-1">' + m.description + '</p>' : '') +
                                        '<div class="flex justify-between items-center text-sm mt-1">' +
                                            '<span class="text-gray-900">$' + m.cost + (m.unit ? ' / ' + m.unit : '') + '</span>' +
                                            '<span class="text-orange font-medium">' + m.markup + '% markup</span>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>';
                        }).join('') +
                    '</div>' +
                '</div>';
            }).join('');
            
            populateCategoryDropdown();
        }

        function deleteMaterial(id) {
            if (confirm('Delete this material?')) {
                appData.materials = appData.materials.filter(function(m) { return m.id !== id; });
                saveData();
                renderMaterials();
            }
        }
        
        function openAddMaterial() {
            document.getElementById('materialForm').reset();
            document.getElementById('matEditId').value = '';
            document.getElementById('materialModalTitle').textContent = 'Add Material';
            currentMatPhoto = '';
            document.getElementById('matPhotoPreview').classList.add('hidden');
            document.getElementById('matNewCategory').classList.add('hidden');
            populateCategoryDropdown();
            openModal('materialModal');
        }
        
        function openAddTemplate() {
            document.getElementById('templateForm').reset();
            document.getElementById('tempEditId').value = '';
            document.getElementById('templateModalTitle').textContent = 'Create Material Template';
            populateTemplateMaterialsList();
            openModal('templateModal');
        }

        // Templates
        document.getElementById('templateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const selectedMaterials = [];
            const checkboxes = document.querySelectorAll('#templateMaterialsList input[type="checkbox"]:checked');
            checkboxes.forEach(function(cb) {
                const matId = cb.value;
                const qtyInput = document.getElementById('qty_' + matId);
                const qty = parseFloat(qtyInput ? qtyInput.value : 1) || 1;
                selectedMaterials.push({ materialId: matId, quantity: qty });
            });
            
            var editId = document.getElementById('tempEditId').value;
            
            if (editId) {
                var tmpl = appData.templates.find(function(t) { return t.id === editId; });
                if (tmpl) {
                    tmpl.name = document.getElementById('tempName').value;
                    tmpl.description = document.getElementById('tempDescription').value;
                    tmpl.materials = selectedMaterials;
                }
            } else {
                appData.templates.push({
                    id: Date.now().toString(),
                    name: document.getElementById('tempName').value,
                    description: document.getElementById('tempDescription').value,
                    materials: selectedMaterials
                });
            }
            
            saveData();
            this.reset();
            document.getElementById('tempEditId').value = '';
            document.getElementById('templateModalTitle').textContent = 'Create Material Template';
            closeModal('templateModal');
            renderTemplates();
        });
        
        function editTemplate(id) {
            var tmpl = appData.templates.find(function(t) { return t.id === id; });
            if (!tmpl) return;
            document.getElementById('tempEditId').value = id;
            document.getElementById('tempName').value = tmpl.name;
            document.getElementById('tempDescription').value = tmpl.description || '';
            document.getElementById('templateModalTitle').textContent = 'Edit Template';
            
            populateTemplateMaterialsList();
            
            // Check the right materials and set quantities
            setTimeout(function() {
                tmpl.materials.forEach(function(tm) {
                    var cb = document.getElementById('mat_' + tm.materialId);
                    if (cb) cb.checked = true;
                    var qtyInput = document.getElementById('qty_' + tm.materialId);
                    if (qtyInput) qtyInput.value = tm.quantity;
                });
            }, 50);
            
            openModal('templateModal');
        }

        function populateTemplateMaterialsList() {
            const container = document.getElementById('templateMaterialsList');
            if (appData.materials.length === 0) {
                container.innerHTML = '<p class="text-gray-700 text-sm">No materials available. Add materials first.</p>';
                return;
            }
            
            const grouped = {};
            appData.materials.forEach(function(m) {
                const cat = m.category || 'Uncategorized';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(m);
            });
            
            container.innerHTML = Object.keys(grouped).map(function(category) {
                return '<div class="mb-3">' +
                    '<p class="text-xs font-semibold text-orange mb-2">' + category + '</p>' +
                    grouped[category].map(function(m) {
                        return '<div class="flex items-center gap-3 p-2 mb-1 border border-gray-200 rounded">' +
                            '<input type="checkbox" value="' + m.id + '" id="mat_' + m.id + '">' +
                            '<label for="mat_' + m.id + '" class="flex-1 text-sm">' + m.name + ' ($' + m.cost + '/' + (m.unit || 'ea') + ')</label>' +
                            '<input type="number" id="qty_' + m.id + '" placeholder="Qty" step="0.01" ' +
                                'class="w-20 p-1 border border-gray-200 rounded text-sm" value="1">' +
                        '</div>';
                    }).join('') +
                '</div>';
            }).join('');
        }

        function deleteTemplate(id) {
            if (confirm('Delete this template?')) {
                appData.templates = appData.templates.filter(function(t) { return t.id !== id; });
                saveData();
                renderTemplates();
            }
        }

        function renderTemplates() {
            const templatesList = document.getElementById('templatesList');
            if (appData.templates.length === 0) {
                templatesList.innerHTML = '<div class="card text-center text-gray-700 py-8">No templates yet. Create your first material package.</div>';
            } else {
                templatesList.innerHTML = '<div class="space-y-4">' +
                    appData.templates.map(function(t) {
                        // Calculate template total
                        var total = 0;
                        t.materials.forEach(function(tm) {
                            var mat = appData.materials.find(function(m) { return m.id === tm.materialId; });
                            if (mat) total += mat.cost * (1 + mat.markup / 100) * tm.quantity;
                        });
                        
                        return '<div class="card cursor-pointer" style="position:relative;" onclick="editTemplate(\'' + t.id + '\')">' +
                            '<button class="btn-danger text-xs" style="position:absolute;top:12px;right:12px;width:24px;height:24px;padding:0;border-radius:50%;line-height:24px;text-align:center;" onclick="event.stopPropagation(); deleteTemplate(\'' + t.id + '\')">×</button>' +
                            '<h4 class="font-bold text-xl text-orange mb-1">' + t.name + '</h4>' +
                            '<p class="text-sm text-gray-900">' + (t.description || '') + '</p>' +
                            '<div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-200">' +
                                '<span class="text-xs text-gray-700">' + t.materials.length + ' materials</span>' +
                                '<span class="font-bold text-orange">$' + total.toFixed(2) + '</span>' +
                            '</div>' +
                        '</div>';
                    }).join('') +
                '</div>';
            }
            
            const termsList = document.getElementById('termsList');
            if (appData.terms.length === 0) {
                termsList.innerHTML = '<p class="text-gray-700 text-sm text-center py-4">No terms templates yet</p>';
            } else {
                termsList.innerHTML = appData.terms.map(function(t) {
                    return '<div class="p-3 bg-gray-50 rounded border border-gray-100">' +
                        '<div class="flex justify-between items-start mb-2">' +
                            '<h5 class="font-semibold text-gray-800">' + t.name + '</h5>' +
                            '<button class="btn-danger text-xs px-2 py-1" onclick="deleteTerms(\'' + t.id + '\')">×</button>' +
                        '</div>' +
                        '<p class="text-xs text-gray-900">' + t.content.substring(0, 80) + (t.content.length > 80 ? '...' : '') + '</p>' +
                    '</div>';
                }).join('');
            }
        }

        document.getElementById('termsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            appData.terms.push({
                id: Date.now().toString(),
                name: document.getElementById('termsName').value,
                content: document.getElementById('termsContent').value
            });
            saveData();
            this.reset();
            closeModal('termsModal');
            renderTemplates();
        });

        function deleteTerms(id) {
            if (confirm('Delete this terms template?')) {
                appData.terms = appData.terms.filter(function(t) { return t.id !== id; });
                saveData();
                renderTemplates();
            }
        }

        function populateTermsSelect() {
            const select = document.getElementById('estTerms');
            select.innerHTML = '<option value="">No Terms</option>' +
                appData.terms.map(function(t) { return '<option value="' + t.id + '">' + t.name + '</option>'; }).join('');
        }

        // Estimates
        function addEstimateLine() {
            const container = document.getElementById('estimateLines');
            const lineDiv = document.createElement('div');
            lineDiv.className = 'grid grid-cols-12 gap-2 items-center';
            lineDiv.innerHTML = 
                '<input type="text" placeholder="Description" class="col-span-5 p-2 border border-gray-200 rounded text-sm" onchange="calculateEstimate()">' +
                '<input type="number" placeholder="Qty" value="1" step="0.01" class="col-span-2 p-2 border border-gray-200 rounded text-sm" onchange="calculateEstimate()">' +
                '<input type="number" placeholder="Rate" step="0.01" class="col-span-2 p-2 border border-gray-200 rounded text-sm" onchange="calculateEstimate()">' +
                '<input type="number" placeholder="Markup %" value="0" step="0.01" class="col-span-2 p-2 border border-gray-200 rounded text-sm" onchange="calculateEstimate()">' +
                '<button type="button" class="btn-danger text-sm col-span-1 p-2" onclick="this.parentElement.remove(); calculateEstimate()">×</button>';
            container.appendChild(lineDiv);
        }

        function populateTemplateSelect() {
            const select = document.getElementById('estTemplate');
            select.innerHTML = '<option value="">No Template</option>' +
                appData.templates.map(function(t) { return '<option value="' + t.id + '">' + t.name + '</option>'; }).join('');
        }

        function applyTemplate() {
            const templateId = document.getElementById('estTemplate').value;
            if (!templateId) return;
            
            const template = appData.templates.find(function(t) { return t.id === templateId; });
            const container = document.getElementById('estimateLines');
            container.innerHTML = '';
            
            // Calculate total cost of all materials in template
            var totalCost = 0;
            template.materials.forEach(function(tm) {
                const material = appData.materials.find(function(m) { return m.id === tm.materialId; });
                if (material) {
                    var priceWithMarkup = material.cost * (1 + material.markup / 100);
                    totalCost += priceWithMarkup * tm.quantity;
                }
            });
            
            // Add ONE line with template name and total price — customer never sees individual materials
            var desc = template.name + (template.description ? ' - ' + template.description : '');
            const lineDiv = document.createElement('div');
            lineDiv.className = 'grid grid-cols-12 gap-2 items-center';
            lineDiv.innerHTML = 
                '<input type="text" value="' + desc + '" class="col-span-5 p-2 border border-gray-200 rounded text-sm" onchange="calculateEstimate()">' +
                '<input type="number" value="1" step="0.01" class="col-span-2 p-2 border border-gray-200 rounded text-sm" onchange="calculateEstimate()">' +
                '<input type="number" value="' + totalCost.toFixed(2) + '" step="0.01" class="col-span-2 p-2 border border-gray-200 rounded text-sm" onchange="calculateEstimate()">' +
                '<input type="number" value="0" step="0.01" class="col-span-2 p-2 border border-gray-200 rounded text-sm" onchange="calculateEstimate()">' +
                '<button type="button" class="btn-danger text-sm col-span-1 p-2" onclick="this.parentElement.remove(); calculateEstimate()">×</button>';
            container.appendChild(lineDiv);
            
            calculateEstimate();
        }

        function calculateEstimate() {
            const lines = document.querySelectorAll('#estimateLines > div');
            let materialsTotal = 0;
            
            lines.forEach(function(line) {
                const inputs = line.querySelectorAll('input');
                const qty = parseFloat(inputs[1].value) || 0;
                const rate = parseFloat(inputs[2].value) || 0;
                const markup = parseFloat(inputs[3].value) || 0;
                
                const baseAmount = qty * rate;
                const markupAmount = baseAmount * (markup / 100);
                materialsTotal += baseAmount + markupAmount;
            });
            
            // Labor from dedicated fields
            var laborHrs = parseFloat(document.getElementById('estLaborHours').value) || 0;
            var laborRate = parseFloat(document.getElementById('estLaborRate').value) || 0;
            
            // Auto-fill rate from calculator if not manually set
            if (!document.getElementById('estLaborRate').value && appData.calculator.hourlyRate > 0) {
                laborRate = appData.calculator.hourlyRate;
                document.getElementById('estLaborRate').placeholder = laborRate.toFixed(2);
            }
            
            var laborTotal = laborHrs * laborRate;
            document.getElementById('estLaborTotal').textContent = '$' + laborTotal.toFixed(2);
            
            // Update hint
            if (appData.calculator.hourlyRate > 0) {
                document.getElementById('estLaborRateHint').textContent = 'Calculator: $' + appData.calculator.hourlyRate.toFixed(2) + '/hr';
            }
            
            var grandTotal = materialsTotal + laborTotal;
            var materialsCost = 0;
            // Calculate true material costs (before markup) for profit calc
            lines.forEach(function(line) {
                const inputs = line.querySelectorAll('input');
                const qty = parseFloat(inputs[1].value) || 0;
                const rate = parseFloat(inputs[2].value) || 0;
                materialsCost += qty * rate;
            });
            
            var profit = grandTotal - materialsCost - laborTotal;
            var margin = grandTotal > 0 ? (profit / grandTotal * 100) : 0;
            
            document.getElementById('estSubtotal').textContent = '$' + materialsTotal.toFixed(2);
            document.getElementById('estLaborCost').textContent = '$' + laborTotal.toFixed(2);
            document.getElementById('estProfit').textContent = '$' + profit.toFixed(2);
            document.getElementById('estTotal').textContent = '$' + grandTotal.toFixed(2);
            document.getElementById('estMargin').textContent = margin.toFixed(1) + '%';
        }

        document.getElementById('estimateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customerId = document.getElementById('estCustomer').value;
            const customer = appData.customers.find(function(c) { return c.id === customerId; });
            
            const lines = [];
            document.querySelectorAll('#estimateLines > div').forEach(function(line) {
                const inputs = line.querySelectorAll('input');
                const qty = parseFloat(inputs[1].value) || 0;
                const rate = parseFloat(inputs[2].value) || 0;
                const markup = parseFloat(inputs[3].value) || 0;
                lines.push({
                    description: inputs[0].value,
                    quantity: 1,
                    rate: (qty * rate * (1 + markup/100)).toFixed(2),
                    markup: 0,
                    amount: (qty * rate * (1 + markup/100)).toFixed(2),
                    _qty: qty,
                    _rate: rate,
                    _markup: markup
                });
            });
            
            // Add labor as a line item if hours entered
            var laborHrs = parseFloat(document.getElementById('estLaborHours').value) || 0;
            var laborRate = parseFloat(document.getElementById('estLaborRate').value) || appData.calculator.hourlyRate || 0;
            if (laborHrs > 0 && laborRate > 0) {
                var laborTotal = (laborHrs * laborRate).toFixed(2);
                lines.push({
                    description: 'Labor',
                    quantity: 1,
                    rate: laborTotal,
                    markup: 0,
                    amount: laborTotal,
                    _laborHrs: laborHrs,
                    _laborRate: laborRate
                });
            }
            
            const termsId = document.getElementById('estTerms').value;
            const termsTemplate = termsId ? appData.terms.find(function(t) { return t.id === termsId; }) : null;
            
            const estimate = {
                id: Date.now().toString(),
                type: 'estimate',
                customerId: customerId,
                customerName: customer.name,
                customerEmail: customer.email,
                customerPhone: customer.phone || '',
                customerAddress: customer.address || '',
                date: document.getElementById('estDate').value,
                lineItems: lines,
                notes: document.getElementById('estNotes').value,
                terms: termsTemplate ? termsTemplate.content : '',
                termsName: termsTemplate ? termsTemplate.name : '',
                total: document.getElementById('estTotal').textContent.replace('$', ''),
                profit: document.getElementById('estProfit').textContent.replace('$', ''),
                margin: document.getElementById('estMargin').textContent,
                status: 'pending',
                sentDate: null,
                reminderSent: false,
                photos: currentEstPhotos.slice()
            };
            
            appData.estimates.push(estimate);
            saveData();
            this.reset();
            document.getElementById('estLaborHours').value = '';
            document.getElementById('estLaborRate').value = '';
            document.getElementById('estLaborTotal').textContent = '$0.00';
            currentEstPhotos = [];
            document.getElementById('estPhotosPreview').innerHTML = '';
            document.getElementById('estimateLines').innerHTML = '';
            addEstimateLine();
            closeModal('estimateModal');
            renderDocuments();
        });

        function renderDocuments() {
            const container = document.getElementById('documentsList');
            const allDocs = appData.estimates.concat(appData.invoices).sort(function(a, b) { return b.id - a.id; });
            
            if (allDocs.length === 0) {
                container.innerHTML = '<div class="card text-center text-gray-700 py-8">No documents yet</div>';
                return;
            }
            
            container.innerHTML = allDocs.map(function(doc) {
                return '<div class="card">' +
                    '<div class="flex justify-between items-start mb-4">' +
                        '<div>' +
                            '<div class="flex items-center gap-3 mb-1">' +
                                '<h3 class="text-xl font-semibold">' + (doc.type === 'estimate' ? 'Estimate' : 'Invoice') + ' #' + doc.id.slice(-6) + '</h3>' +
                                '<span class="status-badge status-' + doc.status + '">' + doc.status + '</span>' +
                            '</div>' +
                            '<p class="text-gray-900">' + doc.customerName + '</p>' +
                            '<p class="text-sm text-gray-900">Date: ' + doc.date + '</p>' +
                            (doc.termsName ? '<p class="text-xs text-orange mt-1">Terms: ' + doc.termsName + '</p>' : '') +
                        '</div>' +
                        '<div class="text-right">' +
                            '<p class="text-3xl font-bold text-orange">$' + doc.total + '</p>' +
                            '<p class="text-sm text-green-600">Profit: $' + doc.profit + ' (' + doc.margin + ')</p>' +
                        '</div>' +
                    '</div>' +
                    '<div class="space-y-1 mb-4 text-sm">' +
                        doc.lineItems.map(function(item) {
                            return '<div class="flex justify-between text-gray-900">' +
                                '<span>' + item.description + ' (' + item.quantity + ' × $' + item.rate + (item.markup > 0 ? ' + ' + item.markup + '%' : '') + ')</span>' +
                                '<span class="font-medium">$' + item.amount + '</span>' +
                            '</div>';
                        }).join('') +
                    '</div>' +
                    (doc.notes ? '<div class="text-sm text-gray-700 mb-3 p-3 bg-gray-50 rounded">' + doc.notes + '</div>' : '') +
                    (doc.terms ? '<div class="text-xs text-gray-700 mb-3 p-3 border border-gray-200 rounded">' +
                        '<p class="font-semibold text-orange mb-1">Terms & Conditions:</p>' +
                        '<p class="whitespace-pre-wrap">' + doc.terms + '</p>' +
                    '</div>' : '') +
                    '<div class="flex flex-wrap gap-2 pt-4 border-t border-gray-200">' +
                        (doc.type === 'estimate' ? 
                            '<button class="btn-primary" onclick="viewEstimate(\'' + doc.id + '\')">View</button>' +
                            '<button class="btn-secondary" onclick="editDocument(\'' + doc.id + '\', \'estimate\')">Edit</button>' +
                            '<button class="btn-secondary" onclick="convertToInvoice(\'' + doc.id + '\')">Convert to Invoice</button>' +
                            '<button class="btn-secondary" onclick="sendDocument(\'' + doc.id + '\')">Send</button>' :
                            '<button class="btn-primary" onclick="viewInvoice(\'' + doc.id + '\')">View</button>' +
                            '<button class="btn-secondary" onclick="editDocument(\'' + doc.id + '\', \'invoice\')">Edit</button>' +
                            '<button class="btn-secondary" onclick="sendDocument(\'' + doc.id + '\')">Send</button>') +
                        '<button class="btn-danger" onclick="deleteDocument(\'' + doc.id + '\', \'' + doc.type + '\')"></button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function convertToInvoice(estimateId) {
            const estimate = appData.estimates.find(function(e) { return e.id === estimateId; });
            const invoice = JSON.parse(JSON.stringify(estimate));
            invoice.id = Date.now().toString();
            invoice.type = 'invoice';
            invoice.dueDate = new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0];
            invoice.status = 'unpaid';
            invoice.estimateId = estimateId;
            invoice.signature = null;
            invoice.signedDate = null;
            invoice.sentDate = new Date().toISOString();
            
            appData.invoices.push(invoice);
            estimate.status = 'approved';
            saveData();
            renderDocuments();
            checkNotifications();
            alert('Estimate converted to invoice!');
        }

        function sendDocument(id) {
            const allDocs = appData.estimates.concat(appData.invoices);
            const doc = allDocs.find(function(d) { return d.id === id; });
            if (!doc) return;

            var pubKey = appData.settings.emailjsPublicKey;
            var serviceId = appData.settings.emailjsServiceId;
            var templateId = appData.settings.emailjsTemplateId;

            if (!pubKey || !serviceId || !templateId) {
                alert('Email not set up yet. Go to Settings → Email Settings (EmailJS) to configure.');
                return;
            }
            if (!doc.customerEmail) {
                alert('This customer has no email address on file.');
                return;
            }

            var s = appData.settings;
            var bizName = s.businessName || 'KDRSYSTEMS';
            var docType = doc.type === 'estimate' ? 'Estimate' : 'Invoice';
            var docNum = '#' + doc.id.slice(-6);
            var siteUrl = window.location.origin + window.location.pathname;

            // Line items (K-DR orange row style)
            var itemsHtml = doc.lineItems.map(function(item, idx) {
                var bgColor = idx % 2 === 0 ? '#fff3ec' : '#ffe8d9';
                return '<tr style="background:' + bgColor + ';">' +
                    '<td style="padding:14px 16px;color:#000;font-size:14px;font-weight:600;text-transform:uppercase;">' + item.description + '</td>' +
                    '<td style="padding:14px 12px;text-align:center;color:#000;font-size:14px;">$' + item.rate + '</td>' +
                    '<td style="padding:14px 12px;text-align:center;color:#000;font-size:14px;">' + item.quantity + '</td>' +
                    '<td style="padding:14px 16px;text-align:right;font-weight:700;color:#000;font-size:14px;">$' + item.amount + '</td>' +
                '</tr>';
            }).join('');

            // Social icons
            var socialIcons = [];
            if (s.instagram) socialIcons.push('<a href="' + (s.instagram.startsWith('http') ? s.instagram : 'https://instagram.com/' + s.instagram.replace('@','')) + '" style="display:inline-block;margin:0 8px;" target="_blank"><img src="https://img.icons8.com/fluency/28/instagram-new.png" alt="Instagram" style="width:28px;height:28px;"></a>');
            if (s.facebook) socialIcons.push('<a href="' + (s.facebook.startsWith('http') ? s.facebook : 'https://facebook.com/' + s.facebook) + '" style="display:inline-block;margin:0 8px;" target="_blank"><img src="https://img.icons8.com/fluency/28/facebook-new.png" alt="Facebook" style="width:28px;height:28px;"></a>');
            if (s.tiktok) socialIcons.push('<a href="' + (s.tiktok.startsWith('http') ? s.tiktok : 'https://tiktok.com/@' + s.tiktok.replace('@','')) + '" style="display:inline-block;margin:0 8px;" target="_blank"><img src="https://img.icons8.com/fluency/28/tiktok.png" alt="TikTok" style="width:28px;height:28px;"></a>');
            if (s.google) socialIcons.push('<a href="' + (s.google.startsWith('http') ? s.google : 'https://g.page/' + s.google) + '" style="display:inline-block;margin:0 8px;" target="_blank"><img src="https://img.icons8.com/fluency/28/google-logo.png" alt="Google" style="width:28px;height:28px;"></a>');
            var socialsRow = socialIcons.length ? '<div style="margin:16px 0;">' + socialIcons.join('') + '</div>' : '';

            // Create public estimate for signing (estimates only)
            var signToken = doc.id + '_' + Date.now();
            var signLinkHtml = '';

            function buildAndSendEmail() {
                if (doc.type === 'estimate') {
                    signLinkHtml = '<div style="text-align:center;margin:30px 0;padding:28px;background:#fff8f0;border-radius:8px;border:2px solid #ff6b35;">' +
                        '<p style="font-size:18px;font-weight:700;color:#222;margin:0 0 8px;">Ready to approve this estimate?</p>' +
                        '<p style="font-size:14px;color:#333;margin:0 0 20px;">Click below to review and sign digitally</p>' +
                        '<a href="' + siteUrl + '?sign=' + signToken + '" style="display:inline-block;background:#ff6b35;color:#ffffff;padding:16px 44px;border-radius:6px;text-decoration:none;font-weight:700;font-size:16px;text-transform:uppercase;letter-spacing:1px;">SIGN & APPROVE</a>' +
                    '</div>';
                }

                // Clean email template - white background, black text, orange accents
                var emailBody = '' +
                '<div style="max-width:640px;margin:0 auto;font-family:Arial,Helvetica,sans-serif;background:#ffffff;">' +
                    // Header - Orange bar with centered logo and business name
                    '<div style="background:#ff6b35;padding:28px 30px;text-align:center;">' +
                        (s.logo ? '<img src="' + s.logo + '" alt="' + bizName + '" style="max-height:80px;margin:0 auto 10px;display:block;">' : '') +
                        '<h1 style="color:#000000;margin:0;font-size:26px;font-weight:900;text-transform:uppercase;letter-spacing:2px;">' + bizName + '</h1>' +
                        '<p style="color:#000000;margin:6px 0 0;font-size:12px;font-weight:600;letter-spacing:1px;">"YOUR PROPERTY, OUR EXPERIENCE"</p>' +
                    '</div>' +
                    // White body
                    '<div style="padding:32px 35px;background:#ffffff;">' +
                        // ESTIMATE title + date row
                        '<table style="width:100%;margin-bottom:24px;"><tr>' +
                            '<td style="vertical-align:top;">' +
                                '<h2 style="color:#000000;margin:0;font-size:30px;font-weight:900;text-transform:uppercase;letter-spacing:1px;">' + docType.toUpperCase() + '</h2>' +
                            '</td>' +
                            '<td style="vertical-align:top;text-align:right;">' +
                                '<p style="color:#000000;font-size:13px;margin:0;">TO:</p>' +
                            '</td>' +
                        '</tr></table>' +
                        // Date + Customer info row
                        '<table style="width:100%;margin-bottom:24px;"><tr>' +
                            '<td style="vertical-align:top;width:50%;">' +
                                '<p style="color:#333;font-size:13px;margin:0 0 4px;">' + docType.toUpperCase() + ' DATE: <strong style="color:#000;">' + doc.date + '</strong></p>' +
                                '<p style="color:#333;font-size:13px;margin:0;">' + docNum + '</p>' +
                            '</td>' +
                            '<td style="vertical-align:top;width:50%;text-align:right;">' +
                                '<p style="font-weight:700;color:#000000;font-size:16px;margin:0;">' + doc.customerName + '</p>' +
                                (doc.customerEmail ? '<p style="color:#333;font-size:13px;margin:3px 0 0;">' + doc.customerEmail + '</p>' : '') +
                                (doc.customerPhone ? '<p style="color:#333;font-size:13px;margin:2px 0 0;">' + doc.customerPhone + '</p>' : '') +
                                (doc.customerAddress ? '<p style="color:#333;font-size:13px;margin:2px 0 0;">' + doc.customerAddress + '</p>' : '') +
                            '</td>' +
                        '</tr></table>' +
                        // Description line if notes exist
                        (doc.notes ? '<div style="margin-bottom:20px;padding:12px 16px;background:#fff5f0;border-radius:6px;border-left:4px solid #ff6b35;"><p style="margin:0;font-size:14px;color:#000;font-weight:600;">' + doc.notes + '</p></div>' : '') +
                        // Items Table - orange header, alternating rows
                        '<table style="width:100%;border-collapse:collapse;margin:0 0 20px;">' +
                            '<tr style="background:#ff6b35;">' +
                                '<th style="padding:14px 16px;text-align:left;font-size:13px;color:#000000;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">ITEM DESCRIPTIONS</th>' +
                                '<th style="padding:14px 12px;text-align:center;font-size:13px;color:#000000;font-weight:700;text-transform:uppercase;">PRICE</th>' +
                                '<th style="padding:14px 12px;text-align:center;font-size:13px;color:#000000;font-weight:700;text-transform:uppercase;">QTY</th>' +
                                '<th style="padding:14px 16px;text-align:right;font-size:13px;color:#000000;font-weight:700;text-transform:uppercase;">AMOUNT</th>' +
                            '</tr>' +
                            itemsHtml +
                        '</table>' +
                        // Subtotal / Discount / Total
                        '<table style="width:100%;margin-top:16px;"><tr>' +
                            '<td style="width:50%;vertical-align:bottom;">' +
                                '<p style="color:#000;font-size:16px;font-weight:900;margin:0;">TOTAL</p>' +
                            '</td>' +
                            '<td style="width:50%;">' +
                                '<table style="width:100%;border-collapse:collapse;">' +
                                    '<tr><td style="padding:8px 16px;color:#000;font-size:14px;font-weight:600;">DISCOUNT=</td><td style="padding:8px 16px;color:#000;font-size:14px;text-align:right;">$0</td></tr>' +
                                    '<tr><td style="padding:8px 16px;color:#000;font-size:14px;font-weight:600;">SUBTOTAL =</td><td style="padding:8px 16px;color:#000;font-size:20px;text-align:right;font-weight:900;">$' + doc.total + '</td></tr>' +
                                '</table>' +
                            '</td>' +
                        '</tr></table>' +
                        (doc.terms ? '<div style="margin-top:20px;padding:16px;border:1px solid #eee;border-radius:6px;"><p style="font-size:13px;font-weight:700;color:#000;margin:0 0 6px;text-transform:uppercase;">Terms & Conditions</p><p style="font-size:12px;color:#333;margin:0;white-space:pre-wrap;">' + doc.terms + '</p></div>' : '') +
                        signLinkHtml +
                    '</div>' +
                    // Orange Footer bar
                    '<div style="background:#ff6b35;padding:24px 30px;">' +
                        '<table style="width:100%;"><tr>' +
                            '<td style="vertical-align:top;">' +
                                '<p style="margin:0;font-size:13px;color:#000000;font-weight:700;text-transform:uppercase;">TERMS & CONDITIONS</p>' +
                                (s.phone ? '<p style="margin:8px 0 0;font-size:14px;color:#000000;font-weight:600;">' + s.phone + '</p>' : '') +
                            '</td>' +
                            '<td style="vertical-align:top;text-align:right;">' +
                                '<p style="margin:0;font-size:13px;color:#000000;font-weight:700;">CONTACT US AT</p>' +
                                (s.email ? '<p style="margin:4px 0 0;font-size:13px;color:#000000;">' + s.email + '</p>' : '') +
                                (s.website ? '<p style="margin:2px 0 0;font-size:13px;color:#000000;">' + s.website + '</p>' : '') +
                                socialsRow +
                            '</td>' +
                        '</tr></table>' +
                    '</div>' +
                '</div>';

                if (!confirm('Send this ' + docType.toLowerCase() + ' to ' + doc.customerEmail + '?')) return;

                var sendBtns = document.querySelectorAll('button');
                sendBtns.forEach(function(b) { if (b.textContent.indexOf('Send') >= 0) b.disabled = true; });

                emailjs.send(serviceId, templateId, {
                    to_email: doc.customerEmail,
                    to_name: doc.customerName,
                    from_name: bizName,
                    subject: docType + ' ' + docNum + ' from ' + bizName,
                    message: emailBody
                }, pubKey)
                .then(function() {
                    doc.sentDate = new Date().toISOString();
                    doc.status = doc.type === 'estimate' ? 'sent' : doc.status;
                    if (doc.type === 'estimate') doc.signToken = signToken;
                    if (!doc.activity) doc.activity = [];
                    doc.activity.push({ action: 'Estimate sent to ' + doc.customerEmail, date: new Date().toISOString() });
                    saveData();
                    renderDocuments();
                    checkNotifications();
                    alert(docType + ' sent to ' + doc.customerEmail);
                })
                .catch(function(err) {
                    console.error('EmailJS error:', err);
                    alert('Failed to send email.\n\nError: ' + (err.text || err.message || 'Unknown error'));
                })
                .finally(function() {
                    sendBtns.forEach(function(b) { b.disabled = false; });
                });
            }

            // For estimates: create public document for signing, then send
            if (doc.type === 'estimate') {
                var pubDoc = {
                    id: doc.id,
                    ownerId: currentUserId,
                    businessName: bizName,
                    businessEmail: s.email || '',
                    businessPhone: s.phone || '',
                    businessAddress: s.address || '',
                    businessLogo: s.logo || '',
                    customerName: doc.customerName,
                    customerEmail: doc.customerEmail,
                    customerPhone: doc.customerPhone || '',
                    customerAddress: doc.customerAddress || '',
                    date: doc.date,
                    lineItems: doc.lineItems,
                    total: doc.total,
                    notes: doc.notes || '',
                    terms: doc.terms || '',
                    status: 'sent',
                    signature: null,
                    signedBy: null,
                    signedDate: null
                };
                db.collection('public_estimates').doc(signToken).set(pubDoc)
                    .then(function() { buildAndSendEmail(); })
                    .catch(function(err) { console.error(err); buildAndSendEmail(); });
            } else {
                signLinkHtml = '';
                buildAndSendEmail();
            }
        }

        function deleteDocument(id, type) {
            if (!confirm('Delete this ' + type + '?')) return;
            
            if (type === 'estimate') {
                appData.estimates = appData.estimates.filter(function(e) { return e.id !== id; });
            } else {
                appData.invoices = appData.invoices.filter(function(i) { return i.id !== id; });
            }
            saveData();
            renderDocuments();
        }

        function viewInvoice(id) {
            var doc = appData.invoices.find(function(i) { return i.id === id; });
            if (!doc) return;

            var bizName = appData.settings.businessName || 'KDRSYSTEMS';
            var itemsHtml = doc.lineItems.map(function(item) {
                return '<tr>' +
                    '<td style="padding:10px;border-bottom:1px solid #eee;color:#333;">' + item.description + '</td>' +
                    '<td style="padding:10px;text-align:center;border-bottom:1px solid #eee;color:#333;">' + item.quantity + '</td>' +
                    '<td style="padding:10px;text-align:right;border-bottom:1px solid #eee;color:#333;">$' + item.rate + '</td>' +
                    '<td style="padding:10px;text-align:right;border-bottom:1px solid #eee;font-weight:bold;color:#ff6b35;">$' + item.amount + '</td>' +
                '</tr>';
            }).join('');

            var html = '' +
                '<div class="p-6">' +
                    '<div class="flex justify-between items-start mb-6">' +
                        '<div>' +
                            '<h2 class="text-2xl font-bold text-orange">' + bizName + '</h2>' +
                            (appData.settings.address ? '<p class="text-sm text-gray-700 mt-1" style="white-space:pre-wrap;">' + appData.settings.address + '</p>' : '') +
                            (appData.settings.phone ? '<p class="text-sm text-gray-900">' + appData.settings.phone + '</p>' : '') +
                            (appData.settings.email ? '<p class="text-sm text-gray-900">' + appData.settings.email + '</p>' : '') +
                        '</div>' +
                        '<div class="text-right">' +
                            '<h3 class="text-xl font-bold">INVOICE</h3>' +
                            '<p class="text-gray-900">#' + doc.id.slice(-6) + '</p>' +
                            '<p class="text-sm text-gray-900">Date: ' + doc.date + '</p>' +
                            (doc.dueDate ? '<p class="text-sm text-gray-900">Due: ' + doc.dueDate + '</p>' : '') +
                            '<span class="status-badge status-' + doc.status + ' mt-2 inline-block">' + doc.status + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="mb-4 p-3 rounded" style="background:#fff5f0;border:1px solid #e5e5e5;">' +
                        '<p class="text-sm text-gray-900">Bill To:</p>' +
                        '<p class="font-semibold text-gray-800">' + doc.customerName + '</p>' +
                        (doc.customerEmail ? '<p class="text-sm text-gray-900">' + doc.customerEmail + '</p>' : '') +
                    '</div>' +
                    '<table style="width:100%;border-collapse:collapse;margin:16px 0;">' +
                        '<tr style="background:#fff5f0;">' +
                            '<th style="padding:10px;text-align:left;color:#ff6b35;font-size:13px;">Description</th>' +
                            '<th style="padding:10px;text-align:center;color:#ff6b35;font-size:13px;">Qty</th>' +
                            '<th style="padding:10px;text-align:right;color:#ff6b35;font-size:13px;">Rate</th>' +
                            '<th style="padding:10px;text-align:right;color:#ff6b35;font-size:13px;">Amount</th>' +
                        '</tr>' +
                        itemsHtml +
                    '</table>' +
                    '<div class="text-right mt-4 p-4 rounded" style="background:#ffede3;border:2px solid #ff6b35;">' +
                        '<span class="text-gray-900 text-lg">Total: </span>' +
                        '<span class="text-3xl font-bold text-orange">$' + doc.total + '</span>' +
                    '</div>' +
                    (doc.notes ? '<div class="mt-4 p-3 rounded" style="background:#f5f5f5;"><p class="text-sm text-gray-900"><strong>Notes:</strong> ' + doc.notes + '</p></div>' : '') +
                    (doc.terms ? '<div class="mt-4 p-3 rounded border border-gray-200"><p class="text-xs font-semibold text-orange mb-1">Terms & Conditions:</p><p class="text-xs text-gray-700 whitespace-pre-wrap">' + doc.terms + '</p></div>' : '') +
                    '<div class="flex gap-3 mt-6 pt-4 border-t border-gray-200">' +
                        '<button class="btn-primary" onclick="sendDocument(\'' + doc.id + '\')">Email to Customer</button>' +
                        (doc.status === 'unpaid' ? '<button class="btn-secondary" onclick="markInvoicePaid(\'' + doc.id + '\')">Mark as Paid</button>' : '') +
                        '<button class="btn-secondary" onclick="closeModal(\'invoiceViewModal\')">Close</button>' +
                    '</div>' +
                '</div>';

            document.getElementById('invoiceViewContent').innerHTML = html;
            openModal('invoiceViewModal');
        }

        function markInvoicePaid(id) {
            var invoice = appData.invoices.find(function(i) { return i.id === id; });
            if (invoice) {
                invoice.status = 'paid';
                invoice.paidDate = new Date().toISOString();
                saveData();
                renderDocuments();
                viewInvoice(id);
                alert('Invoice marked as paid!');
            }
        }

        // View Estimate (read-only viewer)
        function viewEstimate(id) {
            var doc = appData.estimates.find(function(e) { return e.id === id; });
            if (!doc) return;

            var bizName = appData.settings.businessName || 'KDRSYSTEMS';
            var itemsHtml = doc.lineItems.map(function(item) {
                return '<tr>' +
                    '<td style="padding:10px;border-bottom:1px solid #eee;color:#333;">' + item.description + '</td>' +
                    '<td style="padding:10px;text-align:center;border-bottom:1px solid #eee;color:#333;">' + item.quantity + '</td>' +
                    '<td style="padding:10px;text-align:right;border-bottom:1px solid #eee;color:#333;">$' + item.rate + '</td>' +
                    '<td style="padding:10px;text-align:center;border-bottom:1px solid #eee;color:#333;">' + (item.markup || 0) + '%</td>' +
                    '<td style="padding:10px;text-align:right;border-bottom:1px solid #eee;font-weight:bold;color:#ff6b35;">$' + item.amount + '</td>' +
                '</tr>';
            }).join('');

            // Logo
            var logoHtml = '';
            if (appData.settings.logo) {
                logoHtml = '<img src="' + appData.settings.logo + '" alt="Logo" style="max-height:60px;border-radius:6px;margin-bottom:8px;">';
            }

            // Customer info
            var custHtml = '<p class="font-semibold text-gray-800">' + doc.customerName + '</p>';
            if (doc.customerEmail) custHtml += '<p class="text-sm text-gray-900">' + doc.customerEmail + '</p>';
            if (doc.customerPhone) custHtml += '<p class="text-sm text-gray-900">' + doc.customerPhone + '</p>';
            if (doc.customerAddress) custHtml += '<p class="text-sm text-gray-700" style="white-space:pre-wrap;">' + doc.customerAddress + '</p>';

            // Signature display
            var sigHtml = '';
            if (doc.signature) {
                sigHtml = '<div class="mt-4 p-4 rounded" style="background:#dcfce7;border:2px solid #22c55e;">' +
                    '<p class="text-sm font-semibold text-green-600 mb-2">Approved & Signed</p>' +
                    '<img src="' + doc.signature + '" alt="Signature" style="max-height:80px;background:white;border-radius:6px;padding:4px;">' +
                    '<p class="text-xs text-gray-700 mt-2">Signed by: ' + (doc.signedBy || 'Customer') + '</p>' +
                    '<p class="text-xs text-gray-900">Date: ' + (doc.signedDate || 'N/A') + '</p>' +
                '</div>';
            }

            var html = '' +
                '<div class="p-6">' +
                    '<div class="flex flex-wrap justify-between items-start mb-6 gap-4">' +
                        '<div>' +
                            logoHtml +
                            '<h2 class="text-2xl font-bold text-orange">' + bizName + '</h2>' +
                            (appData.settings.address ? '<p class="text-sm text-gray-700 mt-1" style="white-space:pre-wrap;">' + appData.settings.address + '</p>' : '') +
                            (appData.settings.phone ? '<p class="text-sm text-gray-900">' + appData.settings.phone + '</p>' : '') +
                            (appData.settings.email ? '<p class="text-sm text-gray-900">' + appData.settings.email + '</p>' : '') +
                        '</div>' +
                        '<div class="text-right">' +
                            '<h3 class="text-xl font-bold">ESTIMATE</h3>' +
                            '<p class="text-gray-900">#' + doc.id.slice(-6) + '</p>' +
                            '<p class="text-sm text-gray-900">Date: ' + doc.date + '</p>' +
                            '<span class="status-badge status-' + doc.status + ' mt-2 inline-block">' + doc.status + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="mb-4 p-3 rounded" style="background:#fff5f0;border:1px solid #e5e5e5;">' +
                        '<p class="text-sm text-gray-700 mb-1">Customer:</p>' +
                        custHtml +
                    '</div>' +
                    '<div class="table-wrap">' +
                    '<table style="width:100%;border-collapse:collapse;margin:16px 0;">' +
                        '<tr style="background:#fff5f0;">' +
                            '<th style="padding:10px;text-align:left;color:#ff6b35;font-size:13px;">Description</th>' +
                            '<th style="padding:10px;text-align:center;color:#ff6b35;font-size:13px;">Qty</th>' +
                            '<th style="padding:10px;text-align:right;color:#ff6b35;font-size:13px;">Rate</th>' +
                            '<th style="padding:10px;text-align:center;color:#ff6b35;font-size:13px;">Markup</th>' +
                            '<th style="padding:10px;text-align:right;color:#ff6b35;font-size:13px;">Amount</th>' +
                        '</tr>' +
                        itemsHtml +
                    '</table>' +
                    '</div>' +
                    '<div class="text-right mt-4 p-4 rounded" style="background:#ffede3;border:2px solid #ff6b35;">' +
                        '<div class="flex justify-between items-center">' +
                            '<div class="text-left">' +
                                '<p class="text-sm text-green-600">Profit: $' + doc.profit + ' (' + doc.margin + ')</p>' +
                            '</div>' +
                            '<div>' +
                                '<span class="text-gray-900 text-lg">Total: </span>' +
                                '<span class="text-3xl font-bold text-orange">$' + doc.total + '</span>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    (doc.notes ? '<div class="mt-4 p-3 rounded" style="background:#f5f5f5;"><p class="text-sm text-gray-900"><strong>Notes:</strong> ' + doc.notes + '</p></div>' : '') +
                    (doc.terms ? '<div class="mt-4 p-3 rounded border border-gray-200"><p class="text-xs font-semibold text-orange mb-1">Terms & Conditions' + (doc.termsName ? ' (' + doc.termsName + ')' : '') + ':</p><p class="text-xs text-gray-700 whitespace-pre-wrap">' + doc.terms + '</p></div>' : '') +
                    (doc.photos && doc.photos.length > 0 ? '<div class="mt-4"><p class="text-sm font-semibold text-orange mb-2">Property / Job Photos</p><div class="flex flex-wrap gap-2">' + doc.photos.map(function(p, i) { return '<img src="' + p + '" alt="Photo ' + (i+1) + '" style="height:120px;border-radius:8px;border:2px solid #e5e5e5;cursor:pointer;" onclick="window.open(this.src)">'; }).join('') + '</div></div>' : '') +
                    sigHtml +
                    // Activity Log
                    (doc.activity && doc.activity.length > 0 ? '<div class="mt-4 p-4 rounded" style="background:#f9f9f9;border:1px solid #e5e5e5;"><p class="text-sm font-semibold text-gray-800 mb-2">Activity</p>' + doc.activity.map(function(a) { var d = new Date(a.date); return '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eee;"><span style="font-size:13px;color:#333;">' + a.action + '</span><span style="font-size:12px;color:#333;">' + d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) + '</span></div>'; }).join('') + '</div>' : '') +
                    (doc.lastViewed ? '<p class="text-xs text-gray-900 mt-2">Last viewed by customer: ' + new Date(doc.lastViewed).toLocaleString() + '</p>' : '') +
                    '<div class="flex flex-wrap gap-3 mt-6 pt-4 border-t border-gray-200">' +
                        '<button class="btn-secondary" onclick="refreshEstimate(\'' + doc.id + '\')">Refresh Status</button>' +
                        (!doc.signature ? '<button class="btn-primary" onclick="openSignatureModal(\'' + doc.id + '\')">Approve & Sign</button>' : '') +
                        '<button class="btn-secondary" onclick="editDocument(\'' + doc.id + '\', \'estimate\'); closeModal(\'invoiceViewModal\');">Edit</button>' +
                        '<button class="btn-secondary" onclick="sendDocument(\'' + doc.id + '\')">Send</button>' +
                        '<button class="btn-secondary" onclick="convertToInvoice(\'' + doc.id + '\'); closeModal(\'invoiceViewModal\');">Convert to Invoice</button>' +
                        '<button class="btn-secondary" onclick="closeModal(\'invoiceViewModal\')">Close</button>' +
                    '</div>' +
                '</div>';

            document.getElementById('invoiceViewContent').innerHTML = html;
            openModal('invoiceViewModal');
        }

        function refreshEstimate(id) {
            var localEst = appData.estimates.find(function(e) { return e.id === id; });
            if (!localEst || !localEst.signToken) { alert('No tracking data for this estimate. Resend to enable tracking.'); return; }
            
            db.collection('public_estimates').doc(localEst.signToken).get().then(function(doc) {
                if (!doc.exists) { alert('Public estimate not found.'); return; }
                var pub = doc.data();
                var changed = false;
                
                if (pub.signature && !localEst.signature) {
                    localEst.signature = pub.signature;
                    localEst.signedBy = pub.signedBy;
                    localEst.signedDate = pub.signedDate;
                    localEst.status = 'approved';
                    if (!localEst.activity) localEst.activity = [];
                    localEst.activity.push({ action: 'Customer signed and approved', date: pub.signedAt || new Date().toISOString() });
                    changed = true;
                }
                
                if (pub.lastViewed && localEst.status === 'sent') {
                    localEst.status = 'viewed';
                    localEst.lastViewed = pub.lastViewed;
                    if (!localEst.activity) localEst.activity = [];
                    var alreadyLogged = localEst.activity.find(function(a) { return a.action === 'Customer viewed estimate'; });
                    if (!alreadyLogged) {
                        localEst.activity.push({ action: 'Customer viewed estimate', date: pub.lastViewed });
                        changed = true;
                    }
                }
                
                if (changed) {
                    saveData();
                    checkNotifications();
                }
                renderDocuments();
                viewEstimate(id);
                if (!changed) alert('No new activity on this estimate.');
            }).catch(function(err) { 
                console.error(err); 
                alert('Could not refresh. Check your connection.');
            });
        }

        // Signature Canvas
        var sigCanvas, sigCtx, sigDrawing = false;

        function openSignatureModal(estimateId) {
            document.getElementById('signEstimateId').value = estimateId;
            document.getElementById('signName').value = '';
            openModal('signatureModal');

            setTimeout(function() {
                sigCanvas = document.getElementById('signatureCanvas');
                sigCtx = sigCanvas.getContext('2d');
                sigCanvas.width = sigCanvas.offsetWidth;
                sigCanvas.height = 180;
                sigCtx.fillStyle = '#fff';
                sigCtx.fillRect(0, 0, sigCanvas.width, sigCanvas.height);
                sigCtx.strokeStyle = '#333';
                sigCtx.lineWidth = 2.5;
                sigCtx.lineCap = 'round';
                sigCtx.lineJoin = 'round';
                sigDrawing = false;

                // Mouse events
                sigCanvas.onmousedown = function(e) { startSigDraw(e.offsetX, e.offsetY); };
                sigCanvas.onmousemove = function(e) { if (sigDrawing) drawSig(e.offsetX, e.offsetY); };
                sigCanvas.onmouseup = function() { sigDrawing = false; };
                sigCanvas.onmouseleave = function() { sigDrawing = false; };

                // Touch events
                sigCanvas.ontouchstart = function(e) {
                    e.preventDefault();
                    var r = sigCanvas.getBoundingClientRect();
                    var t = e.touches[0];
                    startSigDraw(t.clientX - r.left, t.clientY - r.top);
                };
                sigCanvas.ontouchmove = function(e) {
                    e.preventDefault();
                    if (sigDrawing) {
                        var r = sigCanvas.getBoundingClientRect();
                        var t = e.touches[0];
                        drawSig(t.clientX - r.left, t.clientY - r.top);
                    }
                };
                sigCanvas.ontouchend = function() { sigDrawing = false; };
            }, 200);
        }

        function startSigDraw(x, y) {
            sigDrawing = true;
            sigCtx.beginPath();
            sigCtx.moveTo(x, y);
        }

        function drawSig(x, y) {
            sigCtx.lineTo(x, y);
            sigCtx.stroke();
        }

        function clearSignatureCanvas() {
            if (sigCanvas && sigCtx) {
                sigCtx.fillStyle = '#fff';
                sigCtx.fillRect(0, 0, sigCanvas.width, sigCanvas.height);
            }
        }

        function submitSignature() {
            var estId = document.getElementById('signEstimateId').value;
            var name = document.getElementById('signName').value.trim();
            if (!name) {
                alert('Please type your name.');
                return;
            }

            // Check if canvas has been drawn on
            var sigData = sigCanvas.toDataURL('image/png');

            var estimate = appData.estimates.find(function(e) { return e.id === estId; });
            if (estimate) {
                estimate.signature = sigData;
                estimate.signedBy = name;
                estimate.signedDate = new Date().toLocaleDateString();
                estimate.status = 'approved';
                saveData();
                renderDocuments();
                closeModal('signatureModal');
                viewEstimate(estId);
                alert('Estimate approved and signed!');
            }
        }

        // Edit Document (estimates and invoices)
        // Edit photos
        var editDocPhotos = [];
        function handleEditPhotos(event) {
            var files = Array.from(event.target.files);
            var remaining = 5 - editDocPhotos.length;
            if (files.length > remaining) {
                alert('Maximum 5 photos. You can add ' + remaining + ' more.');
                files = files.slice(0, remaining);
            }
            files.forEach(function(file) {
                compressImage(file, 800, 600, 0.5).then(function(dataUrl) {
                    editDocPhotos.push(dataUrl);
                    renderEditPhotosPreview();
                });
            });
            event.target.value = '';
        }
        function removeEditPhoto(idx) {
            editDocPhotos.splice(idx, 1);
            renderEditPhotosPreview();
        }
        function renderEditPhotosPreview() {
            var container = document.getElementById('editPhotosPreview');
            container.innerHTML = editDocPhotos.map(function(p, i) {
                return '<div style="position:relative;display:inline-block;">' +
                    '<img src="' + p + '" alt="Photo" style="height:80px;border-radius:8px;border:2px solid #e5e5e5;">' +
                    '<button type="button" onclick="removeEditPhoto(' + i + ')" style="position:absolute;top:-6px;right:-6px;background:#ef4444;color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:12px;cursor:pointer;line-height:20px;">×</button>' +
                '</div>';
            }).join('');
        }

        function editDocument(id, type) {
            var doc;
            if (type === 'estimate') {
                doc = appData.estimates.find(function(e) { return e.id === id; });
            } else {
                doc = appData.invoices.find(function(i) { return i.id === id; });
            }
            if (!doc) return;

            document.getElementById('editDocId').value = doc.id;
            document.getElementById('editDocType').value = type;
            document.getElementById('editModalTitle').textContent = 'Edit ' + (type === 'estimate' ? 'Estimate' : 'Invoice') + ' #' + doc.id.slice(-6);
            document.getElementById('editDocCustomer').value = doc.customerName;
            document.getElementById('editDocDate').value = doc.date;
            document.getElementById('editDocNotes').value = doc.notes || '';
            document.getElementById('editDocTerms').value = doc.terms || '';

            // Load existing photos
            editDocPhotos = doc.photos ? doc.photos.slice() : [];
            renderEditPhotosPreview();

            // Build line items
            var container = document.getElementById('editLines');
            container.innerHTML = '';
            doc.lineItems.forEach(function(item) {
                addEditLine(item);
            });

            recalcEditTotal();
            openModal('docEditModal');
        }

        function addEditLine(item) {
            var container = document.getElementById('editLines');
            var row = document.createElement('div');
            row.className = 'p-3 rounded-lg space-y-2';
            row.style.background = 'rgba(255,107,53,0.05)';
            row.style.border = '1px solid rgba(255,107,53,0.15)';

            var descVal = item ? item.description.replace(/"/g, '&quot;') : '';
            var qtyVal = item ? item.quantity : '';
            var rateVal = item ? item.rate : '';
            var markupVal = item ? (item.markup || 0) : '0';

            row.innerHTML = '' +
                '<div class="flex justify-between items-center mb-2">' +
                    '<span class="text-xs text-gray-700 font-semibold">LINE ITEM</span>' +
                    '<button type="button" class="text-red-600 hover:text-red-300 text-sm font-bold" onclick="removeEditLine(this)" title="Remove line">✕ Remove</button>' +
                '</div>' +
                '<div>' +
                    '<input type="text" class="edit-desc" placeholder="Description" value="' + descVal + '">' +
                '</div>' +
                '<div class="grid grid-cols-3 gap-2">' +
                    '<div>' +
                        '<label class="text-xs text-gray-900">Qty</label>' +
                        '<input type="number" class="edit-qty" placeholder="Qty" step="0.01" value="' + qtyVal + '" oninput="recalcEditTotal()">' +
                    '</div>' +
                    '<div>' +
                        '<label class="text-xs text-gray-900">Rate ($)</label>' +
                        '<input type="number" class="edit-rate" placeholder="Rate" step="0.01" value="' + rateVal + '" oninput="recalcEditTotal()">' +
                    '</div>' +
                    '<div>' +
                        '<label class="text-xs text-gray-900">Markup %</label>' +
                        '<input type="number" class="edit-markup" placeholder="0" step="0.01" value="' + markupVal + '" oninput="recalcEditTotal()">' +
                    '</div>' +
                '</div>' +
                '<div class="text-right">' +
                    '<span class="text-sm text-gray-900">Line total: </span>' +
                    '<span class="edit-line-total font-bold text-orange">$0.00</span>' +
                '</div>';

            container.appendChild(row);
            recalcEditTotal();
        }

        function removeEditLine(btn) {
            var row = btn.closest('.rounded-lg');
            if (document.getElementById('editLines').children.length <= 1) {
                alert('You need at least one line item.');
                return;
            }
            row.remove();
            recalcEditTotal();
        }

        function recalcEditTotal() {
            var total = 0;
            var rows = document.getElementById('editLines').children;
            for (var i = 0; i < rows.length; i++) {
                var qty = parseFloat(rows[i].querySelector('.edit-qty').value) || 0;
                var rate = parseFloat(rows[i].querySelector('.edit-rate').value) || 0;
                var markup = parseFloat(rows[i].querySelector('.edit-markup').value) || 0;
                var lineTotal = qty * rate * (1 + markup / 100);
                rows[i].querySelector('.edit-line-total').textContent = '$' + lineTotal.toFixed(2);
                total += lineTotal;
            }
            document.getElementById('editDocTotal').textContent = '$' + total.toFixed(2);
        }

        function saveDocEdit() {
            var id = document.getElementById('editDocId').value;
            var type = document.getElementById('editDocType').value;

            var doc;
            if (type === 'estimate') {
                doc = appData.estimates.find(function(e) { return e.id === id; });
            } else {
                doc = appData.invoices.find(function(i) { return i.id === id; });
            }
            if (!doc) return;

            doc.date = document.getElementById('editDocDate').value;
            doc.notes = document.getElementById('editDocNotes').value;
            doc.terms = document.getElementById('editDocTerms').value;
            doc.photos = editDocPhotos.slice();

            var newLines = [];
            var total = 0;
            var costTotal = 0;
            var rows = document.getElementById('editLines').children;
            for (var i = 0; i < rows.length; i++) {
                var desc = rows[i].querySelector('.edit-desc').value;
                var qty = parseFloat(rows[i].querySelector('.edit-qty').value) || 0;
                var rate = parseFloat(rows[i].querySelector('.edit-rate').value) || 0;
                var markup = parseFloat(rows[i].querySelector('.edit-markup').value) || 0;
                var amount = (qty * rate * (1 + markup / 100)).toFixed(2);
                var baseCost = qty * rate;

                if (desc || qty || rate) {
                    newLines.push({
                        description: desc,
                        quantity: qty,
                        rate: rate,
                        markup: markup,
                        amount: amount
                    });
                    total += parseFloat(amount);
                    costTotal += baseCost;
                }
            }

            if (newLines.length === 0) {
                alert('Please add at least one line item.');
                return;
            }

            doc.lineItems = newLines;
            doc.total = total.toFixed(2);
            doc.profit = (total - costTotal).toFixed(2);
            doc.margin = costTotal > 0 ? ((total - costTotal) / total * 100).toFixed(1) + '%' : '0%';

            saveData();
            renderDocuments();
            closeModal('docEditModal');
            alert('Changes saved!');
        }

        // Settings
        function populateSettings() {
            document.getElementById('settingsBusinessName').value = appData.settings.businessName || '';
            document.getElementById('settingsEmail').value = appData.settings.email || '';
            document.getElementById('settingsPhone').value = appData.settings.phone || '';
            document.getElementById('settingsAddress').value = appData.settings.address || '';
            document.getElementById('settingsInstagram').value = appData.settings.instagram || '';
            document.getElementById('settingsFacebook').value = appData.settings.facebook || '';
            document.getElementById('settingsTiktok').value = appData.settings.tiktok || '';
            document.getElementById('settingsGoogle').value = appData.settings.google || '';
            document.getElementById('settingsEmailjsPublicKey').value = appData.settings.emailjsPublicKey || '';
            document.getElementById('settingsEmailjsServiceId').value = appData.settings.emailjsServiceId || '';
            document.getElementById('settingsEmailjsTemplateId').value = appData.settings.emailjsTemplateId || '';
            document.getElementById('invoiceReminderEnabled').value = String(appData.settings.invoiceReminderEnabled !== false);
            document.getElementById('reminder1Days').value = appData.settings.reminder1Days || 7;
            document.getElementById('reminder2Days').value = appData.settings.reminder2Days || 7;
            document.getElementById('reminder3Days').value = appData.settings.reminder3Days || 14;
            document.getElementById('jobNotificationHours').value = appData.settings.jobNotificationHours || 24;
            
            if (appData.settings.businessName) {
                document.getElementById('headerBusinessSubtitle').textContent = appData.settings.businessName;
            }
            
            if (appData.settings.logo) {
                displayLogoPreview(appData.settings.logo);
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('logoDropZone').classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('logoDropZone').classList.remove('drag-over');
        }

        function handleLogoDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('logoDropZone').classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                processLogoFile(file);
            }
        }

        function handleLogoFile(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                processLogoFile(file);
            }
        }

        function processLogoFile(file) {
            if (file.size > 2 * 1024 * 1024) {
                alert('File size must be less than 2MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const logoData = e.target.result;
                appData.settings.logo = logoData;
                displayLogoPreview(logoData);
            };
            reader.readAsDataURL(file);
        }

        function displayLogoPreview(logoData) {
            const preview = document.getElementById('logoPreview');
            preview.innerHTML = 
                '<img src="' + logoData + '" alt="Logo Preview" class="max-h-32 mx-auto rounded border border-gray-200">' +
                '<button type="button" onclick="removeLogo()" class="btn-danger text-sm mt-2">Remove Logo</button>';
        }

        function removeLogo() {
            appData.settings.logo = '';
            document.getElementById('logoPreview').innerHTML = '';
        }

        function saveSettings() {
            appData.settings = {
                businessName: document.getElementById('settingsBusinessName').value,
                email: document.getElementById('settingsEmail').value,
                phone: document.getElementById('settingsPhone').value,
                address: document.getElementById('settingsAddress').value,
                logo: appData.settings.logo || '',
                instagram: document.getElementById('settingsInstagram').value,
                facebook: document.getElementById('settingsFacebook').value,
                tiktok: document.getElementById('settingsTiktok').value,
                google: document.getElementById('settingsGoogle').value,
                emailjsPublicKey: document.getElementById('settingsEmailjsPublicKey').value,
                emailjsServiceId: document.getElementById('settingsEmailjsServiceId').value,
                emailjsTemplateId: document.getElementById('settingsEmailjsTemplateId').value,
                invoiceReminderEnabled: document.getElementById('invoiceReminderEnabled').value === 'true',
                reminder1Days: parseInt(document.getElementById('reminder1Days').value) || 7,
                reminder2Days: parseInt(document.getElementById('reminder2Days').value) || 7,
                reminder3Days: parseInt(document.getElementById('reminder3Days').value) || 14,
                jobNotificationHours: parseInt(document.getElementById('jobNotificationHours').value) || 24
            };
            
            saveData();
            document.getElementById('headerBusinessSubtitle').textContent = appData.settings.businessName || 'Business Management System';
            alert('Settings saved!');
        }

        // Dashboard
        function updateDashboard() {
            document.getElementById('dashCustomers').textContent = appData.customers.length;
            document.getElementById('dashEstimates').textContent = appData.estimates.filter(function(e) { return e.status === 'pending' || e.status === 'sent' || e.status === 'viewed'; }).length;
            
            const unpaid = appData.invoices.filter(function(i) { return i.status === 'unpaid'; }).reduce(function(sum, i) { return sum + parseFloat(i.total); }, 0);
            const paid = appData.invoices.filter(function(i) { return i.status === 'paid'; }).reduce(function(sum, i) { return sum + parseFloat(i.total); }, 0);
            
            document.getElementById('dashUnpaid').textContent = '$' + unpaid.toFixed(2);
            document.getElementById('dashRevenue').textContent = '$' + paid.toFixed(2);
            
            const teamCost = appData.teamMembers.reduce(function(sum, m) {
                const memberCost = (parseFloat(m.hourlyRate) || 0) * (parseFloat(m.hoursPerMonth) || 0);
                return sum + memberCost;
            }, 0);
            const expenses = appData.expenses.reduce(function(sum, e) { return sum + parseFloat(e.amount || 0); }, 0);
            const profit = appData.calculator.desiredProfit || 0;
            const revenue = teamCost + expenses + profit;
            
            document.getElementById('dashRevenueTarget').textContent = '$' + revenue.toFixed(2);
            document.getElementById('dashExpenses').textContent = '$' + expenses.toFixed(2);
            document.getElementById('dashTeamCosts').textContent = '$' + teamCost.toFixed(2);
            document.getElementById('dashProfit').textContent = '$' + profit.toFixed(2);
            
            const allDocs = appData.estimates.concat(appData.invoices).sort(function(a, b) { return b.id - a.id; }).slice(0, 5);
            const activityHTML = allDocs.map(function(doc) {
                return '<div class="flex justify-between items-center py-2 border-b border-gray-100">' +
                    '<div>' +
                        '<p class="font-medium">' + (doc.type === 'estimate' ? 'Estimate' : 'Invoice') + ' - ' + doc.customerName + '</p>' +
                        '<p class="text-xs text-gray-900">' + doc.date + '</p>' +
                    '</div>' +
                    '<span class="status-badge status-' + doc.status + '">' + doc.status + '</span>' +
                '</div>';
            }).join('');
            
            document.getElementById('recentActivity').innerHTML = activityHTML || '<p class="text-gray-700 text-sm">No recent activity</p>';
            
            updateNotificationBadge();
        }
    </script>
</body>
</html>
